<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Zabbix容器化部署</title>
    <link href="/2024/07/03/Zabbix%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    <url>/2024/07/03/Zabbix%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="Zabbix容器化部署"><a href="#Zabbix容器化部署" class="headerlink" title="Zabbix容器化部署"></a>Zabbix容器化部署</h2><p>Zabbix 是一个开源的企业级监控解决方案，可以实时监控服务器、网络设备和其他 IT 资源的状态。</p><h3 id="1-Zabbix-关键功能"><a href="#1-Zabbix-关键功能" class="headerlink" title="1.Zabbix 关键功能"></a>1.Zabbix 关键功能</h3><ol><li><strong>监控：</strong><ul><li>服务器和虚拟机（Linux&#x2F;Windows&#x2F;Unix）。</li><li>网络设备（路由器、交换机、防火墙等）。</li><li>应用程序和服务（Web服务器、数据库服务器等）。</li><li>云服务（AWS、Azure等）。</li></ul></li><li><strong>数据采集：</strong><ul><li>支持多种监控方法：SNMP、IPMI、JMX、Zabbix Agent 等。</li><li>自动发现网络设备和拓扑结构。</li><li>主动和被动数据收集。</li></ul></li><li><strong>报警和通知：</strong><ul><li>自定义触发条件和报警规则。</li><li>多种通知方式：邮件、短信、即时消息、脚本等。</li><li>报警升级和恢复通知。</li></ul></li><li><strong>数据存储：</strong><ul><li>历史数据存储和管理。</li><li>数据库支持：MySQL、PostgreSQL、Oracle、SQLite 等。</li></ul></li><li><strong>可视化：</strong><ul><li>图表、仪表盘、地图等多种可视化方式。</li><li>实时和历史数据的图形展示。</li><li>自定义报表和 SLA 报告。</li></ul></li></ol><h3 id="2-Zabbix-组件"><a href="#2-Zabbix-组件" class="headerlink" title="2.Zabbix 组件"></a>2.Zabbix 组件</h3><ol><li><strong>Zabbix Server：</strong><ul><li>核心组件，负责接收和处理从代理和监控项收集的数据。</li><li>管理配置、用户和报警规则。</li></ul></li><li><strong>Zabbix Agent：</strong><ul><li>安装在被监控主机上，负责收集本地的监控数据并发送给 Zabbix Server。</li><li>支持主动和被动模式。</li></ul></li><li><strong>数据库：</strong><ul><li>存储所有配置数据、历史数据和事件数据。</li></ul></li><li><strong>Web 接口：</strong><ul><li>提供图形化的管理界面，用于配置、管理和查看监控数据。</li><li>用户可以通过 Web 界面创建仪表盘、图表和报警规则。</li></ul></li><li><strong>Zabbix Proxy：</strong><ul><li>用于分布式监控场景，帮助在大规模或地理分布式网络中收集数据。</li><li>将数据汇总并发送到 Zabbix Server。</li></ul></li></ol><h3 id="3-Zabbix-工作原理"><a href="#3-Zabbix-工作原理" class="headerlink" title="3.Zabbix 工作原理"></a>3.Zabbix 工作原理</h3><ol><li><strong>数据收集：</strong><ul><li>Zabbix Agent 或其他监控方法（如 SNMP）从被监控主机和设备收集数据。</li><li>代理将收集的数据发送到 Zabbix Server。</li></ul></li><li><strong>数据处理：</strong><ul><li>Zabbix Server 接收数据并根据预定义的触发器进行分析。</li><li>如果数据满足触发器条件，生成报警并通知相关人员。</li></ul></li><li><strong>数据存储：</strong><ul><li>处理后的数据存储在数据库中，用于历史记录和趋势分析。</li></ul></li><li><strong>报警和通知：</strong><ul><li>根据触发条件和报警规则，发送通知给管理员或其他相关人员。</li><li>支持多种通知方式和报警升级机制。</li></ul></li><li><strong>数据展示：</strong><ul><li>用户通过 Web 接口查看实时和历史数据。</li><li>创建图表、仪表盘和报表，以便直观了解系统状态。</li></ul></li></ol><h3 id="4-使用-Docker-Compose-部署-Zabbix"><a href="#4-使用-Docker-Compose-部署-Zabbix" class="headerlink" title="4.使用 Docker Compose 部署 Zabbix"></a>4.使用 Docker Compose 部署 Zabbix</h3><p><a href="https://zzz.curtain-z.cn/repo/zbx_env.zip">下载zabbix-server(zbx_env)配置</a></p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zabbix-mysql</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root_password</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--character-set-server=utf8mb4</span> <span class="hljs-string">--collation-server=utf8mb4_unicode_ci</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./mysql_data:/var/lib/mysql</span><br><br>  <span class="hljs-attr">zabbix-server:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">zabbix/zabbix-server-mysql:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zabbix-server</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">DB_SERVER_HOST:</span> <span class="hljs-string">mysql</span> <br>      <span class="hljs-comment">#先将该mysql地址设为空，拷贝zabbix-server容器内/usr/share/doc/zabbix-server-mysql/create.sql.gz文件至宿主机,使用gunzip create.sql.gz解压后，导入至mysql数据库内 mysql -uzabbix -p zabbix &lt; create.sql</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">zabbix</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10051:10051&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/zbx_env:/etc/zabbix</span><br><br>  <span class="hljs-attr">zabbix-web:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">zabbix/zabbix-web-nginx-mysql:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zabbix-web</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">zabbix-server</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">ZBX_SERVER_HOST:</span> <span class="hljs-string">zabbix-server</span><br>      <span class="hljs-attr">DB_SERVER_HOST:</span> <span class="hljs-string">mysql</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">zabbix</span><br>      <span class="hljs-attr">PHP_TZ:</span> <span class="hljs-string">Europe/Riga</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/zbx_env:/etc/zabbix</span><br></code></pre></div></td></tr></table></figure><h3 id="5-使用-Docker-Compose-部署-Zabbix-agent"><a href="#5-使用-Docker-Compose-部署-Zabbix-agent" class="headerlink" title="5.使用 Docker Compose 部署 Zabbix-agent"></a>5.使用 Docker Compose 部署 Zabbix-agent</h3><p>创建<strong>zabbix_agentd.d</strong>文件夹，配置<strong>zabbix_agentd.conf</strong>内容如下</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">LogType=console<br>Server=[zabbix-server-IP]<br>ServerActive=[zabbix-server-IP]<br>Hostname=[填写在主机列表中的名称]<br>User=zabbix<br>Include=/etc/zabbix/zabbix_agentd.d/<br>LoadModulePath=/var/lib/zabbix/modules/<br></code></pre></div></td></tr></table></figure><p>Zabbix-agent</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">zabbix-agent:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">zabbix/zabbix-agent:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zabbix-agent</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10050:10050&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./zbx_env:/etc/zabbix</span><br></code></pre></div></td></tr></table></figure><h3 id="6-在zabbix控制台新增主机，名称为-Hostname-配置名称"><a href="#6-在zabbix控制台新增主机，名称为-Hostname-配置名称" class="headerlink" title="6.在zabbix控制台新增主机，名称为[Hostname]配置名称"></a>6.在zabbix控制台新增主机，名称为[Hostname]配置名称</h3>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker部署nginx+jupyter</title>
    <link href="/2024/03/07/docker%E9%83%A8%E7%BD%B2nginx-jupyter/"/>
    <url>/2024/03/07/docker%E9%83%A8%E7%BD%B2nginx-jupyter/</url>
    
    <content type="html"><![CDATA[<h3 id="docker部署nginx-jupyter"><a href="#docker部署nginx-jupyter" class="headerlink" title="docker部署nginx+jupyter"></a>docker部署nginx+jupyter</h3><p>Jupyter 是一个开源的交互式计算环境，它可以让用户创建和共享包含代码、可视化和说明文本的文档，通常被称为笔记本。Jupyter 的名称来源于三种核心编程语言：Julia、Python 和 R，这三种语言是 Jupyter 最初支持的。现在，Jupyter 也支持其他编程语言和工具。</p><p>Jupyter 的核心组件包括：</p><ul><li><p>Jupyter Notebook: 这是 Jupyter 最为人熟知的部分，它是一个基于 Web 的应用程序，允许用户创建和共享包含实时代码、可视化和文本说明的笔记本文档。用户可以在笔记本中运行代码块，并查看代码执行结果、图表、文本输出等。</p></li><li><p>Jupyter Kernel: 内核是 Jupyter 与不同编程语言进行交互的后端程序。Jupyter 支持多种编程语言的内核，包括 Python、R、Julia、Java 等，这使得用户可以在同一个 Jupyter 环境中使用不同的编程语言进行交互式计算。</p></li><li><p>JupyterLab: JupyterLab 是一个扩展了 Jupyter Notebook 的下一代 Web 用户界面，提供了更强大的交互式开发环境，支持文件浏览、交互式窗口、文本编辑器、终端等功能。</p></li></ul><p>Jupyter 被广泛应用于数据分析、机器学习、科学计算、教育等领域，它的交互式特性使得用户可以方便地探索数据、编写实验性代码、展示研究成果等。通过 Jupyter Notebook 的分享功能，用户可以将自己的工作以交互式的方式分享给他人，这对于教学和合作研究非常有用。</p><h4 id="1-安装docker"><a href="#1-安装docker" class="headerlink" title="1.安装docker"></a>1.安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install yum-utils device-mapper-persistent-data lvm2 gcc<br>yum-config-manager--add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum makecache fast<br>yum -y install docker-ce<br>mkdir -p /etc/docker<br>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://hxqazmaw.mirror.aliyuncs.com&quot;]<br>&#125;<br>EOF<br>systemctl daemon-reload<br>systemctl start docker<br>systemctl enable docker<br>systemctl status docker<br></code></pre></div></td></tr></table></figure><h4 id="2-拉取nginx、jupyter镜像"><a href="#2-拉取nginx、jupyter镜像" class="headerlink" title="2.拉取nginx、jupyter镜像"></a>2.拉取nginx、jupyter镜像</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker pull nginx:latest<br>docker pull jupyter/scipy-notebook:latest<br></code></pre></div></td></tr></table></figure><h4 id="3-创建相关目录"><a href="#3-创建相关目录" class="headerlink" title="3.创建相关目录"></a>3.创建相关目录</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">mkdir -p /opt/nginx/www<br>mkdir -p /opt/nginx/conf/conf.d<br>mkdir -p /opt/nginx/ssl<br>mkdir -p /opt/notebook<br>chmod 777 /opt/notebook<br></code></pre></div></td></tr></table></figure><h4 id="4-创建nginx反向代理配置"><a href="#4-创建nginx反向代理配置" class="headerlink" title="4.创建nginx反向代理配置"></a>4.创建nginx反向代理配置</h4><p>！！！需配置websocket，否则内核无法连接！！！</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/nginx/conf/conf.d/default.conf &lt;&lt;EOF<br>server &#123;<br> listen 443 ssl;<br> server_name zzz.curtain-z.cn;<br> ssl_certificate  /etc/nginx/ssl/zzz.curtain-z.cn_bundle.crt;<br> ssl_certificate_key /etc/nginx/ssl/zzz.curtain-z.cn.key;<br> ssl_session_timeout 5m;<br> ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;<br> ssl_protocols TLSv1.2 TLSv1.3;<br> ssl_prefer_server_ciphers on;<br> location ^~ / &#123;<br>    #jupyter镜像默认端口为8888<br>     proxy_pass http://notebook:8888;<br>     #websocket额外配置开始<br>     proxy_http_version 1.1;<br>     proxy_set_header Upgrade $http_upgrade;<br>     proxy_set_header Connection &quot;upgrade&quot;;<br>     # 连接超时时间，不能设置太长会浪费连接资源<br>     proxy_connect_timeout 60s;<br>     # 读超时时间<br>     proxy_read_timeout 500s;<br>     # 写超时时间<br>     proxy_send_timeout 500s;<br>     #websocket额外配置结束<br>     proxy_set_header Host $host;<br>     proxy_set_header X-Real-IP $remote_addr;<br>     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>     proxy_set_header REMOTE-HOST $remote_addr;<br>     proxy_set_header X-Forwarded-Proto  $scheme;<br> &#125;<br>&#125;<br>server &#123;<br>  listen 80;<br>  server_name zzz.curtain-z.cn;<br>  return 301 https://$host$request_uri;<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><h4 id="5-启动nginx、jupyter容器"><a href="#5-启动nginx、jupyter容器" class="headerlink" title="5.启动nginx、jupyter容器"></a>5.启动nginx、jupyter容器</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker run -itd --name notebook --restart=always -v /opt/notebook:/home/jovyan jupyter/scipy-notebook:latest<br>docker run --name nginx -p 80:80 -p443:443 -d -v /opt/nginx/www:/usr/share/nginx/html -v /opt/nginx/conf/conf.d:/etc/nginx/conf.d  -v /opt/nginx/ssl:/etc/nginx/ssl --restart always  --link notebook:notebook nginx <br></code></pre></div></td></tr></table></figure><h4 id="6-通过域名访问jupyter"><a href="#6-通过域名访问jupyter" class="headerlink" title="6.通过域名访问jupyter"></a>6.通过域名访问jupyter</h4><h4 id="7-查看Token"><a href="#7-查看Token" class="headerlink" title="7.查看Token"></a><img src="https://s3.bmp.ovh/imgs/2024/03/07/642250cf527058b8.jpg">7.查看Token</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker exec -it notebook jupyter notebook list<br></code></pre></div></td></tr></table></figure><h4 id="8-添加中文选项"><a href="#8-添加中文选项" class="headerlink" title="8.添加中文选项"></a>8.添加中文选项</h4><ul><li>Jupyter Notebook默认是英文的</li></ul><p><img src="https://s3.bmp.ovh/imgs/2024/03/07/3f3a6acabf223f5a.jpg"></p><ul><li>下载中文包</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker exec -it notebook pip install jupyterlab-language-pack-zh-CN<br></code></pre></div></td></tr></table></figure><ul><li>下载完成后刷新网页后选择中文</li></ul><p><img src="https://s3.bmp.ovh/imgs/2024/03/07/515079cad674b590.jpg"></p><h4 id="9-设置文件自动保存间隔时间"><a href="#9-设置文件自动保存间隔时间" class="headerlink" title="9.设置文件自动保存间隔时间"></a>9.设置文件自动保存间隔时间</h4><ul><li>默认为120秒</li></ul><p><img src="https://s3.bmp.ovh/imgs/2024/03/07/1e7c557a4eb3d6cc.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker部署nginx+jupyter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis数据过滤迁移-python</title>
    <link href="/2024/01/16/redis%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4%E8%BF%81%E7%A7%BB/"/>
    <url>/2024/01/16/redis%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4%E8%BF%81%E7%A7%BB/</url>
    
    <content type="html"><![CDATA[<h3 id="redis数据过滤迁移-python"><a href="#redis数据过滤迁移-python" class="headerlink" title="redis数据过滤迁移-python"></a>redis数据过滤迁移-python</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> redis<br><br><span class="hljs-comment"># 连接 Redis</span><br>r = redis.Redis(host=<span class="hljs-string">&#x27;xxxxx&#x27;</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>,password=<span class="hljs-string">&quot;2024%&quot;</span>)<br>r2 = redis.Redis(host=<span class="hljs-string">&#x27;xxxxx&#x27;</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>,password=<span class="hljs-string">&quot;2024%&quot;</span>)<br><br><span class="hljs-comment"># 获取的键名列表</span><br><span class="hljs-comment"># keys = [b&#x27;aaa:asdasd&quot;, b&#x27;ccc:asdasd&#x27;, b&#x27;aaa: sadsad &#x27;] keys = r. keys(&quot;*&quot;）</span><br>keys = r.keys(<span class="hljs-string">&#x27;*&#x27;</span>)<br><br><br><span class="hljs-comment"># 过滤出以&quot;key&quot;开头的哈希表键</span><br>filtered_keys = [key <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys <span class="hljs-keyword">if</span> key.startswith(<span class="hljs-string">b&#x27;key&#x27;</span>)]<br>redis_keys = [<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;key. decode()&#125;</span>&#x27;</span> <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> filtered_keys]<br><br><br><span class="hljs-keyword">for</span> keys <span class="hljs-keyword">in</span> redis_keys:<br>    <span class="hljs-comment"># 获取值的类型</span><br>    value_type = r.<span class="hljs-built_in">type</span>(keys)<br>    <span class="hljs-keyword">if</span> value_type == <span class="hljs-string">b&#x27;string&#x27;</span>:<br>        <span class="hljs-comment"># key处理方法</span><br>        value = r.get(keys)<br>        r2.<span class="hljs-built_in">set</span>(keys, value)<br><br>    <span class="hljs-keyword">elif</span> value_type == <span class="hljs-string">b&#x27;list&#x27;</span>:<br>        <span class="hljs-comment"># list处理方法        </span><br>        elements = r.lrange(keys, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<br>        r2.rpush(keys, *elements)<br><br>    <span class="hljs-keyword">elif</span> value_type == <span class="hljs-string">b&#x27;hash&#x27;</span>:<br>        <span class="hljs-comment"># hash处理方法</span><br>        all_fields_values = r.hgetall(keys)<br>        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> all_fields_values.items():<br>            r2.hset(keys, key, value)<br><br>    <span class="hljs-keyword">elif</span> value_type == <span class="hljs-string">b&#x27;set&#x27;</span>:<br>        <span class="hljs-comment"># set处理方法</span><br>        members = r.smembers(keys)<br>        <span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> members:<br>            r2.sadd(keys, member)<br>    <br>    <span class="hljs-keyword">elif</span> value_type == <span class="hljs-string">b&#x27;zset&#x27;</span>:<br>        <span class="hljs-comment"># zset处理方法</span><br>        items = r.zrange(keys, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, withscores=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">for</span> member, score <span class="hljs-keyword">in</span> items:<br>            r2.zadd(keys, &#123;member: score&#125;)<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;keys.decode()&#125;</span>: Unknown type&quot;</span>)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Migration</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis数据过滤迁移-python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rump数据迁移方式</title>
    <link href="/2024/01/15/rump%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%96%B9%E5%BC%8F/"/>
    <url>/2024/01/15/rump%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h3 id="rump数据迁移方式"><a href="#rump数据迁移方式" class="headerlink" title="rump数据迁移方式"></a>rump数据迁移方式</h3><h4 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h4><ul><li>部分云厂商的Redis实例禁止客户端发起SLAVEOF、BGSAVE、PSYNC等命令，无法使用redis-cli、或redis-shake等工具快速导出数据。</li><li>使用KEYS命令容易造成服务端阻塞。</li><li>云厂商一般只提供备份文件下载，这种方式仅适宜离线迁移，且迁移过程对业务中断时间较长。</li></ul><p><a href="https://github.com/stickermule/rump">Rump</a>是一款开源的Redis数据在线迁移工具，支持在同一个实例的不同数据库之间互相迁移，以及不同实例的数据库之间迁移。</p><h4 id="1-下载Rump的release版本。"><a href="#1-下载Rump的release版本。" class="headerlink" title="1.下载Rump的release版本。"></a>1.下载Rump的<a href="https://github.com/stickermule/rump/releases">release版本</a>。</h4><p>以64位Linux操作系统为例，执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://github.com/stickermule/rump/releases/download/0.0.3/rump-0.0.3-linux-amd64<br></code></pre></div></td></tr></table></figure><h4 id="2-修改名称-添加可执行权限"><a href="#2-修改名称-添加可执行权限" class="headerlink" title="2.修改名称,添加可执行权限"></a>2.修改名称,添加可执行权限</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">mv rump-0.0.3-linux-amd64 rump<br>chmod +x rump<br></code></pre></div></td></tr></table></figure><h4 id="3-数据迁移"><a href="#3-数据迁移" class="headerlink" title="3.数据迁移"></a>3.数据迁移</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>from_host=&quot;xxx&quot;<br>from_port=&quot;6379&quot;<br>from_password=&quot;2024%25&quot;<br><br>to_host=&quot;xxx&quot;<br>to_port=&quot;6379&quot;<br>to_password=&quot;2024&quot;<br><br>for i in &#123;0..15&#125;; do<br>    echo &quot;Migrating database $i from $from_host:$from_port to $to_host:$to_port ...&quot;<br>    ./rump -from &quot;redis://:&quot;$&#123;from_password&#125;&quot;@$&#123;from_host&#125;:$&#123;from_port&#125;/$&#123;i&#125;&quot; -to &quot;redis://:&quot;$&#123;to_password&#125;&quot;@$&#123;to_host&#125;:$&#123;to_port&#125;/$&#123;i&#125;&quot;<br>done<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">rump -from &#123;source_redis_address&#125; -to &#123;target_redis_address&#125;<br><br>参数/选项说明：<br><br>&#123;source_redis_address&#125;<br>源Redis实例地址，格式为：redis://[user:password@]host:port/db，中括号部分为可选项，实例设置了密码访问时需要填写密码，格式遵循RFC 3986规范。注意用户名可为空，但冒号不能省略，例如redis://:mypassword@192.168.0.45:6379/1。<br><br>db为数据库编号，不传则默认为0。<br><br>&#123;target_redis_address&#125;<br>目标Redis实例地址，格式与from相同。<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Migration</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rump数据迁移方式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>s3fs挂载对象存储到本地</title>
    <link href="/2024/01/15/S3fs%E6%8C%82%E8%BD%BD%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%88%B0%E6%9C%AC%E5%9C%B0/"/>
    <url>/2024/01/15/S3fs%E6%8C%82%E8%BD%BD%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%88%B0%E6%9C%AC%E5%9C%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="s3fs挂载对象存储到本地"><a href="#s3fs挂载对象存储到本地" class="headerlink" title="s3fs挂载对象存储到本地"></a>s3fs挂载对象存储到本地</h2><h3 id="一、S3FS介绍："><a href="#一、S3FS介绍：" class="headerlink" title="一、S3FS介绍："></a>一、S3FS介绍：</h3><p>S3FS是Google开发的一款支持将对象存储中的bucket以文件形式导出的文件系统接口，兼容POSIX语法</p><p>S3FS基于FUSE开发的文件系统，允许Linux和Mac OS 挂载S3的存储桶到本地文件系统，并保持对象原来格式。</p><p>只要支持S3存储协议的都支持挂载，比如minio、华为云OBS、阿里云OSS等</p><h3 id="二、安装-s3fs"><a href="#二、安装-s3fs" class="headerlink" title="二、安装 s3fs"></a>二、安装 s3fs</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">centos 安装</span><br>yum -y install s3fs-fuse<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">ubantu 安装</span><br>apt install s3fs<br></code></pre></div></td></tr></table></figure><h3 id="三、挂载使用"><a href="#三、挂载使用" class="headerlink" title="三、挂载使用"></a>三、挂载使用</h3><h3 id="S3FS参数说明"><a href="#S3FS参数说明" class="headerlink" title="S3FS参数说明"></a>S3FS参数说明</h3><p><strong>命令： s3fs BUCKET:[&#x2F;PATH] MOUNTPOINT [OPTION]…</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">OPTIONS:<br><br>passwd_file: 指定要使用的s3fs密码文件<br>url: 设置用于访问对象存储的 url<br>endpoint: 存储端点，默认值为us-east-1<br>umask: 为装载目录设置umask<br>no_check_certificate: 不检查认证<br>use_path_request_style: 使用路径请求样式(使用传统API调用)，兼容支持与不支持S3的类似api的虚拟主机请求<br>nonempty: 允许挂载点为非空目录<br>default_acl: 默认private，取值有private，public-read<br>ensure_diskfree: 设置磁盘可用空间。如果磁盘空闲空间小于此值，s3fs不适用磁盘空间<br>allow_other: 允许所有用户访问挂载点目录，可将该挂载点用于创建NFS共享<br>use_cache: 指定本地文件夹用作本地文件缓存。默认为空<br>del_cache: 在S3FS启动和退出时删除本地缓存<br>enable_noobj_cache: 减少s3fs发送的列举桶的请求，从而提升性能<br>dbglevel: 设置消息级别，默认关键（critical）, 可以使用 info 进行调试输出<br>multireq_max: 列出对象的并行请求的最大数据<br>parallel_count: 上传大对象的并行请求数<br>retries: 默认值为5，传输失败重试次数<br>storage_class: 存储类（默认为标准) ，值有 standard，standard_ia , onezone_ia , reduced_redundancy<br>connect_timeout: 连接超时时间，默认为300秒<br>readwrite_timeout: 读写超时，默认值为60秒<br>max_stat_cache_size: 最大静态缓存大小，默认值为100000个条目(约40MB)<br>stat_cache_expire: 为stat缓存中条目指定过期时间(秒)。此过期时间表示自stat缓存后时间<br>-f : 前台输出执行信息<br>-d: 将dubug消息输出到 syslog中<br></code></pre></div></td></tr></table></figure><h3 id="四、创建访问密钥文件"><a href="#四、创建访问密钥文件" class="headerlink" title="四、创建访问密钥文件"></a>四、创建访问密钥文件</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将aksk或账号密码写入文件中</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">命令格式：<span class="hljs-built_in">echo</span> [IAM用户访问密钥ID]:[ IAM用户访问密钥] &gt;[密钥文件名]</span><br>echo &quot;username:password&quot; &gt; /data/s3fs/.passwd-s3fs <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置密钥智能被当前用户访问</span><br>chmod 600 /data/s3fs/.passwd-s3fs<br></code></pre></div></td></tr></table></figure><h3 id="五、挂载-华为云OBS"><a href="#五、挂载-华为云OBS" class="headerlink" title="五、挂载 华为云OBS"></a>五、挂载 华为云OBS</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">命令格式：s3fs [S3存储桶名] [本地目录名] -o passwd_file=[密钥文件名] -o endpoint=[区域名]</span><br>s3fs prodfile-bucket /data/s3fs/s3mnt -o passwd_file=/data/s3fs/.passwd-s3fs -o url=http://obs.cn-north-4.myhuaweicloud.com <br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Migration</category>
      
    </categories>
    
    
    <tags>
      
      <tag>s3fs挂载对象存储到本地</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>二进制部署kubernetes集群</title>
    <link href="/2024/01/15/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/"/>
    <url>/2024/01/15/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="二进制部署kubernetes集群"><a href="#二进制部署kubernetes集群" class="headerlink" title="二进制部署kubernetes集群"></a>二进制部署kubernetes集群</h2><p>k8s 集群控制节点，对集群进行调度管理，接受集群外用户去集群操作请求</p><p>master节点上的主要组件包括：</p><p>1、kube-apiserver：集群控制的入口，提供 HTTP REST 服务，同时交给etcd存储，提供认证、授权、访问控制、API注册和发现等机制</p><p>2、kube-controller-manager：Kubernetes 集群中所有资源对象的自动化控制中心，理集群中常规后台任务，一个资源对应一个控制器</p><p>3、kube-scheduler：负责 Pod 的调度，选择node节点应用部署</p><p>4、etcd数据库（也可以安装在单独的服务器上）：存储系统，用于保存集群中的相关数据</p><p>node节点上的主要组件包括：<br>1、kubelet：master派到node节点代表，管理本机容器</p><p>一个集群中每个节点上运行的代理，它保证容器都运行在Pod中<br>负责维护容器的生命周期，同时也负责Volume(CSI) 和 网络(CNI)的管理<br>2、kube-proxy：提供网络代理，负载均衡等操作</p><p>3、容器运行环境（Container runtime）如docker</p><p>容器运行环境是负责运行容器的软件<br>Kubernetes支持多个容器运行环境：Docker、containerd、cri-o、rktlet以及任何实现Kubernetes CRI (容器运行环境接口) 的软件。</p><h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件</p><ul><li>一台或多台机器，操作系统CentOS 7.x</li><li>硬件配置：2GB ，2个CPU，硬盘30GB</li><li>集群中所有机器之间网络互通</li><li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像导入节点</li><li>禁止swap分区</li></ul><h3 id="2-准备虚拟机"><a href="#2-准备虚拟机" class="headerlink" title="2.准备虚拟机"></a>2.准备虚拟机</h3><p>首先我们准备了三台虚拟机，来进行安装测试</p><table><thead><tr><th>主机名</th><th>IP</th><th>组件</th></tr></thead><tbody><tr><td>master1</td><td>172.16.1.125</td><td>kube-apiserver，kube-controller-manager，kube -scheduler，etcd</td></tr><tr><td>node1</td><td>172.16.1.216</td><td>kubelet，kube-proxy，docker，flannel，etcd</td></tr><tr><td>node2</td><td>172.16.1.242</td><td>kubelet，kube-proxy，docker，flannel，etcd</td></tr></tbody></table><h3 id="3-基础环境"><a href="#3-基础环境" class="headerlink" title="3.基础环境"></a>3.基础环境</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">各个机器设置自己的域名</span><br>hostnamectl set-hostname master1<br>hostnamectl set-hostname node1<br>hostnamectl set-hostname node2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加hosts</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>172.16.1.125 master1<br>172.16.1.216 node1<br>172.16.1.242 node2<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br>sudo setenforce 0<br>sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭swap</span><br>swapoff -a  <br>sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">允许 iptables 检查桥接流量</span><br>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf<br>br_netfilter<br>EOF<br><br>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>EOF<br>sudo sysctl --system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">时间同步</span><br>yum install ntpdate -y<br>ntpdate time.windows.com<br></code></pre></div></td></tr></table></figure><h3 id="4-部署Etcd集群"><a href="#4-部署Etcd集群" class="headerlink" title="4.部署Etcd集群"></a>4.部署Etcd集群</h3><p>Etcd是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为了解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍一台机器故障，当然也可以使用5台组件集群，可以容忍2台机器故障</p><table><thead><tr><th>节点名称</th><th>IP</th></tr></thead><tbody><tr><td>etcd1</td><td>172.16.1.125</td></tr><tr><td>etcd2</td><td>172.16.1.216</td></tr><tr><td>etcd3</td><td>172.16.1.242</td></tr></tbody></table><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">注：为了节省机器，这里与 K8s 节点机器复用。也可以独立于 k8s 集群之外部署，只要apiserver 能连接到就行<br></code></pre></div></td></tr></table></figure><h4 id="4-1准备cfssl证书生成工具"><a href="#4-1准备cfssl证书生成工具" class="headerlink" title="4.1准备cfssl证书生成工具"></a>4.1准备cfssl证书生成工具</h4><p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl 更方便使用。在Master节点进行操作</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64<br>chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64<br>mv cfssl_linux-amd64 /usr/local/bin/cfssl<br>mv cfssljson_linux-amd64 /usr/local/bin/cfssljson<br>mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo<br></code></pre></div></td></tr></table></figure><h4 id="4-2生成-Etcd证书"><a href="#4-2生成-Etcd证书" class="headerlink" title="4.2生成 Etcd证书"></a>4.2生成 Etcd证书</h4><h5 id="4-2-1自签证书颁发机构（CA）"><a href="#4-2-1自签证书颁发机构（CA）" class="headerlink" title="4.2.1自签证书颁发机构（CA）"></a>4.2.1自签证书颁发机构（CA）</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">mkdir -p ~/TLS/&#123;etcd,k8s&#125;<br>cd TLS/etcd<br></code></pre></div></td></tr></table></figure><h5 id="4-2-2自签CA"><a href="#4-2-2自签CA" class="headerlink" title="4.2.2自签CA"></a>4.2.2自签CA</h5><p>ca-config.json</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;www&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>ca-csr.json</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; ca-csr.json&lt;&lt; EOF <br>&#123;<br>    &quot;CN&quot;: &quot;etcd CA&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;Beijing&quot;,<br>            &quot;ST&quot;: &quot;Beijing&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>生成证书：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 etcd]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br>----------------------------<br>2023/04/07 11:03:33 [INFO] generating a new CA key and certificate from CSR<br>2023/04/07 11:03:33 [INFO] generate received request<br>2023/04/07 11:03:33 [INFO] received CSR<br>2023/04/07 11:03:33 [INFO] generating key: rsa-2048<br>2023/04/07 11:03:34 [INFO] encoded CSR<br>2023/04/07 11:03:34 [INFO] signed certificate with serial number 174425569924111551053156001326556705558407151977<br><br>[root@m1 etcd]# ls<br>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem<br>[root@m1 etcd]# ls *pem<br>ca-key.pem ca.pem<br>[root@m1 etcd]# ls |wc -l<br>5<br></code></pre></div></td></tr></table></figure><h5 id="4-2-3使用自签-CA-签发-Etcd-HTTPS-证书"><a href="#4-2-3使用自签-CA-签发-Etcd-HTTPS-证书" class="headerlink" title="4.2.3使用自签 CA 签发 Etcd HTTPS 证书"></a>4.2.3使用自签 CA 签发 Etcd HTTPS 证书</h5><p>创建证书申请文件：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意替换IP</span><br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;etcd&quot;,<br>  &quot;hosts&quot;: [<br>    &quot;172.16.1.125&quot;,<br>    &quot;172.16.1.216&quot;,<br>    &quot;172.16.1.242&quot;<br>  ],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>生成证书：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 etcd]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server<br>-------------------<br>2023/04/07 11:12:05 [INFO] generate received request<br>2023/04/07 11:12:05 [INFO] received CSR<br>2023/04/07 11:12:05 [INFO] generating key: rsa-2048<br>2023/04/07 11:12:05 [INFO] encoded CSR<br>2023/04/07 11:12:05 [INFO] signed certificate with serial number 164505293888830887708575372666336673001865598333<br>2023/04/07 11:12:05 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes its unsuitable for<br>websites. For more information see the Baseline Requirements for the Issuance and Management<br>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);<br>specifically, section 10.2.3 (&quot;Information Requirements&quot;).<br>[root@m1 etcd]# ls<br>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server.csr  server-csr.json  server-key.pem  server.pem<br>[root@m1 etcd]# ls server*.pem<br>server-key.pem  server.pem<br>[root@m1 etcd]# ls |wc -l<br>9<br></code></pre></div></td></tr></table></figure><h4 id="4-3部署-Etcd集群"><a href="#4-3部署-Etcd集群" class="headerlink" title="4.3部署 Etcd集群"></a>4.3部署 Etcd集群</h4><h5 id="4-3-1创建工作目录并下载二进制包"><a href="#4-3-1创建工作目录并下载二进制包" class="headerlink" title="4.3.1创建工作目录并下载二进制包"></a>4.3.1创建工作目录并下载二进制包</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cd ~<br>wget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz<br>mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p    #bin里面存放的是可执行文件,cfg配置文件,ssl证书<br>tar zxvf etcd-v3.4.9-linux-amd64.tar.gz<br>mv etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/<br></code></pre></div></td></tr></table></figure><h5 id="4-3-2创建-etcd配置文件"><a href="#4-3-2创建-etcd配置文件" class="headerlink" title="4.3.2创建 etcd配置文件"></a>4.3.2创建 etcd配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF<br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span><br>ETCD_NAME=&quot;etcd-1&quot;<br>ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;https://172.16.1.125:2380&quot; <br>ETCD_LISTEN_CLIENT_URLS=&quot;https://172.16.1.125:2379&quot; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://172.16.1.125:2380&quot;<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;https://172.16.1.125:2379&quot;<br>ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://172.16.1.125:2380,etcd-2=https://172.16.1.216:2380,etcd-3=https://172.16.1.242:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot; <br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ETCD_NAME：节点名称，集群中唯一<br>ETCD_DATA_DIR：数据目录<br>ETCD_LISTEN_PEER_URLS：集群通信监听地址<br>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址<br>ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址<br>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址<br><br>ETCD_INITIAL_CLUSTER：集群节点地址<br>ETCD_INITIAL_CLUSTER_TOKEN：集群 Token<br>ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群<br></code></pre></div></td></tr></table></figure><h5 id="4-3-3systemd管理-etcd"><a href="#4-3-3systemd管理-etcd" class="headerlink" title="4.3.3systemd管理 etcd"></a>4.3.3systemd管理 etcd</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>[Service]<br>Type=notify<br>EnvironmentFile=/opt/etcd/cfg/etcd.conf<br>ExecStart=/opt/etcd/bin/etcd \<br>    --cert-file=/opt/etcd/ssl/server.pem \<br>    --key-file=/opt/etcd/ssl/server-key.pem \<br>    --peer-cert-file=/opt/etcd/ssl/server.pem \<br>    --peer-key-file=/opt/etcd/ssl/server-key.pem \<br>    --trusted-ca-file=/opt/etcd/ssl/ca.pem \<br>    --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \<br>    --logger=zap<br>Restart=on-failure<br>LimitNOFILE=65536<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="4-3-4生成的证书拷贝到配置文件中的路径"><a href="#4-3-4生成的证书拷贝到配置文件中的路径" class="headerlink" title="4.3.4生成的证书拷贝到配置文件中的路径"></a>4.3.4生成的证书拷贝到配置文件中的路径</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/<br></code></pre></div></td></tr></table></figure><h5 id="4-3-4拷贝至node1-node2节点"><a href="#4-3-4拷贝至node1-node2节点" class="headerlink" title="4.3.4拷贝至node1,node2节点"></a>4.3.4拷贝至node1,node2节点</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">scp -r /opt/etcd/ root@node1:/opt/<br>scp /usr/lib/systemd/system/etcd.service root@node1:/usr/lib/systemd/system/<br><br>scp -r /opt/etcd/ root@node2:/opt/<br>scp /usr/lib/systemd/system/etcd.service root@node2:/usr/lib/systemd/system/<br></code></pre></div></td></tr></table></figure><h5 id="4-3-5修改-etcd-conf-配置文件中的节点名称和当前服务器-IP"><a href="#4-3-5修改-etcd-conf-配置文件中的节点名称和当前服务器-IP" class="headerlink" title="4.3.5修改 etcd.conf 配置文件中的节点名称和当前服务器 IP"></a>4.3.5修改 etcd.conf 配置文件中的节点名称和当前服务器 IP</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vim /opt/etcd/cfg/etcd.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span><br>ETCD_NAME=&quot;etcd-1&quot; # 修改此处，节点 2 改为 etcd-2，节点 3改为 etcd-3<br>ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;https://172.16.1.125:2380&quot; # 修改此处为当前服务器 IP ETCD_LISTEN_CLIENT_URLS=&quot;https://172.16.1.125:2379&quot; # 修改此处为当前服务器 IP<br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://172.16.1.125:2380&quot; # 修改此处为当前服务器 IP<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;https://172.16.1.125:2379&quot; # 修改此处为当前服务器IP<br>ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://172.16.1.125:2380,etcd-2=htttps://172.16.1.216:2380,etcd-3=https://172.16.1.242:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;<br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br></code></pre></div></td></tr></table></figure><h5 id="4-3-6启动并设置开机启动"><a href="#4-3-6启动并设置开机启动" class="headerlink" title="4.3.6启动并设置开机启动"></a>4.3.6启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload <br>systemctl start etcd <br>systemctl enable etcd<br>systemctl status etcd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看集群状态</span><br>ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://172.16.1.125:2379,https://172.16.1.216:2379,https://172.16.1.242:2379&quot; endpoint health<br>---------------------------<br>https://172.16.1.125:2379 is healthy: successfully committed proposal: took = 7.691741ms<br>https://172.16.1.216:2379 is healthy: successfully committed proposal: took = 7.842355ms<br>https://172.16.1.242:2379 is healthy: successfully committed proposal: took = 8.857985ms<br><br>报错查看日志：/var/log/message 或 journalctl -u etcd<br></code></pre></div></td></tr></table></figure><h3 id="5-docker安装"><a href="#5-docker安装" class="headerlink" title="5.docker安装"></a>5.docker安装</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install yum-utils device-mapper-persistent-data lvm2 gcc<br>yum-config-manager--add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum makecache fast<br>yum -y install docker-ce<br>mkdir -p /etc/docker<br>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://hxqazmaw.mirror.aliyuncs.com&quot;]<br>&#125;<br>EOF<br>systemctl daemon-reload<br>systemctl start docker<br>systemctl enable docker<br>systemctl status docker<br></code></pre></div></td></tr></table></figure><h3 id="6-生成证书-只在master节点"><a href="#6-生成证书-只在master节点" class="headerlink" title="6.生成证书(只在master节点)"></a>6.生成证书(只在master节点)</h3><h4 id="6-1生成-kube-apiserver-证书-用于部署master-mode"><a href="#6-1生成-kube-apiserver-证书-用于部署master-mode" class="headerlink" title="6.1生成 kube-apiserver 证书(用于部署master mode)"></a>6.1生成 kube-apiserver 证书(用于部署master mode)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">切换目录</span><br>cd ~/TLS/k8s<br></code></pre></div></td></tr></table></figure><p>ca-config.json</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;kubernetes&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>ca-csr.json</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; ca-csr.json&lt;&lt; EOF <br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;Beijing&quot;,<br>            &quot;ST&quot;: &quot;Beijing&quot;,<br>            &quot;O&quot;: &quot;k8s&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>生成证书</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 etcd]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br>------------------<br>2023/04/07 14:11:58 [INFO] generating a new CA key and certificate from CSR<br>2023/04/07 14:11:58 [INFO] generate received request<br>2023/04/07 14:11:58 [INFO] received CSR<br>2023/04/07 14:11:58 [INFO] generating key: rsa-2048<br>2023/04/07 14:11:59 [INFO] encoded CSR<br>2023/04/07 14:11:59 [INFO] signed certificate with serial number 675942160448844902744791746300417237621797037302<br><br>[root@m1 k8s]# ls<br>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem<br>[root@m1 k8s]# ls *.pem<br>ca-key.pem  ca.pem<br>[root@m1 k8s]# ls |wc -l<br>5<br></code></pre></div></td></tr></table></figure><h4 id="6-2使用自签-CA-签发-kube-apiserver-HTTPS-证书"><a href="#6-2使用自签-CA-签发-kube-apiserver-HTTPS-证书" class="headerlink" title="6.2使用自签 CA 签发 kube-apiserver HTTPS 证书"></a>6.2使用自签 CA 签发 kube-apiserver HTTPS 证书</h4><p>创建证书申请文件：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cd ~/TLS/k8s<br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;10.0.0.1&quot;,<br>      &quot;127.0.0.1&quot;,<br>      &quot;172.16.1.125&quot;,<br>      &quot;172.16.1.216&quot;,<br>      &quot;172.16.1.242&quot;,<br>      &quot;kubernetes&quot;,<br>      &quot;kubernetes.default&quot;,<br>      &quot;kubernetes.default.svc&quot;,<br>      &quot;kubernetes.default.svc.cluster&quot;,<br>      &quot;kubernetes.default.svc.cluster.local&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;BeiJing&quot;,<br>            &quot;ST&quot;: &quot;BeiJing&quot;,<br>            &quot;O&quot;: &quot;k8s&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>生成证书：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 etcd]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server<br>---------------<br>2023/04/07 14:17:52 [INFO] generate received request<br>2023/04/07 14:17:52 [INFO] received CSR<br>2023/04/07 14:17:52 [INFO] generating key: rsa-2048<br>2023/04/07 14:17:52 [INFO] encoded CSR<br>2023/04/07 14:17:52 [INFO] signed certificate with serial number 353411361046011027387548691075233577582166249129<br>2023/04/07 14:17:52 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for<br>websites. For more information see the Baseline Requirements for the Issuance and Management<br>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);<br>specifically, section 10.2.3 (&quot;Information Requirements&quot;).<br>[root@m1 k8s]# ls<br>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server.csr  server-csr.json  server-key.pem  server.pem<br>[root@m1 k8s]# ls server*.pem<br>server-key.pem  server.pem<br>[root@m1 k8s]# ls |wc -l<br>9<br></code></pre></div></td></tr></table></figure><h4 id="6-3生成kube-proxy证书-用于部署worker-node"><a href="#6-3生成kube-proxy证书-用于部署worker-node" class="headerlink" title="6.3生成kube-proxy证书(用于部署worker node)"></a>6.3生成kube-proxy证书(用于部署worker node)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cd ~/TLS/k8s<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建证书请求文件</span><br>cat &gt; kube-proxy-csr.json&lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;k8s&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><p>生成证书</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 k8s]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy<br>-----------------<br>2023/04/07 14:22:07 [INFO] generate received request<br>2023/04/07 14:22:07 [INFO] received CSR<br>2023/04/07 14:22:07 [INFO] generating key: rsa-2048<br>2023/04/07 14:22:08 [INFO] encoded CSR<br>2023/04/07 14:22:08 [INFO] signed certificate with serial number 702550285005427916593510235684249714244442590928<br>2023/04/07 14:22:08 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for<br>websites. For more information see the Baseline Requirements for the Issuance and Management<br>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);<br>specifically, section 10.2.3 (&quot;Information Requirements&quot;).<br>[root@m1 k8s]# ls kube-proxy*.pem<br>kube-proxy-key.pem  kube-proxy.pem<br>[root@m1 k8s]# ls |wc -l<br>13<br></code></pre></div></td></tr></table></figure><h3 id="7-部署Master-Node"><a href="#7-部署Master-Node" class="headerlink" title="7. 部署Master Node"></a>7. 部署Master Node</h3><h4 id="7-1-从-Github-下载二进制文件"><a href="#7-1-从-Github-下载二进制文件" class="headerlink" title="7.1 从 Github 下载二进制文件"></a>7.1 从 Github 下载二进制文件</h4><p>下载地址：</p><p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#v1183">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#v1183</a></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://dl.k8s.io/v1.18.3/kubernetes-server-linux-amd64.tar.gz<br><br>5561483d796b124b8fe0e1cf5778ea03fec1e244ebc29f4b1b6c5ac93ab6bd10808d05da81b5f26426d51a3784c93ddf8b375ff971a78aebfd0ec7acac161365<br></code></pre></div></td></tr></table></figure><h4 id="7-2-解压二进制包"><a href="#7-2-解压二进制包" class="headerlink" title="7.2 解压二进制包"></a>7.2 解压二进制包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tar zxvf kubernetes-server-linux-amd64.tar.gz<br><br>mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; <br>cd kubernetes/server/bin<br>cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin<br>cp kubectl /usr/bin/<br></code></pre></div></td></tr></table></figure><h4 id="7-3-部署-kube-apiserver"><a href="#7-3-部署-kube-apiserver" class="headerlink" title="7.3 部署 kube-apiserver"></a>7.3 部署 kube-apiserver</h4><h5 id="7-3-1创建配置文件"><a href="#7-3-1创建配置文件" class="headerlink" title="7.3.1创建配置文件"></a>7.3.1创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF<br>KUBE_APISERVER_OPTS=&quot;--logtostderr=false \<br>--v=2 \<br>--log-dir=/opt/kubernetes/logs \<br>--etcd-servers=https://172.16.1.125:2379,https://172.16.1.216:2379,https://172.16.1.242:2379 \<br>--bind-address=172.16.1.125 \<br>--secure-port=6443 \<br>--advertise-address=172.16.1.125 \<br>--allow-privileged=true \<br>--service-cluster-ip-range=10.0.0.0/24 \<br>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \<br>--authorization-mode=RBAC,Node \<br>--enable-bootstrap-token-auth=true \<br>--token-auth-file=/opt/kubernetes/cfg/token.csv \<br>--service-node-port-range=30000-32767 \<br>--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem  \<br>--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \<br>--tls-cert-file=/opt/kubernetes/ssl/server.pem \<br>--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \<br>--client-ca-file=/opt/kubernetes/ssl/ca.pem \<br>--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \<br>--etcd-cafile=/opt/etcd/ssl/ca.pem \<br>--etcd-certfile=/opt/etcd/ssl/server.pem \<br>--etcd-keyfile=/opt/etcd/ssl/server-key.pem \<br>--audit-log-maxage=30 \<br>--audit-log-maxbackup=3 \<br>--audit-log-maxsize=100 \<br>--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">– logtostderr：启用日志<br>– v：日志等级<br><br>– log-dir：日志目录<br>– etcd-servers：etcd集群地址<br>– bind-address：监听地址<br>– secure-port：https 安全端口<br>– advertise-address：集群通告地址<br>– allow-privileged：启用授权<br>– service-cluster-ip-range：Service虚拟 IP地址段<br>– enable-admission-plugins：准入控制模块<br>– authorization-mode：认证授权，启用 RBAC 授权和节点自管理<br>– enable-bootstrap-token-auth：启用 TLS bootstrap 机制<br>– token-auth-file：bootstrap token文件<br>– service-node-port-range：Service nodeport类型默认分配端口范围<br><br>– kubelet-client-xxx：apiserver 访问 kubelet客户端证书<br>– tls-xxx-file：apiserver https 证书<br>– etcd-xxxfile：连接 Etcd 集群证书<br>– audit-log-xxx：审计日志<br></code></pre></div></td></tr></table></figure><h5 id="7-3-2生成的证书拷贝到配置文件中的路径"><a href="#7-3-2生成的证书拷贝到配置文件中的路径" class="headerlink" title="7.3.2生成的证书拷贝到配置文件中的路径:"></a>7.3.2生成的证书拷贝到配置文件中的路径:</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/<br></code></pre></div></td></tr></table></figure><h5 id="7-3-3启用-TLS-Bootstrapping-机制"><a href="#7-3-3启用-TLS-Bootstrapping-机制" class="headerlink" title="7.3.3启用 TLS Bootstrapping 机制"></a>7.3.3启用 TLS Bootstrapping 机制</h5><p>TLS Bootstraping：Master apiserver 启用 TLS 认证后，Node 节点 kubelet 和 kube-proxy 要与 kube-apiserver 进行通信，必须使用 CA 签发的有效证书才可以，当 Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes 引入了 TLS bootstraping 机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署。所以强烈建议在 Node 上使用这种方式，目前主要用于 kubelet，kube-proxy 还是由我们统一颁发一个证书。</p><p>创建上述配置文件中 token 文件:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF<br>c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="7-3-4systemd-管理-apiserver"><a href="#7-3-4systemd-管理-apiserver" class="headerlink" title="7.3.4systemd 管理 apiserver"></a>7.3.4systemd 管理 apiserver</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"> cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes API Server<br>Documentation=https://github.com/kubernetes/kubernetes<br>[Service]<br>EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf<br>ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS <br>Restart=on-failure<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="7-3-5启动并设置开机启动"><a href="#7-3-5启动并设置开机启动" class="headerlink" title="7.3.5启动并设置开机启动"></a>7.3.5启动并设置开机启动</h5><figure class="highlight nsis"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload<br><span class="hljs-params">system</span>ctl start kube-apiserver<br><span class="hljs-params">system</span>ctl enable kube-apiserver<br><span class="hljs-params">system</span>ctl status kube-apiserver<br></code></pre></div></td></tr></table></figure><h5 id="7-3-6授权-kubelet-bootstrap-用户允许请求证书"><a href="#7-3-6授权-kubelet-bootstrap-用户允许请求证书" class="headerlink" title="7.3.6授权 kubelet-bootstrap 用户允许请求证书"></a>7.3.6授权 kubelet-bootstrap 用户允许请求证书</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl create clusterrolebinding kubelet-bootstrap \<br>--clusterrole=system:node-bootstrapper \<br>--user=kubelet-bootstrap<br></code></pre></div></td></tr></table></figure><h4 id="7-4部署-kube-controller-manager"><a href="#7-4部署-kube-controller-manager" class="headerlink" title="7.4部署 kube-controller-manager"></a>7.4部署 kube-controller-manager</h4><h5 id="7-4-1创建配置文件"><a href="#7-4-1创建配置文件" class="headerlink" title="7.4.1创建配置文件"></a>7.4.1创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF<br>KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \<br>--v=2 \<br>--log-dir=/opt/kubernetes/logs \<br>--leader-elect=true \<br>--master=127.0.0.1:8080 \<br>--bind-address=127.0.0.1 \<br>--allocate-node-cidrs=true \<br>--cluster-cidr=10.244.0.0/16 \<br>--service-cluster-ip-range=10.0.0.0/24 \<br>--cluster-name=kubernetes \<br>--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \<br>--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \<br>--root-ca-file=/opt/kubernetes/ssl/ca.pem \<br>--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \<br>--experimental-cluster-signing-duration=87600h0m0s&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">– master：通过本地非安全本地端口 8080 连接 apiserver。<br>– leader-elect：当该组件启动多个时，自动选举（HA）<br>– cluster-signing-cert-file/–cluster-signing-key-file：自动为 kubelet颁发证书的 CA，与 apiserver保持一致<br></code></pre></div></td></tr></table></figure><h5 id="7-4-2systemd-管理-controller-manager"><a href="#7-4-2systemd-管理-controller-manager" class="headerlink" title="7.4.2systemd 管理 controller-manager"></a>7.4.2systemd 管理 controller-manager</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Controller Manager<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf<br>ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="7-4-3启动并设置开机启动"><a href="#7-4-3启动并设置开机启动" class="headerlink" title="7.4.3启动并设置开机启动"></a>7.4.3启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl start kube-controller-manager <br>systemctl enable kube-controller-manager<br>systemctl status kube-controller-manager<br></code></pre></div></td></tr></table></figure><h4 id="7-5部署-kube-scheduler"><a href="#7-5部署-kube-scheduler" class="headerlink" title="7.5部署 kube-scheduler"></a>7.5部署 kube-scheduler</h4><h5 id="7-5-1创建配置文件"><a href="#7-5-1创建配置文件" class="headerlink" title="7.5.1创建配置文件"></a>7.5.1创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF <br>KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \<br>--v=2 \<br>--log-dir=/opt/kubernetes/logs \<br>--leader-elect \<br>--master=127.0.0.1:8080 \<br>--bind-address=127.0.0.1&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">– master：通过本地非安全本地端口 8080 连接 apiserver。<br>– leader-elect：当该组件启动多个时，自动选举（HA）<br></code></pre></div></td></tr></table></figure><h5 id="7-5-2systemd-管理-scheduler"><a href="#7-5-2systemd-管理-scheduler" class="headerlink" title="7.5.2systemd 管理 scheduler"></a>7.5.2systemd 管理 scheduler</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF <br>[Unit]<br>Description=Kubernetes Scheduler<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf<br>ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS <br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="7-5-3启动并设置开机启动"><a href="#7-5-3启动并设置开机启动" class="headerlink" title="7.5.3启动并设置开机启动"></a>7.5.3启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload <br>systemctl start kube-scheduler <br>systemctl enable kube-scheduler<br>systemctl status kube-scheduler<br></code></pre></div></td></tr></table></figure><h4 id="7-6查看集群状态"><a href="#7-6查看集群状态" class="headerlink" title="7.6查看集群状态"></a>7.6查看集群状态</h4><p>所有组件都已经启动成功，通过 kubectl 工具查看当前集群组件状态：</p><figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">[root@m1 ~]# kubectl <span class="hljs-built_in">get</span> cs<br>NAME                 STATUS    MESSAGE             <span class="hljs-built_in">ERROR</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">scheduler </span>           Healthy   ok                  <br>controller-manager   Healthy   ok                  <br>etcd-0               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-1               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-2               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;   <br></code></pre></div></td></tr></table></figure><h3 id="8-部署Worker-Node"><a href="#8-部署Worker-Node" class="headerlink" title="8. 部署Worker Node"></a>8. 部署Worker Node</h3><h4 id="8-1创建工作目录并拷贝二进制文件"><a href="#8-1创建工作目录并拷贝二进制文件" class="headerlink" title="8.1创建工作目录并拷贝二进制文件"></a>8.1创建工作目录并拷贝二进制文件</h4><p>在所有 worker node 创建工作目录：</p><figure class="highlight elixir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elixir">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;<br><br><span class="hljs-comment">#从master拷贝</span><br>cd kubernetes/server/bin<br>cp kubelet kube-proxy /opt/kubernetes/bin<br><br>scp kubelet kube-proxy root<span class="hljs-variable">@node1</span><span class="hljs-symbol">:/opt/kubernetes/bin</span><br>scp kubelet kube-proxy root<span class="hljs-variable">@node2</span><span class="hljs-symbol">:/opt/kubernetes/bin</span><br></code></pre></div></td></tr></table></figure><h4 id="8-2-创建bootstrap-kubeconfig文件和kube-proxy-kubeconfig文件"><a href="#8-2-创建bootstrap-kubeconfig文件和kube-proxy-kubeconfig文件" class="headerlink" title="8.2 创建bootstrap kubeconfig文件和kube-proxy kubeconfig文件"></a>8.2 创建bootstrap kubeconfig文件和kube-proxy kubeconfig文件</h4><h5 id="8-2-1创建kubeconfig文件"><a href="#8-2-1创建kubeconfig文件" class="headerlink" title="8.2.1创建kubeconfig文件"></a>8.2.1创建kubeconfig文件</h5><figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">在生成kubernetes证书的目录下执行以下命令生成kubeconfig文件：<br>[root@m1 ~]# cd ~/TLS/k8s<br><br><span class="hljs-comment">#指定apiserver 内网负载均衡地址</span><br>[root@m1 k8s]# <span class="hljs-attribute">KUBE_APISERVER</span>=<span class="hljs-string">&quot;https://172.16.1.125:6443&quot;</span><br>[root@m1 k8s]# <span class="hljs-attribute">TOKEN</span>=c47ffb939f5ca36231d9e3121a252940 #这个和上面创建token文件的一致<br>     <br><span class="hljs-comment"># 生成 kubelet bootstrap kubeconfig 配置文件</span><br><br><span class="hljs-comment">#设置集群参数</span><br>[root@m1 k8s]# kubectl<span class="hljs-built_in"> config </span>set-cluster kubernetes \<br>  <span class="hljs-attribute">--certificate-authority</span>=/opt/kubernetes/ssl/ca.pem \<br>  <span class="hljs-attribute">--embed-certs</span>=<span class="hljs-literal">true</span> \<br>  <span class="hljs-attribute">--server</span>=<span class="hljs-variable">$&#123;KUBE_APISERVER&#125;</span> \<br>  <span class="hljs-attribute">--kubeconfig</span>=bootstrap.kubeconfig<br><br><span class="hljs-comment">#设置客户端认证参数</span><br>[root@m1 k8s]# kubectl<span class="hljs-built_in"> config </span>set-credentials <span class="hljs-string">&quot;kubelet-bootstrap&quot;</span> \<br>  <span class="hljs-attribute">--token</span>=<span class="hljs-variable">$&#123;TOKEN&#125;</span> \<br>  <span class="hljs-attribute">--kubeconfig</span>=bootstrap.kubeconfig<br><br><span class="hljs-comment">#设置上下文参数</span><br>[root@m1 k8s]# kubectl<span class="hljs-built_in"> config </span>set-context<span class="hljs-built_in"> default </span>\<br>  <span class="hljs-attribute">--cluster</span>=kubernetes \<br>  <span class="hljs-attribute">--user</span>=kubelet-bootstrap \<br>  <span class="hljs-attribute">--kubeconfig</span>=bootstrap.kubeconfig<br><br><span class="hljs-comment">#设置默认上下文</span><br>[root@m1 k8s]# kubectl<span class="hljs-built_in"> config </span>use-context<span class="hljs-built_in"> default </span><span class="hljs-attribute">--kubeconfig</span>=bootstrap.kubeconfig<br></code></pre></div></td></tr></table></figure><h5 id="8-2-2创建kube-proxy-kubeconfig文件"><a href="#8-2-2创建kube-proxy-kubeconfig文件" class="headerlink" title="8.2.2创建kube-proxy kubeconfig文件"></a>8.2.2创建kube-proxy kubeconfig文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 k8s]# kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>[root@m1 k8s]# kubectl config set-credentials kube-proxy \<br>  --client-certificate=./kube-proxy.pem \<br>  --client-key=./kube-proxy-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>[root@m1 k8s]# kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>[root@m1 k8s]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@m1 k8s]# ls *.kubeconfig<br>bootstrap.kubeconfig  kube-proxy.kubeconfig<br><br>!!!将这两个文件拷贝到Node节点/opt/kubernetes/cfg目录下<br>cp bootstrap.kubeconfig kube-proxy.kubeconfig /opt/kubernetes/cfg<br><br>scp bootstrap.kubeconfig kube-proxy.kubeconfig root@node1:/opt/kubernetes/cfg<br>scp bootstrap.kubeconfig kube-proxy.kubeconfig root@node2:/opt/kubernetes/cfg<br></code></pre></div></td></tr></table></figure><h4 id="8-3部署-kubelet"><a href="#8-3部署-kubelet" class="headerlink" title="8.3部署 kubelet"></a>8.3部署 kubelet</h4><h5 id="8-3-1创建配置文件"><a href="#8-3-1创建配置文件" class="headerlink" title="8.3.1创建配置文件"></a>8.3.1创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF<br>KUBELET_OPTS=&quot;--logtostderr=false \<br>--v=2 \<br>--log-dir=/opt/kubernetes/logs \<br>--hostname-override=k8s-m1 \<br>--network-plugin=cni \<br>--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \<br>--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \<br>--config=/opt/kubernetes/cfg/kubelet-config.yml \<br>--cert-dir=/opt/kubernetes/ssl \<br>--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;<br>EOF<br></code></pre></div></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">– hostname-override：显示名称，集群中唯一<br>– network-plugin：启用 CNI<br>– kubeconfig：空路径，会自动生成，后面用于连接 apiserver<br>– bootstrap-kubeconfig：首次启动向 apiserver 申请证书<br>– config：配置参数文件<br>– cert-dir：kubelet证书生成目录<br>– pod-infra-container-image：管理 Pod 网络容器的镜像<br></code></pre></div></td></tr></table></figure><h5 id="8-3-2配置参数文件"><a href="#8-3-2配置参数文件" class="headerlink" title="8.3.2配置参数文件"></a>8.3.2配置参数文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF<br>kind: KubeletConfiguration<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>address: 0.0.0.0<br>port: 10250<br>readOnlyPort: 10255<br>cgroupDriver: cgroupfs<br>clusterDNS: [&quot;10.0.0.2&quot;]<br>clusterDomain: cluster.local.<br>failSwapOn: false<br>authentication:<br>  anonymous:<br>    enabled: false <br>  webhook:<br>    cacheTTL: 2m0s<br>    enabled: true<br>  x509:<br>    clientCAFile: /opt/kubernetes/ssl/ca.pem <br>authorization:<br>  mode: Webhook<br>  webhook:<br>    cacheAuthorizedTTL: 5m0s<br>    cacheUnauthorizedTTL: 30s <br>evictionHard:<br>imagefs.available: 15%<br>memory.available: 100Mi<br>nodefs.available: 10%<br>nodefs.inodesFree: 5%<br>maxOpenFiles: 1000000 <br>maxPods: 110<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="8-3-3systemd管理kubelet组件"><a href="#8-3-3systemd管理kubelet组件" class="headerlink" title="8.3.3systemd管理kubelet组件"></a>8.3.3systemd管理kubelet组件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Kubelet<br>After=docker.service<br>Requires=docker.service<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf<br>ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="8-3-4启动并设置开机启动"><a href="#8-3-4启动并设置开机启动" class="headerlink" title="8.3.4启动并设置开机启动"></a>8.3.4启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload <br>systemctl start kubelet <br>systemctl enable kubelet<br>systemctl status kubelet <br><br>报错查看日志：journalctl -u kubelet --no-pager<br></code></pre></div></td></tr></table></figure><h4 id="8-4-批准-kubelet证书申请并加入集群"><a href="#8-4-批准-kubelet证书申请并加入集群" class="headerlink" title="8.4 批准 kubelet证书申请并加入集群"></a>8.4 批准 kubelet证书申请并加入集群</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">master节点：<br>在Master审批Node加入集群：<br>启动后还没加入到集群中，需要手动允许该节点才可以。<br>在Master节点查看请求签名的Node：<br><br>[root@m1 k8s]#  kubectl get csr<br>NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION<br>node-csr-LAbFoGwqhnHEeptAOdLAE8XmmJJ4VESdH6rVXAbyy6c   65s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending<br><br>[root@m1 k8s]# kubectl certificate approve node-csr-LAbFoGwqhnHEeptAOdLAE8XmmJJ4VESdH6rVXAbyy6c<br>certificatesigningrequest.certificates.k8s.io/node-csr-LAbFoGwqhnHEeptAOdLAE8XmmJJ4VESdH6rVXAbyy6c approved<br><br>[root@m1 k8s]# kubectl get nodes<br>NAME     STATUS     ROLES    AGE   VERSION<br>k8s-m1   NotReady   &lt;none&gt;   25s   v1.18.3<br><br>注：由于网络插件还没有部署，节点会没有准备就绪 NotReady<br></code></pre></div></td></tr></table></figure><h4 id="8-5-部署-kube-proxy"><a href="#8-5-部署-kube-proxy" class="headerlink" title="8.5 部署 kube-proxy"></a>8.5 部署 kube-proxy</h4><h5 id="8-5-1创建配置文件"><a href="#8-5-1创建配置文件" class="headerlink" title="8.5.1创建配置文件"></a>8.5.1创建配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF<br>KUBE_PROXY_OPTS=&quot;--logtostderr=false \<br>--v=2 \<br>--log-dir=/opt/kubernetes/logs \<br>--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot; <br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="8-5-2配置参数文件"><a href="#8-5-2配置参数文件" class="headerlink" title="8.5.2配置参数文件"></a>8.5.2配置参数文件</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF <br>kind: KubeProxyConfiguration<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1 <br>bindAddress: 0.0.0.0<br>metricsBindAddress: 0.0.0.0:10249<br>clientConnection:<br>  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig <br>hostnameOverride: k8s-m1<br>clusterCIDR: 10.0.0.0/24<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="8-5-3systemd-管理-kube-proxy"><a href="#8-5-3systemd-管理-kube-proxy" class="headerlink" title="8.5.3systemd 管理 kube-proxy"></a>8.5.3systemd 管理 kube-proxy</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Proxy<br>After=network.target<br>[Service]<br>EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf <br>ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS <br>Restart=on-failure<br>LimitNOFILE=65536<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></div></td></tr></table></figure><h5 id="8-5-4启动并设置开机启动"><a href="#8-5-4启动并设置开机启动" class="headerlink" title="8.5.4启动并设置开机启动"></a>8.5.4启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload <br>systemctl start kube-proxy <br>systemctl enable kube-proxy<br>systemctl status kube-proxy <br></code></pre></div></td></tr></table></figure><h4 id="8-6-部署-CNI网络"><a href="#8-6-部署-CNI网络" class="headerlink" title="8.6 部署 CNI网络"></a>8.6 部署 CNI网络</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz<br>mkdir /opt/cni/bin -p<br>tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">部署 CNI 网络，安装flannel插件</span><br>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br><br>默认镜像地址无法访问，修改为 docker hub 镜像仓库。<br>sed -i -r &quot;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&quot; kube-flannel.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">部署拉去镜像需要一些时间</span><br>kubectl apply -f kube-flannel.yml<br>kubectl get pods -n kube-flannel<br>kubectl get node<br></code></pre></div></td></tr></table></figure><h4 id="8-7新增加-Worker-Node"><a href="#8-7新增加-Worker-Node" class="headerlink" title="8.7新增加 Worker Node"></a>8.7新增加 Worker Node</h4><h5 id="8-7-1拷贝已部署好的-Node-相关文件到新节点"><a href="#8-7-1拷贝已部署好的-Node-相关文件到新节点" class="headerlink" title="8.7.1拷贝已部署好的 Node 相关文件到新节点"></a>8.7.1拷贝已部署好的 Node 相关文件到新节点</h5><p>在 master 节点将 Worker Node 涉及文件拷贝到新节点</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">node1</span><br>[root@m1 ~]# scp -r /opt/kubernetes root@n1:/opt/<br>[root@m1 ~]# scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@n1:/usr/lib/systemd/system<br>[root@m1 ~]# scp -r /opt/cni/ root@n1:/opt/<br>[root@m1 ~]# scp /opt/kubernetes/ssl/ca.pem root@n1:/opt/kubernetes/ssl<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">node2</span><br>[root@m1 ~]# scp -r /opt/kubernetes root@n2:/opt/<br>[root@m1 ~]# scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@n2:/usr/lib/systemd/system<br>[root@m1 ~]# scp -r /opt/cni/ root@n2:/opt/<br>[root@m1 ~]# scp /opt/kubernetes/ssl/ca.pem root@2:/opt/kubernetes/ssl<br></code></pre></div></td></tr></table></figure><h5 id="8-7-2删除-kubelet-证书和-kubeconfig-文件（新加的worker-node）"><a href="#8-7-2删除-kubelet-证书和-kubeconfig-文件（新加的worker-node）" class="headerlink" title="8.7.2删除 kubelet 证书和 kubeconfig 文件（新加的worker node）"></a>8.7.2删除 kubelet 证书和 kubeconfig 文件（新加的worker node）</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig<br>rm -rf /opt/kubernetes/ssl/kubelet*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注：这几个文件是证书申请审批后自动生成的，每个 Node不同，必须删除重新生成。</span><br></code></pre></div></td></tr></table></figure><h5 id="8-7-3修改主机名"><a href="#8-7-3修改主机名" class="headerlink" title="8.7.3修改主机名"></a>8.7.3修改主机名</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vim /opt/kubernetes/cfg/kubelet.conf<br>--hostname-override=k8s-node1<br><br>vim /opt/kubernetes/cfg/kube-proxy-config.yml<br>hostnameOverride: k8s-node1<br></code></pre></div></td></tr></table></figure><h5 id="8-7-4启动并设置开机启动"><a href="#8-7-4启动并设置开机启动" class="headerlink" title="8.7.4启动并设置开机启动"></a>8.7.4启动并设置开机启动</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl start kubelet<br>systemctl enable kubelet<br>systemctl start kube-proxy<br>systemctl enable kube-proxy<br>systemctl status kubelet<br>systemctl status kube-proxy<br></code></pre></div></td></tr></table></figure><h5 id="8-7-5在-Master-上批准新-Node-kubelet-证书申请"><a href="#8-7-5在-Master-上批准新-Node-kubelet-证书申请" class="headerlink" title="8.7.5在 Master 上批准新 Node kubelet 证书申请"></a>8.7.5在 Master 上批准新 Node kubelet 证书申请</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl get csr<br>kubectl certificate approve 生成的name<br></code></pre></div></td></tr></table></figure><h5 id="8-7-6查看-Node-状态"><a href="#8-7-6查看-Node-状态" class="headerlink" title="8.7.6查看 Node 状态"></a>8.7.6查看 Node 状态</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl get node<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二进制部署kubernetes集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Centos8网卡配置</title>
    <link href="/2022/08/24/Centos8%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/08/24/Centos8%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="Centos8网卡命令"><a href="#Centos8网卡命令" class="headerlink" title="Centos8网卡命令"></a>Centos8网卡命令</h2><h3 id="1-查看网卡设备详细信息"><a href="#1-查看网卡设备详细信息" class="headerlink" title="1.查看网卡设备详细信息"></a>1.查看网卡设备详细信息</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli device show / nmcli device show ens33<br></code></pre></div></td></tr></table></figure><h3 id="2-查看网卡设备状态"><a href="#2-查看网卡设备状态" class="headerlink" title="2.查看网卡设备状态"></a>2.查看网卡设备状态</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli device status<br></code></pre></div></td></tr></table></figure><h3 id="3-查看网卡信息"><a href="#3-查看网卡信息" class="headerlink" title="3.查看网卡信息"></a>3.查看网卡信息</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli device status<br></code></pre></div></td></tr></table></figure><h3 id="4-查看网卡具体信息"><a href="#4-查看网卡具体信息" class="headerlink" title="4.查看网卡具体信息"></a>4.查看网卡具体信息</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli connection show ens33<br></code></pre></div></td></tr></table></figure><h3 id="5-查看所有活动连接"><a href="#5-查看所有活动连接" class="headerlink" title="5.查看所有活动连接"></a>5.查看所有活动连接</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli connection show --active<br></code></pre></div></td></tr></table></figure><h3 id="6-启动网卡"><a href="#6-启动网卡" class="headerlink" title="6.启动网卡"></a>6.启动网卡</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli connection up ens33<br></code></pre></div></td></tr></table></figure><h3 id="7-停止"><a href="#7-停止" class="headerlink" title="7.停止"></a>7.停止</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli connection down ens33（可被自动激活）<br><br>nmcli device disconnect ens33（禁止被自动激活）<br></code></pre></div></td></tr></table></figure><h3 id="8-重启"><a href="#8-重启" class="headerlink" title="8.重启"></a>8.重启</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nmcli connection reload<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Centos8网卡配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql安装</title>
    <link href="/2022/08/24/mysql%E5%AE%89%E8%A3%85/"/>
    <url>/2022/08/24/mysql%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install mysql<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://dev.mysql.com/get/mysql80-community-release-el7-6.noarch.rpm<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install mysql80-community-release-el7-6.noarch.rpm<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install mysql-community-server --nogpgcheck<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl start mysqld<br>systemctl enable mysqld<br>systemctl status mysqld<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">grep &#x27;temporary password&#x27; /var/log/mysqld.log<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql安装</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker容器互通</title>
    <link href="/2022/08/24/docker%E5%AE%B9%E5%99%A8%E4%BA%92%E9%80%9A/"/>
    <url>/2022/08/24/docker%E5%AE%B9%E5%99%A8%E4%BA%92%E9%80%9A/</url>
    
    <content type="html"><![CDATA[<h3 id="1-创建自定义网桥"><a href="#1-创建自定义网桥" class="headerlink" title="1.创建自定义网桥"></a>1.创建自定义网桥</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker network create  --subnet=172.101.0.0/24 test<br></code></pre></div></td></tr></table></figure><p>###网段可以自己定义，最后是网桥名称也可以自己定义</p><h3 id="2-查看自定义网桥信息"><a href="#2-查看自定义网桥信息" class="headerlink" title="2.查看自定义网桥信息"></a>2.查看自定义网桥信息</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker network inspect test<br></code></pre></div></td></tr></table></figure><h3 id="3-启动容器"><a href="#3-启动容器" class="headerlink" title="3.启动容器"></a>3.启动容器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker run -itd --net=test --ip=172.101.0.101 --name server centos<br></code></pre></div></td></tr></table></figure><h3 id="4-添加路由"><a href="#4-添加路由" class="headerlink" title="4.添加路由"></a>4.添加路由</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ip route add **172.102.0.0/24** via 192.168.100.130 dev ens33<br></code></pre></div></td></tr></table></figure><h3 id="5-添加永久路由"><a href="#5-添加永久路由" class="headerlink" title="5.添加永久路由"></a>5.添加永久路由</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##编辑文件vim /etc/rc.local</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##在最后添加</span></span><br><br>ip route add 172.102.0.0/24 via 192.168.100.130 dev ens33<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker容器互通</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux查看服务器规格</title>
    <link href="/2022/08/24/linux%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E6%A0%BC/"/>
    <url>/2022/08/24/linux%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E6%A0%BC/</url>
    
    <content type="html"><![CDATA[<h3 id="1-查看物理CPU个数："><a href="#1-查看物理CPU个数：" class="headerlink" title="1.查看物理CPU个数："></a>1.查看物理CPU个数：</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat /proc/cpuinfo |grep &quot;physical id&quot;|sort |uniq|wc -l<br></code></pre></div></td></tr></table></figure><h3 id="2-查看每个CPU具有几个核"><a href="#2-查看每个CPU具有几个核" class="headerlink" title="2.查看每个CPU具有几个核"></a>2.查看每个CPU具有几个核</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat /proc/cpuinfo |grep &quot;cores&quot;|uniq<br></code></pre></div></td></tr></table></figure><h3 id="3-查看逻辑CPU个数"><a href="#3-查看逻辑CPU个数" class="headerlink" title="3.查看逻辑CPU个数"></a>3.查看逻辑CPU个数</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat /proc/cpuinfo |grep &quot;processor&quot;|wc -l<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">df -h |grep -v &#x27;Filesystem&#x27; | awk &#x27;BEGIN &#123;printf &quot;文件系统使用情况： \n \n&quot;&#125; &#123;printf $1&#125; &#123;printf &quot;文件系统使用率：&quot;&#125; &#123;print $5&#125;&#x27;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux查看服务器规格</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes搭建</title>
    <link href="/2022/08/24/kubernetes%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/08/24/kubernetes%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="kubernetes搭建"><a href="#kubernetes搭建" class="headerlink" title="kubernetes搭建"></a>kubernetes搭建</h1><h2 id="一-安装kubeadm"><a href="#一-安装kubeadm" class="headerlink" title="一.安装kubeadm"></a>一.安装kubeadm</h2><ul><li><p>一台兼容的 Linux 主机。Kubernetes 项目为基于 Debian 和 Red Hat 的 Linux 发行版以及一些不提供包管理器的发行版提供通用的指令</p></li><li><p>每台机器 2 GB 或更多的 RAM （如果少于这个数字将会影响你应用的运行内存)</p></li><li><p>2 CPU 核或更多</p></li><li><p>集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</p></li><li><ul><li><strong>设置防火墙放行规则</strong></li></ul></li><li><p>节点之中不可以有重复的主机名、MAC 地址或 product_uuid。请参见<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address">这里</a>了解更多详细信息。</p></li><li><ul><li><strong>设置不同hostname</strong></li></ul></li><li><p>开启机器上的某些端口。请参见<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports">这里</a> 了解更多详细信息。</p></li><li><ul><li><strong>内网互信</strong></li></ul></li><li><p>禁用交换分区。为了保证 kubelet 正常工作，你 <strong>必须</strong> 禁用交换分区。</p></li><li><ul><li><strong>永久关闭</strong></li></ul></li></ul><h3 id="1、基础环境"><a href="#1、基础环境" class="headerlink" title="1、基础环境"></a>1、基础环境</h3><p>所有机器执行以下操作</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">各个机器设置自己的域名</span><br>hostnamectl set-hostname xxxx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br>sudo setenforce 0<br>sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭swap</span><br>swapoff -a  <br>sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">允许 iptables 检查桥接流量</span><br>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf<br>br_netfilter<br>EOF<br><br>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>EOF<br>sudo sysctl --system<br></code></pre></div></td></tr></table></figure><h3 id="2、安装kubelet、kubeadm、kubectl"><a href="#2、安装kubelet、kubeadm、kubectl" class="headerlink" title="2、安装kubelet、kubeadm、kubectl"></a>2、安装kubelet、kubeadm、kubectl</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg<br>   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>exclude=kubelet kubeadm kubectl<br>EOF<br><br><br>sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes<br><br>sudo systemctl enable --now kubelet<br></code></pre></div></td></tr></table></figure><p>!  !  ! kubelet 现在每隔几秒就会重启，因为它陷入了一个等待 kubeadm 指令的死循环</p><h2 id="二-使用kubeadm引导集群"><a href="#二-使用kubeadm引导集群" class="headerlink" title="二.使用kubeadm引导集群"></a>二.使用kubeadm引导集群</h2><h3 id="1、下载各个机器需要的镜像"><a href="#1、下载各个机器需要的镜像" class="headerlink" title="1、下载各个机器需要的镜像"></a>1、下载各个机器需要的镜像</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo tee ./images.sh &lt;&lt;-&#x27;EOF&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>images=(<br>kube-apiserver:v1.20.9<br>kube-proxy:v1.20.9<br>kube-controller-manager:v1.20.9<br>kube-scheduler:v1.20.9<br>coredns:1.7.0<br>etcd:3.4.13-0<br>pause:3.2<br>)<br>for imageName in $&#123;images[@]&#125; ; do<br>docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/$imageName<br>done<br>EOF<br>   <br>chmod +x ./images.sh &amp;&amp; ./images.sh<br></code></pre></div></td></tr></table></figure><h3 id="2、初始化主节点"><a href="#2、初始化主节点" class="headerlink" title="2、初始化主节点"></a>2、初始化主节点</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">所有机器添加master域名映射，以下需要修改为自己的</span><br>echo &quot;192.168.100.132  master&quot; &gt;&gt; /etc/hosts<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主节点初始化</span><br>kubeadm init \<br>--apiserver-advertise-address=192.168.100.132 \<br>--control-plane-endpoint=master \<br>--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \<br>--kubernetes-version v1.20.9 \<br>--service-cidr=10.96.0.0/16 \<br>--pod-network-cidr=172.16.0.0/16<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">所有网络范围不重叠</span><br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  mkdir -p $HOME/.kube<br>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>  sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><br>Alternatively, if you are the root user, you can run:<br><br>  export KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>You can now join any number of control-plane nodes by copying certificate authorities<br>and service account keys on each node and then running the following as root:<br><br>  kubeadm join cluster-endpoint:6443 --token hums8f.vyx71prsg74ofce7 \<br>    --discovery-token-ca-cert-hash sha256:a394d059dd51d68bb007a532a037d0a477131480ae95f75840c461e85e2c6ae3 \<br>    --control-plane <br><br>Then you can join any number of worker nodes by running the following on each as root:<br><br>kubeadm join cluster-endpoint:6443 --token hums8f.vyx71prsg74ofce7 \<br>    --discovery-token-ca-cert-hash sha256:a394d059dd51d68bb007a532a037d0a477131480ae95f75840c461e85e2c6ae3<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看集群所有节点</span><br>kubectl get nodes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">根据配置文件，给集群创建资源</span><br>kubectl apply -f xxxx.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看集群部署了哪些应用？</span><br>docker ps   ===   kubectl get pods -A<br><span class="hljs-meta prompt_"># </span><span class="language-bash">运行中的应用在docker里面叫容器，在k8s里面叫Pod</span><br>kubectl get pods -A<br></code></pre></div></td></tr></table></figure><h4 id="1、设置-kube-x2F-config"><a href="#1、设置-kube-x2F-config" class="headerlink" title="1、设置.kube&#x2F;config"></a>1、设置.kube&#x2F;config</h4><p><img src="C:\Users\root\AppData\Roaming\Typora\typora-user-images\image-20220807153842902.png" alt="image-20220807153842902"></p><h4 id="2、安装网络组件"><a href="#2、安装网络组件" class="headerlink" title="2、安装网络组件"></a>2、安装网络组件</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">curl https://docs.projectcalico.org/v3.18/manifests/calico.yaml -O<br><br>kubectl apply -f calico.yaml<br></code></pre></div></td></tr></table></figure><h4 id="3、node加入集群"><a href="#3、node加入集群" class="headerlink" title="3、node加入集群"></a>3、node加入集群</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubeadm join master:6443 --token cbi16x.u9jeyppdxfy880bf     --discovery-token-ca-cert-hash sha256:351c0be7b299f4e12ce554ef409571aca6f21c1a70e97ee96a96dccb85bd57a0<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">生成新令牌<br>kubeadm token create --print-join-command<br></code></pre></div></td></tr></table></figure><h2 id="查看证书年限"><a href="#查看证书年限" class="headerlink" title="查看证书年限"></a>查看证书年限</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubeadm  certs check-expiration <br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kubernetes搭建</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>进制转换</title>
    <link href="/2022/04/20/%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2/"/>
    <url>/2022/04/20/%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="B（二进制）O（八进制）D（十进制）H（十六进制）"><a href="#B（二进制）O（八进制）D（十进制）H（十六进制）" class="headerlink" title="Ｂ（二进制）O（八进制）Ｄ（十进制）Ｈ（十六进制）"></a>Ｂ（二进制）O（八进制）Ｄ（十进制）Ｈ（十六进制）</h2><h3 id="二进制转十进制"><a href="#二进制转十进制" class="headerlink" title="二进制转十进制"></a>二进制转十进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">1  1  0  0 1 0 0<br>64 32 16 8 4 2 1<br><br>64 + 32 + 4 = 100  (十进制)<br></code></pre></div></td></tr></table></figure><h3 id="二进制转八进制"><a href="#二进制转八进制" class="headerlink" title="二进制转八进制"></a>二进制转八进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">0 0 1    1 0 0    1 0 0   (从右到左，三个一组，不够前面添0)<br>4 2 1    4 2 1    4 2 1<br><br>  1        4        4<br>  <br> 144 (八进制)<br></code></pre></div></td></tr></table></figure><h3 id="二进制转十六进制"><a href="#二进制转十六进制" class="headerlink" title="二进制转十六进制"></a>二进制转十六进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">0 1 1 0   0 1 0 0     (从右到左，四个一组，不够前面添0)<br>8 4 2 1   8 4 2 1<br>   6         4<br>        64(十六进制)<br></code></pre></div></td></tr></table></figure><h3 id="八进制转十进制"><a href="#八进制转十进制" class="headerlink" title="八进制转十进制"></a>八进制转十进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">八进制：302 = 3×8² + 0×8¹ + 2×8⁰ = 192 + 0 + 2 = 194(十进制)<br></code></pre></div></td></tr></table></figure><h3 id="八进制转十六进制"><a href="#八进制转十六进制" class="headerlink" title="八进制转十六进制"></a>八进制转十六进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">  1       4      4<br>4 2 1   4 2 1  4 2 1<br>0 0 1   1 0 0  1 0 0<br>     001100100 (二进制)<br>0 1 1 0    0 1 0 0<br>8 4 2 1    8 4 2 1<br>   6          4<br>       64 (十六进制)<br></code></pre></div></td></tr></table></figure><h3 id="十六进制转十进制"><a href="#十六进制转十进制" class="headerlink" title="十六进制转十进制"></a>十六进制转十进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">十六进制：ABC = A×16² + B×16¹ + C×16⁰ = 2560 + 176 + 12 = 2748(十进制)<br></code></pre></div></td></tr></table></figure><h3 id="十六进制转八进制"><a href="#十六进制转八进制" class="headerlink" title="十六进制转八进制"></a>十六进制转八进制</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">   6           4<br>8 4 2 1     8 4 2 1<br>0 1 1 0     0 1 0 0<br>    01100100 (二进制)<br>0 0 1   1 0 0  1 0 0<br>4 2 1   4 2 1  4 2 1<br>  1       4      4<br>         144 (八进制)<br></code></pre></div></td></tr></table></figure><h3 id="与运算-∧"><a href="#与运算-∧" class="headerlink" title="与运算(∧)"></a>与运算(∧)</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">0 &amp; 0 = 0<br>0 &amp; 1 = 0<br>1 &amp; 0 = 0<br>1 &amp; 1 = 1<br><br>同为1得 1，其余为 0<br></code></pre></div></td></tr></table></figure><h3 id="或运算-∨"><a href="#或运算-∨" class="headerlink" title="或运算(∨)"></a>或运算(∨)</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">0 | 0 = 0<br>0 | 1 = 1<br>1 | 0 = 1<br>1 | 1 = 1<br><br>有1为1<br></code></pre></div></td></tr></table></figure><h3 id="异或运算"><a href="#异或运算" class="headerlink" title="异或运算"></a>异或运算</h3><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">1 0 1 1 0 0 0 1<br>0 1 1 0 1 0 1 0<br><br>1 1 0 1 1 0 1 1<br><br>相同为 0，不同为 1 <br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>learn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>openstack-Train</title>
    <link href="/2022/04/17/openstack-Train/"/>
    <url>/2022/04/17/openstack-Train/</url>
    
    <content type="html"><![CDATA[<hr><h1 id="OpenStack-T版搭建"><a href="#OpenStack-T版搭建" class="headerlink" title="OpenStack T版搭建"></a>OpenStack T版搭建</h1><h2 id="密码表：-密码均为密码名称"><a href="#密码表：-密码均为密码名称" class="headerlink" title="密码表：(密码均为密码名称)"></a>密码表：(密码均为密码名称)</h2><table><thead><tr><th align="center">密码名称</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">数据库密码(不能使用变量)</td><td align="center">数据库的root密码</td></tr><tr><td align="center"><code>ADMIN_PASS</code></td><td align="center"><code>admin</code> 用户密码</td></tr><tr><td align="center"><code>CEILOMETER_DBPASS</code></td><td align="center">Telemetry 服务的数据库密码</td></tr><tr><td align="center"><code>CEILOMETER_PASS</code></td><td align="center">Telemetry 服务的 <code>ceilometer</code> 用户密码</td></tr><tr><td align="center"><code>CINDER_DBPASS</code></td><td align="center">块设备存储服务的数据库密码</td></tr><tr><td align="center"><code>CINDER_PASS</code></td><td align="center">块设备存储服务的 <code>cinder</code> 密码</td></tr><tr><td align="center"><code>DASH_DBPASS</code></td><td align="center">Database password for the dashboard</td></tr><tr><td align="center"><code>DEMO_PASS</code></td><td align="center"><code>demo</code> 用户的密码</td></tr><tr><td align="center"><code>GLANCE_DBPASS</code></td><td align="center">镜像服务的数据库密码</td></tr><tr><td align="center"><code>GLANCE_PASS</code></td><td align="center">镜像服务的 <code>glance</code> 用户密码</td></tr><tr><td align="center"><code>HEAT_DBPASS</code></td><td align="center">Orchestration服务的数据库密码</td></tr><tr><td align="center"><code>HEAT_DOMAIN_PASS</code></td><td align="center">Orchestration 域的密码</td></tr><tr><td align="center"><code>HEAT_PASS</code></td><td align="center">Orchestration 服务中<code>heat</code>用户的密码</td></tr><tr><td align="center"><code>KEYSTONE_DBPASS</code></td><td align="center">认证服务的数据库密码</td></tr><tr><td align="center"><code>NEUTRON_DBPASS</code></td><td align="center">网络服务的数据库密码</td></tr><tr><td align="center"><code>NEUTRON_PASS</code></td><td align="center">网络服务的 <code>neutron</code> 用户密码</td></tr><tr><td align="center"><code>NOVA_DBPASS</code></td><td align="center">计算服务的数据库密码</td></tr><tr><td align="center"><code>NOVA_PASS</code></td><td align="center">计算服务中<code>nova</code>用户的密码</td></tr><tr><td align="center"><code>RABBIT_PASS</code></td><td align="center">RabbitMQ的guest用户密码</td></tr><tr><td align="center"><code>SWIFT_PASS</code></td><td align="center">对象存储服务用户<code>swift</code>的密码</td></tr><tr><td align="center"><code>PLACEMENT_PASS</code></td><td align="center">Placement的密码</td></tr></tbody></table><h2 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h2><table><thead><tr><th align="center">主机名</th><th align="center">IP</th><th align="center">内存</th><th align="center">硬盘</th><th align="center">网卡数</th></tr></thead><tbody><tr><td align="center">controller</td><td align="center">172.16.100.28</td><td align="center">8G</td><td align="center">80G</td><td align="center">1</td></tr><tr><td align="center">compute</td><td align="center">172.16.100.29</td><td align="center">8G</td><td align="center">80G</td><td align="center">1</td></tr></tbody></table><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">hostnamectl set-hostname controller<br></code></pre></div></td></tr></table></figure><h4 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">hostnamectl set-hostname compute<br></code></pre></div></td></tr></table></figure><!--注意重新连接 否则后面创建Rabbitmq用户可能会报错--><h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><h3 id="controller配置"><a href="#controller配置" class="headerlink" title="controller配置"></a>controller配置</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/sysconfig/network-scripts/ifcfg-eth0<br><br>ONBOOT=yes<br>BOOTPROTO=static<br>IPADDR=172.16.100.28<br>NETMASK=255.255.255.0<br>GATEWAY=172.16.100.254<br>DNS1=114.114.114.114<br></code></pre></div></td></tr></table></figure><h3 id="compute配置"><a href="#compute配置" class="headerlink" title="compute配置"></a>compute配置</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/sysconfig/network-scripts/ifcfg-eth0<br><br>ONBOOT=yes<br>BOOTPROTO=static<br>IPADDR=172.16.100.29<br>NETMASK=255.255.255.0<br>GATEWAY=172.16.100.254<br>DNS1=114.114.114.114<br></code></pre></div></td></tr></table></figure><p>：wq 保存退出</p><h3 id="重启网卡"><a href="#重启网卡" class="headerlink" title="重启网卡"></a>重启网卡</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart network<br></code></pre></div></td></tr></table></figure><h4 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:00:db:9c brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.100.28/24 brd 172.16.100.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::6010:d73a:2158:5fe8/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></div></td></tr></table></figure><h4 id="compute-1"><a href="#compute-1" class="headerlink" title="compute"></a>compute</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:3c:b9:4c brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.100.29/24 brd 172.16.100.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::c374:72b:eb12:5916/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></div></td></tr></table></figure><h2 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h2><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl stop firewalld<br>systemctl disable firewalld<br></code></pre></div></td></tr></table></figure><h3 id="关闭网卡守护进程"><a href="#关闭网卡守护进程" class="headerlink" title="关闭网卡守护进程"></a>关闭网卡守护进程</h3><!--在controller和compute均执行--><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shel">systemctl stop NetworkManager<br>systemctl disable NetworkManager<br></code></pre></div></td></tr></table></figure><h3 id="关闭SElinux"><a href="#关闭SElinux" class="headerlink" title="关闭SElinux"></a>关闭SElinux</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">setenforce 0<br><br>vi /etc/selinux/config<br><br>修改 SELINUX=enforcing 为 SELINUX=disabled<br><br>:wq 保存退出<br></code></pre></div></td></tr></table></figure><h3 id="查看SElinux状态"><a href="#查看SElinux状态" class="headerlink" title="查看SElinux状态"></a>查看SElinux状态</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# getenforce <br>Permissive<br><br>[root@compute ~]# getenforce <br>Permissive<br><br></code></pre></div></td></tr></table></figure><h3 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">将目录下的源删除<br>rm -rf /etc/yum.repos.d/C*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">controller</span><br>[root@controller ~]# cat /etc/yum.repos.d/http.repo <br>[centos]<br>name=centos<br>baseurl=ftp://172.16.100.66/centos<br>gpgcheck=0<br>[openstack-t]<br>name=openstack-t<br>baseurl=ftp://172.16.100.66/openstack-t<br>gpgcheck=0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">compute</span><br>[root@compute ~]# cat /etc/yum.repos.d/http.repo <br>[centos]<br>name=centos<br>baseurl=ftp://172.16.100.66/centos<br>gpgcheck=0<br>[openstack-t]<br>name=openstack-t<br>baseurl=ftp://172.16.100.66/openstack-t<br>gpgcheck=0<br></code></pre></div></td></tr></table></figure><blockquote><p>此处用的是配置本地源，一个Centos，一个OpenStack源</p><p>附上国内阿里源<a href="https://mirrors.aliyun.com/centos/7/cloud/x86_64/openstack-train/">https://mirrors.aliyun.com/centos/7/cloud/x86_64/openstack-train/</a></p></blockquote><h3 id="配置host解析"><a href="#配置host解析" class="headerlink" title="配置host解析"></a>配置host解析</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cat /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><br>172.16.100.28 controller<br>172.16.100.29 compute<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# cat /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><br>172.16.100.28 controller<br>172.16.100.29 compute<br></code></pre></div></td></tr></table></figure><h3 id="测试各节点之间与Internet的通信"><a href="#测试各节点之间与Internet的通信" class="headerlink" title="测试各节点之间与Internet的通信"></a>测试各节点之间与Internet的通信</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ping -c 2 compute<br>PING compute (172.16.100.29) 56(84) bytes of data.<br>64 bytes from compute (172.16.100.29): icmp_seq=1 ttl=64 time=0.250 ms<br>64 bytes from compute (172.16.100.29): icmp_seq=2 ttl=64 time=0.447 ms<br><br>--- compute ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 0.250/0.348/0.447/0.100 m<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ping -c 2 controller<br>PING controller (172.16.100.28) 56(84) bytes of data.<br>64 bytes from controller (172.16.100.28): icmp_seq=1 ttl=64 time=0.378 ms<br>64 bytes from controller (172.16.100.28): icmp_seq=2 ttl=64 time=0.391 ms<br><br>--- controller ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 0.378/0.384/0.391/0.020 ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ping -c 2 baidu.com<br>PING baidu.com (220.181.38.251) 56(84) bytes of data.<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=47 time=174 ms<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=47 time=173 ms<br><br>--- baidu.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br>rtt min/avg/max/mdev = 173.205/173.637/174.070/0.600 ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ping -c 2 baidu.com<br>PING baidu.com (220.181.38.251) 56(84) bytes of data.<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=47 time=174 ms<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=47 time=171 ms<br><br>--- baidu.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 171.844/173.164/174.484/1.320 ms<br></code></pre></div></td></tr></table></figure><h3 id="修改时间同步配置文件"><a href="#修改时间同步配置文件" class="headerlink" title="修改时间同步配置文件"></a>修改时间同步配置文件</h3><h4 id="controller-2"><a href="#controller-2" class="headerlink" title="controller"></a>controller</h4><p>安装</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install chrony<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/chrony.conf<br><br>server ntp.aliyun.com iburst<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##大概26行左右###</span></span><br>allow 172.16.100.0/24<br></code></pre></div></td></tr></table></figure><h4 id="compute-2"><a href="#compute-2" class="headerlink" title="compute"></a>compute</h4><p>安装</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install chrony<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/chrony.conf<br><br>server controller iburst<br></code></pre></div></td></tr></table></figure><h4 id="重启chrony服务"><a href="#重启chrony服务" class="headerlink" title="重启chrony服务"></a>重启chrony服务</h4><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart chronyd<br></code></pre></div></td></tr></table></figure><h4 id="验证是否同步成功"><a href="#验证是否同步成功" class="headerlink" title="验证是否同步成功"></a>验证是否同步成功</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# chronyc sources<br>210 Number of sources = 1<br>MS Name/IP address         Stratum Poll Reach LastRx Last sample               <br>===============================================================================<br>^* 203.107.6.88                  2   6   367    79   +140us[ +789us] +/-   95ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# chronyc sources<br>210 Number of sources = 1<br>MS Name/IP address         Stratum Poll Reach LastRx Last sample               <br>===============================================================================<br>^* controller                    3   6   377     9    -34us[ +664us] +/-   96ms<br><br></code></pre></div></td></tr></table></figure><h3 id="所有节点安装openstack客户端和openstack-selinux"><a href="#所有节点安装openstack客户端和openstack-selinux" class="headerlink" title="所有节点安装openstack客户端和openstack-selinux"></a>所有节点安装openstack客户端和openstack-selinux</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install python-openstackclient openstack-selinux<br></code></pre></div></td></tr></table></figure><h3 id="安装Mariadb数据库-controller"><a href="#安装Mariadb数据库-controller" class="headerlink" title="安装Mariadb数据库(controller)"></a>安装Mariadb数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install mariadb mariadb-server python2-PyMySQL<br></code></pre></div></td></tr></table></figure><p>创建和编辑<code>/etc/my.cnf.d/openstack.cnf</code>文件并添加以下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shel">[mysqld]<br>bind-address = 172.16.100.28 #controller IP地址<br>default-storage-engine = innodb<br>innodb_file_per_table<br>max_connections = 4096<br>collation-server = utf8_general_ci<br>character-set-server = utf8<br></code></pre></div></td></tr></table></figure><h4 id="启动mariadb"><a href="#启动mariadb" class="headerlink" title="启动mariadb"></a>启动mariadb</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl start mariadb<br>systemctl enable mariadb<br></code></pre></div></td></tr></table></figure><h4 id="数据库默认初始化-设置密码000000"><a href="#数据库默认初始化-设置密码000000" class="headerlink" title="数据库默认初始化 (设置密码000000)"></a>数据库默认初始化 (设置密码000000)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# mysql_secure_installation<br><br>NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB<br>      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!<br><br>In order to log into MariaDB to secure it, we&#x27;ll need the current<br>password for the root user.  If you&#x27;ve just installed MariaDB, and<br>you haven&#x27;t set the root password yet, the password will be blank,<br>so you should just press enter here.<br><br>Enter current password for root (enter for none): <br>OK, successfully used password, moving on...<br><br>Setting the root password ensures that nobody can log into the MariaDB<br>root user without the proper authorisation.<br><br>Set root password? [Y/n] y<br>New password: <br>Re-enter new password: <br>Password updated successfully!<br>Reloading privilege tables..<br> ... Success!<br><br><br>By default, a MariaDB installation has an anonymous user, allowing anyone<br>to log into MariaDB without having to have a user account created for<br>them.  This is intended only for testing, and to make the installation<br>go a bit smoother.  You should remove them before moving into a<br>production environment.<br><br>Remove anonymous users? [Y/n] y<br> ... Success!<br><br>Normally, root should only be allowed to connect from &#x27;localhost&#x27;.  This<br>ensures that someone cannot guess at the root password from the network.<br><br>Disallow root login remotely? [Y/n] y<br> ... Success!<br><br>By default, MariaDB comes with a database named &#x27;test&#x27; that anyone can<br>access.  This is also intended only for testing, and should be removed<br>before moving into a production environment.<br><br>Remove test database and access to it? [Y/n] y<br> - Dropping test database...<br> ... Success!<br> - Removing privileges on test database...<br> ... Success!<br><br>Reloading the privilege tables will ensure that all changes made so far<br>will take effect immediately.<br><br>Reload privilege tables now? [Y/n] y<br> ... Success!<br><br>Cleaning up...<br><br>All done!  If you&#x27;ve completed all of the above steps, your MariaDB<br>installation should now be secure.<br><br>Thanks for using MariaDB!<br></code></pre></div></td></tr></table></figure><h3 id="安装rabbitmq并创建用户-controller"><a href="#安装rabbitmq并创建用户-controller" class="headerlink" title="安装rabbitmq并创建用户(controller)"></a>安装rabbitmq并创建用户(controller)</h3><p>1、功能:协调操作和状态信息服务</p><p>2、常用的消息代理软件</p><div class="hljs code-wrapper"><pre><code class="hljs">        RabbitMQ        Qpid        ZeroMQ</code></pre></div><p>3.在controller节点安装RabbitMQ</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.安装RabbitMQ软件包<br>yum -y install rabbitmq-server<br>b.启动服务并设置开机自启动<br>systemctl enable rabbitmq-server<br>systemctl start rabbitmq-server<br>查看运行状态<br>systemctl status rabbitmq-server<br>c.创建用户<br>rabbitmqctl add_user openstack RABBIT_PASS<br>rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;<br></code></pre></div></td></tr></table></figure><h3 id="安装memcached缓存-controller"><a href="#安装memcached缓存-controller" class="headerlink" title="安装memcached缓存(controller)"></a>安装memcached缓存(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.安装memcached软件包<br>yum -y install memcached python-memcached<br>b.修改配置文件的地址否则其他网络无法访问<br>sed -i &#x27;s#127.0.0.1#172.16.100.28#g&#x27; /etc/sysconfig/memcached  ##注意IP更换成自己的<br>c.启动服务并设置开机自启动<br>systemctl start memcached.service<br>systemctl enable memcached.service<br></code></pre></div></td></tr></table></figure><h2 id="Keystone认证服务"><a href="#Keystone认证服务" class="headerlink" title="Keystone认证服务"></a>Keystone认证服务</h2><p>keystone认证方式:UUID,PKI,Fernet   随机生成字符串的方法</p><p>功能:认证管理,授权管理,服务目录</p><h3 id="在控制节点创建认证服务数据库-controller"><a href="#在控制节点创建认证服务数据库-controller" class="headerlink" title="在控制节点创建认证服务数据库(controller)"></a>在控制节点创建认证服务数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建keystone数据库<br>CREATE DATABASE keystone;<br>c.创建keystone数据库用户，使其可以对keystone数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h3 id="安装keystone相关软件包-和openstack-utils-noarch软件包"><a href="#安装keystone相关软件包-和openstack-utils-noarch软件包" class="headerlink" title="安装keystone相关软件包 和openstack-utils.noarch软件包"></a>安装keystone相关软件包 和openstack-utils.noarch软件包</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-keystone httpd mod_wsgi openstack-utils.noarch<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/keystone/keystone.conf /etc/keystone/keystone.conf.bak<br>grep &#x27;^[a-z\[]&#x27;  /etc/keystone/keystone.conf.bak &gt; /etc/keystone/keystone.conf<br><br>openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN<br>openstack-config --set /etc/keystone/keystone.conf  database connection mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone<br>openstack-config --set /etc/keystone/keystone.conf  token provider fernet<br></code></pre></div></td></tr></table></figure><h3 id="同步keystone数据库"><a href="#同步keystone数据库" class="headerlink" title="同步keystone数据库"></a>同步keystone数据库</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看keystone库是否有数据--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">如果同步失败,将/var/log/keystone/keystone.log修改属组,重启httpd<br><br>chown -R keystone.keystone /var/log/keystone/keystone.log<br>systemctl restart httpd<br></code></pre></div></td></tr></table></figure><h3 id="初始化fernet"><a href="#初始化fernet" class="headerlink" title="初始化fernet"></a>初始化fernet</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone<br>keystone-manage credential_setup --keystone-user keystone --keystone-group keystone<br><br><br>keystone-manage bootstrap --bootstrap-password ADMIN_PASS \<br>  --bootstrap-admin-url http://controller:5000/v3/ \<br>  --bootstrap-internal-url http://controller:5000/v3/ \<br>  --bootstrap-public-url http://controller:5000/v3/ \<br>  --bootstrap-region-id RegionOne<br></code></pre></div></td></tr></table></figure><h3 id="配置Apache-HTTP服务器"><a href="#配置Apache-HTTP服务器" class="headerlink" title="配置Apache HTTP服务器"></a>配置Apache HTTP服务器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">echo &quot;ServerName controller&quot; &gt;&gt;/etc/httpd/conf/httpd.conf<br>ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/<br></code></pre></div></td></tr></table></figure><h4 id="启动HTTP服务"><a href="#启动HTTP服务" class="headerlink" title="启动HTTP服务"></a>启动HTTP服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable httpd.service<br>systemctl start httpd.service<br></code></pre></div></td></tr></table></figure><h3 id="创建并编辑admin-openrc文件"><a href="#创建并编辑admin-openrc文件" class="headerlink" title="创建并编辑admin-openrc文件"></a>创建并编辑admin-openrc文件</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cat admin-openrc <br>export OS_PROJECT_DOMAIN_NAME=Default<br>export OS_USER_DOMAIN_NAME=Default<br>export OS_PROJECT_NAME=admin<br>export OS_USERNAME=admin<br>export OS_PASSWORD=ADMIN_PASS<br>export OS_AUTH_URL=http://controller:5000/v3<br>export OS_IDENTITY_API_VERSION=3<br>export OS_IMAGE_API_VERSION=2<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">source admin-openrc<br></code></pre></div></td></tr></table></figure><h3 id="创建域-项目-用户-角色"><a href="#创建域-项目-用户-角色" class="headerlink" title="创建域,项目,用户,角色"></a>创建域,项目,用户,角色</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack domain create --description &quot;An Example Domain&quot; example<br><br>openstack project create --domain default \<br>  --description &quot;Service Project&quot; service<br><br>openstack project create --domain default \<br>  --description &quot;Demo Project&quot; myproject<br>  <br>openstack user create --domain default \<br>  --password MYUSER myuser<br><br>openstack role create myrole<br><br>openstack role add --project myproject --user myuser myrole<br></code></pre></div></td></tr></table></figure><h3 id="取消前面设置的环境变量"><a href="#取消前面设置的环境变量" class="headerlink" title="取消前面设置的环境变量"></a>取消前面设置的环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">unset OS_AUTH_URL OS_PASSWORD<br></code></pre></div></td></tr></table></figure><h3 id="作为admin用户和myuser用户请求身份令牌"><a href="#作为admin用户和myuser用户请求身份令牌" class="headerlink" title="作为admin用户和myuser用户请求身份令牌"></a>作为admin用户和myuser用户请求身份令牌</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack --os-auth-url http://controller:5000/v3 \<br>  --os-project-domain-name Default --os-user-domain-name Default \<br>  --os-project-name admin --os-username admin token issue \<br>  --os-password ADMIN_PASS<br>openstack --os-auth-url http://controller:5000/v3 \<br>  --os-project-domain-name Default --os-user-domain-name Default \<br>  --os-project-name myproject --os-username myuser token issue \<br>  --os-password MYUSER<br></code></pre></div></td></tr></table></figure><h3 id="创建并编辑demo-openrc文件"><a href="#创建并编辑demo-openrc文件" class="headerlink" title="创建并编辑demo-openrc文件"></a>创建并编辑demo-openrc文件</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cat demo-openrc <br>export OS_PROJECT_DOMAIN_NAME=Default<br>export OS_USER_DOMAIN_NAME=Default<br>export OS_PROJECT_NAME=myproject<br>export OS_USERNAME=myuser<br>export OS_PASSWORD=MYUSER<br>export OS_AUTH_URL=http://controller:5000/v3<br>export OS_IDENTITY_API_VERSION=3<br>export OS_IMAGE_API_VERSION=2<br></code></pre></div></td></tr></table></figure><h3 id="验证环境变量是否成功"><a href="#验证环境变量是否成功" class="headerlink" title="验证环境变量是否成功"></a>验证环境变量是否成功</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">source admin-openrc<br>openstack token issue<br></code></pre></div></td></tr></table></figure><p>### 注意环境变量问题:先取消前面设置的环境变量,否则会报错###</p><h2 id="Glance镜像服务"><a href="#Glance镜像服务" class="headerlink" title="Glance镜像服务"></a>Glance镜像服务</h2><p><strong>glance-api</strong></p><p>接收镜像API的调用，诸如镜像发现、恢复、存储。</p><p><strong>glance-registry</strong></p><p>存储、处理和恢复镜像的元数据，元数据包括项诸如大小和类型。</p><h3 id="在控制节点创建镜像服务数据库-controller"><a href="#在控制节点创建镜像服务数据库-controller" class="headerlink" title="在控制节点创建镜像服务数据库(controller)"></a>在控制节点创建镜像服务数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建glance数据库<br>CREATE DATABASE glance;<br>c.创建glance数据库用户，使其可以对glance数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h3 id="在keystone创建glance用户关联角色"><a href="#在keystone创建glance用户关联角色" class="headerlink" title="在keystone创建glance用户关联角色"></a>在keystone创建glance用户关联角色</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password GLANCE_PASS glance<br>openstack role add --project service --user glance admin<br></code></pre></div></td></tr></table></figure><h3 id="在keystone创建服务和注册api"><a href="#在keystone创建服务和注册api" class="headerlink" title="在keystone创建服务和注册api"></a>在keystone创建服务和注册api</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name glance \<br>--description &quot;OpenStack Image&quot; image<br>openstack endpoint create --region RegionOne \<br>  image public http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image internal http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image admin http://controller:9292<br></code></pre></div></td></tr></table></figure><h3 id="安装glance软件包"><a href="#安装glance软件包" class="headerlink" title="安装glance软件包"></a>安装glance软件包</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-glance<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p><strong>&#x2F;etc&#x2F;glance&#x2F;glance-api.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/glance/glance-api.conf&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/glance/glance-api.conf.bak &gt;/etc/glance/glance-api.conf<br><br>openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:5000<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS<br>openstack-config --set /etc/glance/glance-api.conf  paste_deploy flavor keystone<br>openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http<br>openstack-config --set /etc/glance/glance-api.conf glance_store default_store file<br>openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">chmod 777 /etc/glance/glance-registry.conf<br></code></pre></div></td></tr></table></figure><h3 id="同步glance数据库"><a href="#同步glance数据库" class="headerlink" title="同步glance数据库"></a>同步glance数据库</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看glance库是否有数据--><!--忽略警告--><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable openstack-glance-api.service<br>systemctl start openstack-glance-api.service<br></code></pre></div></td></tr></table></figure><h3 id="下载测试镜像cirros"><a href="#下载测试镜像cirros" class="headerlink" title="下载测试镜像cirros"></a>下载测试镜像cirros</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img<br></code></pre></div></td></tr></table></figure><p>###下载不了多试几次###</p><h3 id="上传镜像测试"><a href="#上传镜像测试" class="headerlink" title="上传镜像测试"></a>上传镜像测试</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack image create &quot;cirros&quot;  --file cirros-0.3.4-x86_64-disk.img  --disk-format qcow2 --container-format bare  --public<br></code></pre></div></td></tr></table></figure><h2 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h2><h4 id="在控制节点创建placement数据库-controller"><a href="#在控制节点创建placement数据库-controller" class="headerlink" title="在控制节点创建placement数据库(controller)"></a>在控制节点创建placement数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建glance数据库<br>CREATE DATABASE placement;<br>c.创建glance数据库用户，使其可以对glance数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;PLACEMENT_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;PLACEMENT_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户关联角色"><a href="#在keystone创建系统用户关联角色" class="headerlink" title="在keystone创建系统用户关联角色"></a>在keystone创建系统用户关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password PLACEMENT_PASS placement<br>openstack role add --project service --user placement admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api"><a href="#在keystone上创建服务和注册api" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name placement --description &quot;Placement API&quot; placement<br><br>openstack endpoint create --region RegionOne \<br>  placement public http://controller:8778<br><br>openstack endpoint create --region RegionOne \<br>  placement internal http://controller:8778<br>  <br>openstack endpoint create --region RegionOne \<br>  placement admin http://controller:8778<br></code></pre></div></td></tr></table></figure><h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-placement-api<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-2"><a href="#修改配置文件-2" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;placement&#x2F;placement.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/placement/placement.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/placement/placement.conf.bak &gt;/etc/placement/placement.conf<br><br>openstack-config --set /etc/placement/placement.conf placement_database connection mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement <br>openstack-config --set /etc/placement/placement.conf api auth_strategy keystone<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken auth_url http://controller:5000/v3<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken project_domain_name Default<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken user_domain_name Default<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken project_name service<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken username placement<br>openstack-config --set /etc/placement/placement.conf keystone_authtoken password PLACEMENT_PASS<br></code></pre></div></td></tr></table></figure><h4 id="同步数据库"><a href="#同步数据库" class="headerlink" title="同步数据库"></a>同步数据库</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;placement-manage db sync&quot; placement<br></code></pre></div></td></tr></table></figure><h4 id="编辑00-placement-api-conf文件"><a href="#编辑00-placement-api-conf文件" class="headerlink" title="编辑00-placement-api.conf文件"></a>编辑00-placement-api.conf文件</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##在结尾添加</span></span><br>vim /etc/httpd/conf.d/00-placement-api.conf<br>....<br>&lt;Directory /usr/bin&gt;<br>&lt;IfVersion &gt;= 2.4&gt;<br>   Require all granted<br>&lt;/IfVersion&gt;<br>&lt;IfVersion &lt; 2.4&gt;<br>   Order allow,deny<br>   Allow from all<br>&lt;/IfVersion&gt;<br>&lt;/Directory&gt;<br></code></pre></div></td></tr></table></figure><h4 id="重启httd服务"><a href="#重启httd服务" class="headerlink" title="重启httd服务"></a>重启httd服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart httpd<br></code></pre></div></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller placement]# placement-status upgrade check<br>+----------------------------------+<br>| Upgrade Check Results            |<br>+----------------------------------+<br>| Check: Missing Root Provider IDs |<br>| Result: Success                  |<br>| Details: None                    |<br>+----------------------------------+<br>| Check: Incomplete Consumers      |<br>| Result: Success                  |<br>| Details: None                    |<br>+----------------------------------+<br></code></pre></div></td></tr></table></figure><h2 id="Nova计算服务"><a href="#Nova计算服务" class="headerlink" title="Nova计算服务"></a>Nova计算服务</h2><p>nova-api:接受响应所有的计算服务请求，管理虚拟机(云主机)生命周期</p><p>nova-compute (多个):真正管理虚拟机(nova-compute调用libvirt)</p><p>nova-scheduler:nova调度器（挑选出最合适的nova-compute来创建虚机)</p><p>nova-conductor:帮助nova-compute代理修改数据库中虚拟机的状态</p><p>nova-network早期openstack版本管理虚拟机的网络(已弃用,neutron)</p><p>nova-consoleauth和nova-novncproxy: web版的vnc来直接操作云主机</p><p>novncproxy:web版vnc客户端</p><p>nova-api-metadata:接受来自虚拟机发送的元数据请求(配合neutron-metadata-agent,来虚拟机定制化)</p><h3 id="controller-3"><a href="#controller-3" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建nova服务数据库-controller"><a href="#在控制节点创建nova服务数据库-controller" class="headerlink" title="在控制节点创建nova服务数据库(controller)"></a>在控制节点创建nova服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建nova_api,nova,nova_cell0数据库<br>CREATE DATABASE nova_api;<br>CREATE DATABASE nova;<br>CREATE DATABASE nova_cell0;<br>c.创建nova_api，nova数据库用户，使其可以对nova_api,nova数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户（glance，nova，neutron）关联角色"><a href="#在keystone创建系统用户（glance，nova，neutron）关联角色" class="headerlink" title="在keystone创建系统用户（glance，nova，neutron）关联角色"></a>在keystone创建系统用户（glance，nova，neutron）关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password NOVA_PASS nova<br>openstack role add --project service --user nova admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api-1"><a href="#在keystone上创建服务和注册api-1" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name nova --description &quot;OpenStack Compute&quot; compute<br>openstack endpoint create --region RegionOne \<br>  compute public http://controller:8774/v2.1<br>openstack endpoint create --region RegionOne \<br>  compute internal http://controller:8774/v2.1<br>openstack endpoint create --region RegionOne \<br>  compute admin http://controller:8774/v2.1<br></code></pre></div></td></tr></table></figure><h4 id="安装相关服务软件包"><a href="#安装相关服务软件包" class="headerlink" title="安装相关服务软件包"></a>安装相关服务软件包</h4><p>openstack-nova-conductor 负责数据库<br>openstack-nova-novncproxy  负责云主机连接<br>openstack-nova-scheduler  负责调度调度</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-3"><a href="#修改配置文件-3" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/nova/nova.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/nova/nova.conf.bak &gt;/etc/nova/nova.conf<br><br>openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata<br>openstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api<br>openstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova<br>openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller:5672/<br>openstack-config --set /etc/nova/nova.conf api auth_strategy keystone<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken www_authenticate_uri http://controller:5000/<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:5000/<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name Default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name Default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 172.16.100.28###替换自己的IP!!!<br>openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True<br>openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver<br>openstack-config --set /etc/nova/nova.conf vnc enabled true<br>openstack-config --set /etc/nova/nova.conf vnc server_listen &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf vnc server_proxyclient_address &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292<br>openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp<br>openstack-config --set /etc/nova/nova.conf placement region_name RegionOne<br>openstack-config --set /etc/nova/nova.conf placement project_domain_name Default<br>openstack-config --set /etc/nova/nova.conf placement project_name service<br>openstack-config --set /etc/nova/nova.conf placement auth_type password<br>openstack-config --set /etc/nova/nova.conf placement user_domain_name Default<br>openstack-config --set /etc/nova/nova.conf placement auth_url http://controller:5000/v3<br>openstack-config --set /etc/nova/nova.conf placement username placement<br>openstack-config --set /etc/nova/nova.conf placement password PLACEMENT_PASS<br></code></pre></div></td></tr></table></figure><h4 id="同步数据库-1"><a href="#同步数据库-1" class="headerlink" title="同步数据库"></a>同步数据库</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova<br>su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova<br>su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova<br>su -s /bin/sh -c &quot;nova-manage db sync&quot; nova<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看nova库是否有数据--><!--忽略警告--><h4 id="验证-nova-cell0-和-cell1-是否正确注册"><a href="#验证-nova-cell0-和-cell1-是否正确注册" class="headerlink" title="验证 nova cell0 和 cell1 是否正确注册"></a>验证 nova cell0 和 cell1 是否正确注册</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova<br>+-------+--------------------------------------+------------------------------------------+-------------------------------------------------+----------+<br>|  Name |                 UUID                 |              Transport URL               |               Database Connection               | Disabled |<br>+-------+--------------------------------------+------------------------------------------+-------------------------------------------------+----------+<br>| cell0 | 00000000-0000-0000-0000-000000000000 |                  none:/                  | mysql+pymysql://nova:****@controller/nova_cell0 |  False   |<br>| cell1 | e9c5a4d7-880f-4783-958b-85d44bad22b1 | rabbit://openstack:****@controller:5672/ |    mysql+pymysql://nova:****@controller/nova    |  False   |<br>+-------+--------------------------------------+------------------------------------------+-------------------------------------------------+----------+<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable \<br>    openstack-nova-api.service \<br>    openstack-nova-scheduler.service \<br>    openstack-nova-conductor.service \<br>    openstack-nova-novncproxy.service<br> systemctl start \<br>    openstack-nova-api.service \<br>    openstack-nova-scheduler.service \<br>    openstack-nova-conductor.service \<br>    openstack-nova-novncproxy.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-3"><a href="#compute-3" class="headerlink" title="compute"></a>compute</h3><h4 id="安装软件包-1"><a href="#安装软件包-1" class="headerlink" title="安装软件包"></a>安装软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-nova-compute openstack-utils.noarch<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-4"><a href="#修改配置文件-4" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/nova/nova.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/nova/nova.conf.bak &gt;/etc/nova/nova.conf<br><br>openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata<br>openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller<br>openstack-config --set /etc/nova/nova.conf api auth_strategy keystone<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:5000/<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name Default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name Default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 172.16.100.29   ###替换自己compute IP<br>openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True<br>openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver<br>openstack-config --set /etc/nova/nova.conf vnc enabled True<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://172.16.100.28:6080/vnc_auto.html<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##服务器组件监听所有的 IP 地址，而代理组件仅仅监听计算节点管理网络接口的 IP 地址。基本的 URL 指示您可以使用 web 浏览器访问位于该计算节点上实例的远程控制台的位置。</span></span><br>openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292<br>openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp<br>openstack-config --set /etc/nova/nova.conf placement region_name RegionOne<br>openstack-config --set /etc/nova/nova.conf placement project_domain_name Default<br>openstack-config --set /etc/nova/nova.conf placement project_name service<br>openstack-config --set /etc/nova/nova.conf placement auth_type password<br>openstack-config --set /etc/nova/nova.conf placement user_domain_name Default<br>openstack-config --set /etc/nova/nova.conf placement auth_url http://controller:5000/v3<br>openstack-config --set /etc/nova/nova.conf placement username placement<br>openstack-config --set /etc/nova/nova.conf placement password PLACEMENT_PASS<br></code></pre></div></td></tr></table></figure><h4 id="确定您的计算节点是否支持虚拟机的硬件加速"><a href="#确定您的计算节点是否支持虚拟机的硬件加速" class="headerlink" title="确定您的计算节点是否支持虚拟机的硬件加速"></a>确定您的计算节点是否支持虚拟机的硬件加速</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">egrep -c &#x27;(vmx|svm)&#x27; /proc/cpuinfo<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##如不为0，则您的计算节点支持硬件加速，这通常不需要额外的配置</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##如果返回值为0，则您的计算节点不支持硬件加速，您必须配置libvirt为使用 QEMU 而不是 KVM，执行以下命令！</span></span><br>openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-2"><a href="#启动服务-2" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable libvirtd.service openstack-nova-compute.service<br>systemctl start libvirtd.service openstack-nova-compute.service<br></code></pre></div></td></tr></table></figure><h3 id="在控制节点查看"><a href="#在控制节点查看" class="headerlink" title="在控制节点查看"></a>在控制节点查看</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# openstack compute service list --service nova-compute<br>+----+--------------+---------+------+---------+-------+----------------------------+<br>| ID | Binary       | Host    | Zone | Status  | State | Updated At                 |<br>+----+--------------+---------+------+---------+-------+----------------------------+<br>| 10 | nova-compute | compute | nova | enabled | up    | 2021-12-17T06:59:11.000000 |<br>+----+--------------+---------+------+---------+-------+----------------------------+<br></code></pre></div></td></tr></table></figure><h3 id="发现计算节点主机"><a href="#发现计算节点主机" class="headerlink" title="发现计算节点主机"></a>发现计算节点主机</h3><p><strong>###添加新计算节点时，您必须在控制器节点上运行以注册这些新计算节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova<br>Found 2 cell mappings.<br>Skipping cell0 since it does not contain hosts.<br>Getting computes from cell &#x27;cell1&#x27;: e9c5a4d7-880f-4783-958b-85d44bad22b1<br>Checking host mapping for compute host &#x27;compute&#x27;: b5a4c6b3-ad48-4e74-b5f4-76cb6f55f8d3<br>Creating host mapping for compute host &#x27;compute&#x27;: b5a4c6b3-ad48-4e74-b5f4-76cb6f55f8d3<br>Found 1 unmapped computes in cell: e9c5a4d7-880f-4783-958b-85d44bad22b1<br></code></pre></div></td></tr></table></figure><p><strong>###或者配置适当的间隔执行</strong> </p><p>#这里配置的是300秒，可以自行设置</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack-config --set /etc/nova/nova.conf scheduler discover_hosts_in_cells_interval 300<br></code></pre></div></td></tr></table></figure><h3 id="查看nova是否正常"><a href="#查看nova是否正常" class="headerlink" title="查看nova是否正常"></a>查看nova是否正常</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# nova service-list<br>+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+-----------------+-------------+<br>| Id                                   | Binary         | Host       | Zone     | Status  | State | Updated_at                 | Disabled Reason | Forced down |<br>+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+-----------------+-------------+<br>| c606ddf6-2213-459e-b07e-e8219c9c24fc | nova-conductor | controller | internal | enabled | up    | 2021-12-17T07:13:17.000000 | -               | False       |<br>| 6608eb09-0130-4cdd-8311-f53082e14508 | nova-scheduler | controller | internal | enabled | up    | 2021-12-17T07:13:18.000000 | -               | False       |<br>| 2012503b-9c09-4575-96e1-991b1f8dbf5e | nova-compute   | compute    | nova     | enabled | up    | 2021-12-17T07:13:21.000000 | -               | False       |<br>+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+-----------------+-------------+<br><br></code></pre></div></td></tr></table></figure><h2 id="Neutron网络服务"><a href="#Neutron网络服务" class="headerlink" title="Neutron网络服务"></a>Neutron网络服务</h2><p>neutron-server端(9696)api:接受和响应外部的网络管理请求</p><p>neutron-linuxbridge-agent :负责创建桥接网卡</p><p>neutron-dhcp-agent:负责分配IP</p><p>neutron-metadata-agent:配合nova-metadata-api实现虚拟机的定制化操作</p><p>L3-agent：实现三层网络vxlan(网络层)</p><h3 id="controller-4"><a href="#controller-4" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建neutron服务数据库-controller"><a href="#在控制节点创建neutron服务数据库-controller" class="headerlink" title="在控制节点创建neutron服务数据库(controller)"></a>在控制节点创建neutron服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建neutron数据库<br>CREATE DATABASE neutron;<br>c.创建neutron数据库用户，使其可以对neutron数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NEUTRON_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NEUTRON_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户-glance-nova-neutron-关联角色"><a href="#在keystone创建系统用户-glance-nova-neutron-关联角色" class="headerlink" title="在keystone创建系统用户(glance, nova, neutron)关联角色"></a>在keystone创建系统用户(glance, nova, neutron)关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password NEUTRON_PASS neutron<br>openstack role add --project service --user neutron admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api-2"><a href="#在keystone上创建服务和注册api-2" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"> openstack service create --name neutron \<br>  --description &quot;OpenStack Networking&quot; network<br>openstack endpoint create --region RegionOne \<br>  network public http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network internal http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network admin http://controller:9696<br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包"><a href="#安装服务相应软件包" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum  -y install openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-5"><a href="#修改配置文件-5" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>配置服务组件</strong></p><p><strong>a：&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/neutron.conf&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/neutron/neutron.conf.bak &gt;/etc/neutron/neutron.conf<br><br>openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins  <br>openstack-config --set /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True<br>openstack-config --set /etc/neutron/neutron.conf  nova auth_url http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf  nova auth_type password<br>openstack-config --set /etc/neutron/neutron.conf  nova project_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf  nova user_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf  nova region_name RegionOne<br>openstack-config --set /etc/neutron/neutron.conf  nova project_name service<br>openstack-config --set /etc/neutron/neutron.conf  nova username nova<br>openstack-config --set /etc/neutron/neutron.conf  nova password NOVA_PASS<br>openstack-config --set /etc/neutron/neutron.conf  oslo_concurrency lock_path /var/lib/neutron/tmp<br></code></pre></div></td></tr></table></figure><p><strong>配置 Modular Layer 2 (ML2) 插件</strong></p><p><strong>b: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/ml2_conf.ini&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/neutron/plugins/ml2/ml2_conf.ini.bak &gt;/etc/neutron/plugins/ml2/ml2_conf.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types <br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True<br></code></pre></div></td></tr></table></figure><p><strong>配置Linuxbridge代理</strong></p><p><strong>c: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak &gt;/etc/neutron/plugins/ml2/linuxbridqe_agent.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens3 ###替换自己的网卡名称<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<br></code></pre></div></td></tr></table></figure><p><strong>配置DHCP代理</strong></p><p><strong>d: &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/dhcp_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27;  /etc/neutron/dhcp_agent.ini.bak &gt;/etc/neutron/dhcp_agent.ini<br><br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver linuxbridge<br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq<br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata True<br></code></pre></div></td></tr></table></figure><h4 id="配置内核"><a href="#配置内核" class="headerlink" title="配置内核"></a>配置内核</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">echo -e &quot;net.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1&quot; &gt;&gt; /etc/sysctl.conf<br><br>[root@controller ~]# modprobe br_netfilter<br>[root@controller ~]# sysctl -p<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br></code></pre></div></td></tr></table></figure><p><strong>配置元数据代理</strong></p><p><strong>e：&#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/metadata_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27;  /etc/neutron/metadata_agent.ini.bak &gt; /etc/neutron/metadata_agent.ini<br><br>openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_host controller<br>openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET<br></code></pre></div></td></tr></table></figure><p><strong>添加控制节点网络服务</strong></p><p><strong>f：&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack-config --set  /etc/nova/nova.conf neutron url http://controller:9696<br>openstack-config --set  /etc/nova/nova.conf neutron auth_url http://controller:5000<br>openstack-config --set  /etc/nova/nova.conf neutron auth_type  password<br>openstack-config --set  /etc/nova/nova.conf neutron project_domain_name  default<br>openstack-config --set  /etc/nova/nova.conf neutron user_domain_name  default<br>openstack-config --set  /etc/nova/nova.conf neutron region_name   RegionOne<br>openstack-config --set  /etc/nova/nova.conf neutron project_name  service<br>openstack-config --set  /etc/nova/nova.conf neutron username  neutron<br>openstack-config --set  /etc/nova/nova.conf neutron password  NEUTRON_PASS<br>openstack-config --set  /etc/nova/nova.conf neutron service_metadata_proxy  True<br>openstack-config --set  /etc/nova/nova.conf neutron metadata_proxy_shared_secret  METADATA_SECRET<br></code></pre></div></td></tr></table></figure><h4 id="同步neutron数据库"><a href="#同步neutron数据库" class="headerlink" title="同步neutron数据库"></a><strong>同步neutron数据库</strong></h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini<br>su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf \<br>  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron<br></code></pre></div></td></tr></table></figure><!--可以ok即成功--><!--同步后进入数据库查看neutron库是否有数据--><!--忽略警告--><h4 id="启动服务-3"><a href="#启动服务-3" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart openstack-nova-api.service<br>systemctl enable neutron-server.service \<br>  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \<br>  neutron-metadata-agent.service<br>systemctl start neutron-server.service \<br>  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \<br>  neutron-metadata-agent.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-4"><a href="#compute-4" class="headerlink" title="compute"></a>compute</h3><h4 id="在计算节点安装组件-compute"><a href="#在计算节点安装组件-compute" class="headerlink" title="在计算节点安装组件(compute)"></a>在计算节点安装组件(compute)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-neutron-linuxbridge ebtables ipset<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-6"><a href="#修改配置文件-6" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>a.&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/neutron.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/neutron.conf.bak &gt;/etc/neutron/neutron.conf<br><br>openstack-config --set /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy  keystone<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type    password<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name  default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name    default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name    service<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username    neutron<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password    NEUTRON_PASS<br>openstack-config --set /etc/neutron/neutron.conf oslo_concurreny lock_path    /var/lib/neutron/tmp<br></code></pre></div></td></tr></table></figure><p><strong>配置Linuxbridge代理</strong></p><p><strong>b: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak &gt;/etc/neutron/plugins/ml2/linuxbridqe_agent.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens3  ###替换自己的网卡名称<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroupfirewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<br></code></pre></div></td></tr></table></figure><h4 id="配置内核-1"><a href="#配置内核-1" class="headerlink" title="配置内核"></a>配置内核</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">echo -e &quot;net.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1&quot; &gt;&gt; /etc/sysctl.conf<br><br>[root@controller ~]# modprobe br_netfilter<br>[root@controller ~]# sysctl -p<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br></code></pre></div></td></tr></table></figure><p><strong>添加计算节点网络服务</strong></p><p><strong>c：&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack-config --set  /etc/nova/nova.conf neutron url  http://controller:9696<br>openstack-config --set  /etc/nova/nova.conf neutron auth_url http://controller:5000<br>openstack-config --set  /etc/nova/nova.conf neutron auth_type  password<br>openstack-config --set  /etc/nova/nova.conf neutron project_domain_name  default<br>openstack-config --set  /etc/nova/nova.conf neutron user_domain_name   default<br>openstack-config --set  /etc/nova/nova.conf neutron region_name   RegionOne<br>openstack-config --set  /etc/nova/nova.conf neutron project_name  service<br>openstack-config --set  /etc/nova/nova.conf neutron username  neutron<br>openstack-config --set  /etc/nova/nova.conf neutron password  NEUTRON_PASS<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-4"><a href="#启动服务-4" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart openstack-nova-compute.service<br>systemctl enable neutron-linuxbridge-agent.service<br>systemctl start neutron-linuxbridge-agent.service<br></code></pre></div></td></tr></table></figure><h3 id="查看服务（controller）"><a href="#查看服务（controller）" class="headerlink" title="查看服务（controller）"></a>查看服务（controller）</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# openstack network agent list<br>+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+<br>| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |<br>+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+<br>| 1a758c8f-87b1-4e43-9f7b-445a8d38c454 | DHCP agent         | controller | nova              | :-)   | UP    | neutron-dhcp-agent        |<br>| 590d524d-6188-4e09-a5f8-25aa83568192 | Linux bridge agent | controller | None              | :-)   | UP    | neutron-linuxbridge-agent |<br>| add2e0e2-71ba-4e29-b454-77435f1266e2 | Metadata agent     | controller | None              | :-)   | UP    | neutron-metadata-agent    |<br>| fad9d9ca-85b4-4d12-9bf8-852f59e1ed0f | Linux bridge agent | compute    | None              | :-)   | UP    | neutron-linuxbridge-agent |<br>+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+<br><br></code></pre></div></td></tr></table></figure><h2 id="Dashboard服务"><a href="#Dashboard服务" class="headerlink" title="Dashboard服务"></a>Dashboard服务</h2><p>(根据情况确定安装控制节点还是计算节点）</p><blockquote><p>此次安装在compute上</p></blockquote><h3 id="安装openstack-dashboard"><a href="#安装openstack-dashboard" class="headerlink" title="安装openstack-dashboard"></a>安装openstack-dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-dashboard<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件-7"><a href="#修改配置文件-7" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p><strong>&#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在 controller 节点上配置仪表盘以使用 OpenStack 服务</span><br>OPENSTACK_HOST = &quot;controller&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">允许所有主机访问仪表板</span><br>ALLOWED_HOSTS = [&#x27;*&#x27;, ]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置 memcached 会话存储服务</span><br>CACHES = &#123;<br>  &#x27;default&#x27;: &#123;<br>        &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,<br>         &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,<br>   &#125;<br>&#125;<br>SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cache&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用第3版认证API</span><br>OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用对域的支持</span><br>OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置API版本</span><br>OPENSTACK_API_VERSIONS = &#123;<br>   &quot;identity&quot;: 3,<br>    &quot;image&quot;: 2,<br>      &quot;volume&quot;: 3,<br>&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">WEB界面配置</span><br>WEBROOT = &quot;/dashboard&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过仪表盘创建用户时的默认域配置为 default</span><br>OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;Default&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过仪表盘创建的用户默认角色配置为 user</span><br>OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果您选择网络参数1，禁3层网络服务：</span><br>OPENSTACK_NEUTRON_NETWORK = &#123;<br>    ...<br>&#x27;enable_router&#x27;: False,<br>&#x27;enable_quotas&#x27;: False,<br>&#x27;enable_distributed_router&#x27;: False,<br>&#x27;enable_ha_router&#x27;: False,<br>&#x27;enable_lb&#x27;: False,<br>&#x27;enable_firewall&#x27;: False,<br>&#x27;enable_vpn&#x27;: False,<br>&#x27;enable_fip_topology_check&#x27;: False,<br>&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以选择性地配置时区：</span><br>TIME_ZONE = &quot;Asia/Shanghai&quot;<br></code></pre></div></td></tr></table></figure><p><strong>&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-dashboard.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sed -i &quot;4i WSGIApplicationGroup %&#123;GLOBAL&#125;&quot; /etc/httpd/conf.d/openstack-dashboard.conf<br></code></pre></div></td></tr></table></figure><h3 id="启动服务-5"><a href="#启动服务-5" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart httpd.service<br></code></pre></div></td></tr></table></figure><h3 id="控制节点"><a href="#控制节点" class="headerlink" title="控制节点"></a>控制节点</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart memcached.service<br></code></pre></div></td></tr></table></figure><h2 id="Cinder块存储服务"><a href="#Cinder块存储服务" class="headerlink" title="Cinder块存储服务"></a>Cinder块存储服务</h2><p>cinder-volume LVM,nfs,gfs,ceph</p><p>cinder-api:接收外部的api请求</p><p>cinder-volume:提供存储空间</p><p>cinder-scheduler调度器,决定将要分配的空间由哪一个cinder-volume提供</p><p>cinder-backup备份存储</p><h3 id="controller-5"><a href="#controller-5" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建Cinder服务数据库-controller"><a href="#在控制节点创建Cinder服务数据库-controller" class="headerlink" title="在控制节点创建Cinder服务数据库(controller)"></a>在控制节点创建Cinder服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建cinder数据库<br>CREATE DATABASE cinder;<br>c.创建cinder数据库用户，使其可以对cinder数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;CINDER_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;CINDER_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户-glance-nova-neutron-cinder-关联角色"><a href="#在keystone创建系统用户-glance-nova-neutron-cinder-关联角色" class="headerlink" title="在keystone创建系统用户(glance, nova, neutron,cinder)关联角色"></a>在keystone创建系统用户(glance, nova, neutron,cinder)关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password CINDER_PASS cinder<br>openstack role add --project service --user cinder admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api-3"><a href="#在keystone上创建服务和注册api-3" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name cinderv2 \<br>  --description &quot;OpenStack Block Storage&quot; volumev2<br>openstack service create --name cinderv3 \<br>  --description &quot;OpenStack Block Storage&quot; volumev3<br>  <br>openstack endpoint create --region RegionOne \<br>  volumev2 public http://controller:8776/v2/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 internal http://controller:8776/v2/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 admin http://controller:8776/v2/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev3 public http://controller:8776/v3/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev3 internal http://controller:8776/v3/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev3 admin http://controller:8776/v3/%\(project_id\)s<br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包-1"><a href="#安装服务相应软件包-1" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-cinder<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-8"><a href="#修改配置文件-8" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;cinder&#x2F;cinder.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/cinder/cinder.conf&#123;,.bak&#125;<br>grep -Ev &#x27;^$|#&#x27; /etc/cinder/cinder.conf.bak &gt;/etc/cinder/cinder.conf<br><br>openstack-config --set /etc/cinder/cinder.conf database connection    mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers   controller:11211<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type  password<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name   default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name   default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name   service<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username    cinder<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password    CINDER_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip  172.16.100.28 ###替换自己IP<br>openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path  /var/lib/cinder/tmp<br></code></pre></div></td></tr></table></figure><h4 id="同步cinder数据库"><a href="#同步cinder数据库" class="headerlink" title="同步cinder数据库"></a>同步cinder数据库</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看cinder库是否有数据--><!--忽略警告--><p>修改nova配置文件</p><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino">openstack-config --set /etc/cinder/cinder.conf cinder os_region_name  RegionOne<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-6"><a href="#启动服务-6" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart openstack-nova-api.service<br>systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service<br>systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-5"><a href="#compute-5" class="headerlink" title="compute"></a>compute</h3><h4 id="在计算节点安装存储节点-compute"><a href="#在计算节点安装存储节点-compute" class="headerlink" title="在计算节点安装存储节点(compute)"></a>在计算节点安装存储节点(compute)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装支持的工具包</span><br>yum -y install lvm2 device-mapper-persistent-data<br>systemctl enable lvm2-lvmetad.service<br>systemctl start lvm2-lvmetad.service<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">在计算节点新建一块硬盘<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##如果在VM添加的硬盘没有扫描出来,用以下命令</span></span><br>echo &#x27;- - -&#x27; &gt;/sys/class/scsi_host/host0/scan<br>echo &#x27;- - -&#x27; &gt;/sys/class/scsi_host/host1/scan<br>echo &#x27;- - -&#x27; &gt;/sys/class/scsi_host/host2/scan<br><br>[root@compute ~]# lsblk<br>NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sr0              11:0    1 1024M  0 rom  <br>vda             252:0    0   80G  0 disk <br>├─vda1          252:1    0    1G  0 part /boot<br>└─vda2          252:2    0   79G  0 part <br>  ├─centos-root 253:0    0 49.9G  0 lvm  /<br>  ├─centos-swap 253:1    0  4.8G  0 lvm  [SWAP]<br>  └─centos-home 253:2    0 24.3G  0 lvm  /home<br>vdb             252:16   0   80G  0 disk  ###新添加的硬盘<br></code></pre></div></td></tr></table></figure><h4 id="创建LVM-物理卷"><a href="#创建LVM-物理卷" class="headerlink" title="创建LVM 物理卷"></a>创建LVM 物理卷</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]#  pvcreate /dev/vdb<br>  Physical volume &quot;/dev/vdb&quot; successfully created.<br></code></pre></div></td></tr></table></figure><h4 id="创建-LVM-卷组-cinder-volumes"><a href="#创建-LVM-卷组-cinder-volumes" class="headerlink" title="创建 LVM 卷组 cinder-volumes"></a>创建 LVM 卷组 cinder-volumes</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# vgcreate cinder-volumes /dev/vdb<br>  Volume group &quot;cinder-volumes&quot; successfully created<br></code></pre></div></td></tr></table></figure><h4 id="添加一个过滤器-只有实例可以访问块存储卷组"><a href="#添加一个过滤器-只有实例可以访问块存储卷组" class="headerlink" title="添加一个过滤器(只有实例可以访问块存储卷组)"></a>添加一个过滤器(只有实例可以访问块存储卷组)</h4><p><strong>&#x2F;etc&#x2F;lvm&#x2F;lvm.conf</strong> </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##大概文件130行左右</span></span><br>filter = [ &quot;a/vdb/&quot;, &quot;r/.*/&quot;]<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####多盘######filter = [ &quot;a/vdb/&quot;, &quot;a/vdc/&quot;, &quot;r/.*/&quot;]</span></span><br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包-2"><a href="#安装服务相应软件包-2" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-cinder targetcli python-keystone<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-9"><a href="#修改配置文件-9" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;cinder&#x2F;cinder.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/cinder/cinder.conf&#123;,.bak&#125;<br>grep -Ev &#x27;^$|#&#x27; /etc/cinder/cinder.conf.bak &gt;/etc/cinder/cinder.conf<br><br>openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken www_authenticate_uri http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password CINDER_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip 172.16.100.29 ###替换自己IP<br>openstack-config --set /etc/cinder/cinder.conf lvm volume_driver cinder.volume.drivers.lvm.LVMVolumeDriver<br>openstack-config --set /etc/cinder/cinder.conf lvm volume_group cinder-volumes<br>openstack-config --set /etc/cinder/cinder.conf lvm target_protocol  iscsi<br>openstack-config --set /etc/cinder/cinder.conf lvm target_helper lioadm<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT enabled_backends lvm<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT glance_api_servers http://controller:9292<br>openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-7"><a href="#启动服务-7" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable openstack-cinder-volume.service target.service<br>systemctl start openstack-cinder-volume.service target.service<br></code></pre></div></td></tr></table></figure><h4 id="在controller检查是否成功"><a href="#在controller检查是否成功" class="headerlink" title="在controller检查是否成功"></a>在controller检查是否成功</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]#  cinder service-list<br>+------------------+-------------+------+---------+-------+----------------------------+---------+---------+<br>| Binary           | Host        | Zone | Status  | State | Updated_at                 | Cluster | Disabled Reason | Backend State |<br>+------------------+-------------+------+---------+-------+----------------------------+---------+---------+<br>| cinder-scheduler | controller  | nova | enabled | up    | 2021-12-17T12:06:39.000000 | -       | -               |               |<br>| cinder-volume    | compute@lvm | nova | enabled | up    | 2021-12-17T12:06:37.000000 | -       | -               | up            |<br>+------------------+-------------+------+---------+-------+----------------------------+---------+---------+<br><br></code></pre></div></td></tr></table></figure><h2 id="启动一个实例"><a href="#启动一个实例" class="headerlink" title="启动一个实例"></a>启动一个实例</h2><h3 id="1-创建网络"><a href="#1-创建网络" class="headerlink" title="1.创建网络"></a>1.创建网络</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">neutron net-create --shared --provider:physical_network provider  --provider:network_type flat zzz<br>neutron subnet-create --name  zzz123\<br>  --allocation-pool start=172.16.100.101,end=172.16.100.250 \<br>  --dns-nameserver 114.114.114.114 --gateway 172.16.100.254 \<br>   zzz 172.16.100.0/24<br><br>openstack network create --share --provider-physical-network provider --provider-network-type flat zzz<br>openstack subnet create --ip-version 4 --allocation-pool start=172.16.100.101,end=172.16.100.250 --dns-nameserver 114.114.114.114 --gateway 172.16.100.254 --subnet-range 172.16.100.0/24 --network zzz zzz123<br></code></pre></div></td></tr></table></figure><h3 id="2-创建云主机的硬件配置方案"><a href="#2-创建云主机的硬件配置方案" class="headerlink" title="2.创建云主机的硬件配置方案"></a>2.创建云主机的硬件配置方案</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack flavor create --id 0 --vcpus 1 --ram 1024 --disk 10 m1.nano<br></code></pre></div></td></tr></table></figure><h3 id="3-创建密钥对"><a href="#3-创建密钥对" class="headerlink" title="3.创建密钥对"></a>3.创建密钥对</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ssh-keygen -q -N &quot;&quot; -f ~/.ssh/id_rsa<br>openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey<br>验证是否添加:  openstack keypair list<br></code></pre></div></td></tr></table></figure><h3 id="4-创建安全组规则"><a href="#4-创建安全组规则" class="headerlink" title="4.创建安全组规则"></a>4.创建安全组规则</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">允许 ICMP (ping)：<br>openstack security group rule create --proto icmp default<br>允许安全 shell (SSH) 的访问：<br>openstack security group rule create --proto tcp --dst-port 22 default<br></code></pre></div></td></tr></table></figure><h3 id="5-启动一个实例"><a href="#5-启动一个实例" class="headerlink" title="5.启动一个实例"></a>5.启动一个实例</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">查看网络id:  neutron net-list<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##网络id=PROVIDER_NET_ID</span></span><br>创建实例:<br>openstack server create --flavor m1.nano --image cirros \<br>  --nic net-id=PROVIDER_NET_ID --security-group default \<br>  --key-name mykey provider-instance<br>  <br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##查看已创建实例###</span></span><br>[root@controller ~]# openstack server list<br>+--------------------------------------+-------------------+--------+--------------------+<br>| ID                                   | Name              | Status | Networks           |<br>+--------------------------------------+-------------------+--------+--------------------+<br>| f6fa8d1a-13e7-46c9-b5e3-78cfdc3497d5 | provider-instance | ACTIVE | zzz=172.16.100.102 |<br>+--------------------------------------+-------------------+--------+--------------------+<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>openstack-T</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux扩容根磁盘空间</title>
    <link href="/2022/04/17/Linux%E6%89%A9%E5%AE%B9%E6%A0%B9%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4/"/>
    <url>/2022/04/17/Linux%E6%89%A9%E5%AE%B9%E6%A0%B9%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4/</url>
    
    <content type="html"><![CDATA[<p>1.添加磁盘空间</p><p>2.查看磁盘信息</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">fdisk -l<br></code></pre></div></td></tr></table></figure><p>3.新建磁盘分区</p><p>4.创建新分区(vdb1)。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">fdisk /dev/vdb<br></code></pre></div></td></tr></table></figure><p>5.创建物理卷。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">pvcreate /dev/vdb1<br></code></pre></div></td></tr></table></figure><p>6.将添加新的物理卷，加载到centos卷组。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vgextend centos /dev/vdb1<br></code></pre></div></td></tr></table></figure><p>7.增加&#x2F;dev&#x2F;mapper&#x2F;centos-root大小，增加100G。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">lvresize -L +100G /dev/mapper/centos-root<br></code></pre></div></td></tr></table></figure><p>8.同步文件系统。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">xfs_growfs /dev/mapper/centos-root<br></code></pre></div></td></tr></table></figure><p>9.查看扩容后的大小。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">df -h<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux-根扩容</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>openstack-Mitaka</title>
    <link href="/2022/04/17/openstack-Mitaka/"/>
    <url>/2022/04/17/openstack-Mitaka/</url>
    
    <content type="html"><![CDATA[<h1 id="OpenStack-M版搭建"><a href="#OpenStack-M版搭建" class="headerlink" title="OpenStack M版搭建"></a>OpenStack M版搭建</h1><p><img src="https://i.bmp.ovh/imgs/2022/04/17/3f71c9177e94cb22.png" alt="img"></p><h2 id="密码表：-密码均为密码名称"><a href="#密码表：-密码均为密码名称" class="headerlink" title="密码表：(密码均为密码名称)"></a>密码表：(密码均为密码名称)</h2><table><thead><tr><th align="center">密码名称</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">数据库密码(不能使用变量)</td><td align="center">数据库的root密码</td></tr><tr><td align="center"><code>ADMIN_PASS</code></td><td align="center"><code>admin</code> 用户密码</td></tr><tr><td align="center"><code>CEILOMETER_DBPASS</code></td><td align="center">Telemetry 服务的数据库密码</td></tr><tr><td align="center"><code>CEILOMETER_PASS</code></td><td align="center">Telemetry 服务的 <code>ceilometer</code> 用户密码</td></tr><tr><td align="center"><code>CINDER_DBPASS</code></td><td align="center">块设备存储服务的数据库密码</td></tr><tr><td align="center"><code>CINDER_PASS</code></td><td align="center">块设备存储服务的 <code>cinder</code> 密码</td></tr><tr><td align="center"><code>DASH_DBPASS</code></td><td align="center">Database password for the dashboard</td></tr><tr><td align="center"><code>DEMO_PASS</code></td><td align="center"><code>demo</code> 用户的密码</td></tr><tr><td align="center"><code>GLANCE_DBPASS</code></td><td align="center">镜像服务的数据库密码</td></tr><tr><td align="center"><code>GLANCE_PASS</code></td><td align="center">镜像服务的 <code>glance</code> 用户密码</td></tr><tr><td align="center"><code>HEAT_DBPASS</code></td><td align="center">Orchestration服务的数据库密码</td></tr><tr><td align="center"><code>HEAT_DOMAIN_PASS</code></td><td align="center">Orchestration 域的密码</td></tr><tr><td align="center"><code>HEAT_PASS</code></td><td align="center">Orchestration 服务中<code>heat</code>用户的密码</td></tr><tr><td align="center"><code>KEYSTONE_DBPASS</code></td><td align="center">认证服务的数据库密码</td></tr><tr><td align="center"><code>NEUTRON_DBPASS</code></td><td align="center">网络服务的数据库密码</td></tr><tr><td align="center"><code>NEUTRON_PASS</code></td><td align="center">网络服务的 <code>neutron</code> 用户密码</td></tr><tr><td align="center"><code>NOVA_DBPASS</code></td><td align="center">计算服务的数据库密码</td></tr><tr><td align="center"><code>NOVA_PASS</code></td><td align="center">计算服务中<code>nova</code>用户的密码</td></tr><tr><td align="center"><code>RABBIT_PASS</code></td><td align="center">RabbitMQ的guest用户密码</td></tr><tr><td align="center"><code>SWIFT_PASS</code></td><td align="center">对象存储服务用户<code>swift</code>的密码</td></tr></tbody></table><h2 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h2><table><thead><tr><th align="center">主机名</th><th align="center">IP</th><th align="center">内存</th><th align="center">硬盘</th><th align="center">网卡数</th></tr></thead><tbody><tr><td align="center">controller</td><td align="center">172.16.100.28</td><td align="center">8G</td><td align="center">80G</td><td align="center">1</td></tr><tr><td align="center">compute</td><td align="center">172.16.100.29</td><td align="center">8G</td><td align="center">80G</td><td align="center">1</td></tr></tbody></table><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">hostnamectl set-hostname controller<br></code></pre></div></td></tr></table></figure><h4 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">hostnamectl set-hostname compute<br></code></pre></div></td></tr></table></figure><!--注意重新连接 否则后面创建Rabbitmq用户可能会报错--><h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><h3 id="controller配置"><a href="#controller配置" class="headerlink" title="controller配置"></a>controller配置</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/sysconfig/network-scripts/ifcfg-eth0<br><br>ONBOOT=yes<br>BOOTPROTO=static<br>IPADDR=172.16.100.28<br>NETMASK=255.255.255.0<br>GATEWAY=172.16.100.254<br>DNS1=114.114.114.114<br></code></pre></div></td></tr></table></figure><h3 id="compute配置"><a href="#compute配置" class="headerlink" title="compute配置"></a>compute配置</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/sysconfig/network-scripts/ifcfg-eth0<br><br>ONBOOT=yes<br>BOOTPROTO=static<br>IPADDR=172.16.100.29<br>NETMASK=255.255.255.0<br>GATEWAY=172.16.100.254<br>DNS1=114.114.114.114<br></code></pre></div></td></tr></table></figure><p>：wq 保存退出</p><h3 id="重启网卡"><a href="#重启网卡" class="headerlink" title="重启网卡"></a>重启网卡</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart network<br></code></pre></div></td></tr></table></figure><h4 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:00:db:9c brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.100.28/24 brd 172.16.100.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::6010:d73a:2158:5fe8/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></div></td></tr></table></figure><h4 id="compute-1"><a href="#compute-1" class="headerlink" title="compute"></a>compute</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:3c:b9:4c brd ff:ff:ff:ff:ff:ff<br>    inet 172.16.100.29/24 brd 172.16.100.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::c374:72b:eb12:5916/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></div></td></tr></table></figure><h2 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h2><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl stop firewalld<br>systemctl disable firewalld<br></code></pre></div></td></tr></table></figure><h3 id="关闭网卡守护进程"><a href="#关闭网卡守护进程" class="headerlink" title="关闭网卡守护进程"></a>关闭网卡守护进程</h3><!--在controller和compute均执行--><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shel">systemctl stop NetworkManager<br>systemctl disable NetworkManager<br></code></pre></div></td></tr></table></figure><h3 id="关闭SElinux"><a href="#关闭SElinux" class="headerlink" title="关闭SElinux"></a>关闭SElinux</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">setenforce 0<br><br>vi /etc/selinux/config<br><br>修改 SELINUX=enforcing 为 SELINUX=disabled<br><br>:wq 保存退出<br></code></pre></div></td></tr></table></figure><h3 id="查看SElinux状态"><a href="#查看SElinux状态" class="headerlink" title="查看SElinux状态"></a>查看SElinux状态</h3><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# getenforce <br>Permissive<br><br>[root@compute ~]# getenforce <br>Permissive<br><br></code></pre></div></td></tr></table></figure><h3 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">将目录下的源删除<br>rm -rf /etc/yum.repos.d/C*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">controller</span><br>[root@controller ~]# cat /etc/yum.repos.d/http.repo <br>[centos]<br>name=centos<br>baseurl=ftp://172.16.100.66/centos<br>gpgcheck=0<br>[openstack-m]<br>name=openstack-m<br>baseurl=ftp://172.16.100.66/openstack-m<br>gpgcheck=0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">compute</span><br>[root@compute ~]# cat /etc/yum.repos.d/http.repo <br>[centos]<br>name=centos<br>baseurl=ftp://172.16.100.66/centos<br>gpgcheck=0<br>[openstack-m]<br>name=openstack-m<br>baseurl=ftp://172.16.100.66/openstack-m<br>gpgcheck=0<br></code></pre></div></td></tr></table></figure><blockquote><p>此处用的是配置本地源，一个Centos，一个OpenStack源</p><p>附上国内阿里源<a href="https://mirrors.aliyun.com/centos/7/cloud/x86_64/openstack-queens/">https://mirrors.aliyun.com/centos/7/cloud/x86_64/openstack-queens/</a></p></blockquote><h3 id="配置host解析"><a href="#配置host解析" class="headerlink" title="配置host解析"></a>配置host解析</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cat /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><br>172.16.100.28 controller<br>172.16.100.29 compute<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# cat /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><br>172.16.100.28 controller<br>172.16.100.29 compute<br></code></pre></div></td></tr></table></figure><h3 id="测试各节点之间与Internet的通信"><a href="#测试各节点之间与Internet的通信" class="headerlink" title="测试各节点之间与Internet的通信"></a>测试各节点之间与Internet的通信</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ping -c 2 compute<br>PING compute (172.16.100.29) 56(84) bytes of data.<br>64 bytes from compute (172.16.100.29): icmp_seq=1 ttl=64 time=0.250 ms<br>64 bytes from compute (172.16.100.29): icmp_seq=2 ttl=64 time=0.447 ms<br><br>--- compute ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 0.250/0.348/0.447/0.100 m<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ping -c 2 controller<br>PING controller (172.16.100.28) 56(84) bytes of data.<br>64 bytes from controller (172.16.100.28): icmp_seq=1 ttl=64 time=0.378 ms<br>64 bytes from controller (172.16.100.28): icmp_seq=2 ttl=64 time=0.391 ms<br><br>--- controller ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 0.378/0.384/0.391/0.020 ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# ping -c 2 baidu.com<br>PING baidu.com (220.181.38.251) 56(84) bytes of data.<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=47 time=174 ms<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=47 time=173 ms<br><br>--- baidu.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br>rtt min/avg/max/mdev = 173.205/173.637/174.070/0.600 ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# ping -c 2 baidu.com<br>PING baidu.com (220.181.38.251) 56(84) bytes of data.<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=47 time=174 ms<br>64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=47 time=171 ms<br><br>--- baidu.com ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br>rtt min/avg/max/mdev = 171.844/173.164/174.484/1.320 ms<br></code></pre></div></td></tr></table></figure><h3 id="修改时间同步配置文件"><a href="#修改时间同步配置文件" class="headerlink" title="修改时间同步配置文件"></a>修改时间同步配置文件</h3><h4 id="controller-2"><a href="#controller-2" class="headerlink" title="controller"></a>controller</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/chrony.conf<br><br>server ntp.aliyun.com iburst<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##大概26行左右###</span></span><br>allow 172.16.100.0/24<br></code></pre></div></td></tr></table></figure><h4 id="compute-2"><a href="#compute-2" class="headerlink" title="compute"></a>compute</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/chrony.conf<br><br>server controller iburst<br></code></pre></div></td></tr></table></figure><h4 id="重启chrony服务"><a href="#重启chrony服务" class="headerlink" title="重启chrony服务"></a>重启chrony服务</h4><!--在controller和compute均执行--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart chronyd<br></code></pre></div></td></tr></table></figure><h4 id="验证是否同步成功"><a href="#验证是否同步成功" class="headerlink" title="验证是否同步成功"></a>验证是否同步成功</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# chronyc sources<br>210 Number of sources = 1<br>MS Name/IP address         Stratum Poll Reach LastRx Last sample               <br>===============================================================================<br>^* 203.107.6.88                  2   6   367    79   +140us[ +789us] +/-   95ms<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# chronyc sources<br>210 Number of sources = 1<br>MS Name/IP address         Stratum Poll Reach LastRx Last sample               <br>===============================================================================<br>^* controller                    3   6   377     9    -34us[ +664us] +/-   96ms<br><br></code></pre></div></td></tr></table></figure><h3 id="所有节点安装openstack客户端和openstack-selinux"><a href="#所有节点安装openstack客户端和openstack-selinux" class="headerlink" title="所有节点安装openstack客户端和openstack-selinux"></a>所有节点安装openstack客户端和openstack-selinux</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install python-openstackclient openstack-selinux<br></code></pre></div></td></tr></table></figure><h3 id="安装Mariadb数据库-controller"><a href="#安装Mariadb数据库-controller" class="headerlink" title="安装Mariadb数据库(controller)"></a>安装Mariadb数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install mariadb mariadb-server python2-PyMySQL<br></code></pre></div></td></tr></table></figure><p>创建和编辑<code>/etc/my.cnf.d/openstack.cnf</code>文件并添加以下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shel">[mysqld]<br>bind-address = 172.16.100.28 #controller IP地址<br>default-storage-engine = innodb<br>innodb_file_per_table<br>max_connections = 4096<br>collation-server = utf8_general_ci<br>character-set-server = utf8<br></code></pre></div></td></tr></table></figure><h4 id="启动mariadb"><a href="#启动mariadb" class="headerlink" title="启动mariadb"></a>启动mariadb</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl start mariadb<br>systemctl enable mariadb<br></code></pre></div></td></tr></table></figure><h4 id="数据库默认初始化-设置密码000000"><a href="#数据库默认初始化-设置密码000000" class="headerlink" title="数据库默认初始化 (设置密码000000)"></a>数据库默认初始化 (设置密码000000)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# mysql_secure_installation<br><br>NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB<br>      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!<br><br>In order to log into MariaDB to secure it, we&#x27;ll need the current<br>password for the root user.  If you&#x27;ve just installed MariaDB, and<br>you haven&#x27;t set the root password yet, the password will be blank,<br>so you should just press enter here.<br><br>Enter current password for root (enter for none): <br>OK, successfully used password, moving on...<br><br>Setting the root password ensures that nobody can log into the MariaDB<br>root user without the proper authorisation.<br><br>Set root password? [Y/n] y<br>New password: <br>Re-enter new password: <br>Password updated successfully!<br>Reloading privilege tables..<br> ... Success!<br><br><br>By default, a MariaDB installation has an anonymous user, allowing anyone<br>to log into MariaDB without having to have a user account created for<br>them.  This is intended only for testing, and to make the installation<br>go a bit smoother.  You should remove them before moving into a<br>production environment.<br><br>Remove anonymous users? [Y/n] y<br> ... Success!<br><br>Normally, root should only be allowed to connect from &#x27;localhost&#x27;.  This<br>ensures that someone cannot guess at the root password from the network.<br><br>Disallow root login remotely? [Y/n] y<br> ... Success!<br><br>By default, MariaDB comes with a database named &#x27;test&#x27; that anyone can<br>access.  This is also intended only for testing, and should be removed<br>before moving into a production environment.<br><br>Remove test database and access to it? [Y/n] y<br> - Dropping test database...<br> ... Success!<br> - Removing privileges on test database...<br> ... Success!<br><br>Reloading the privilege tables will ensure that all changes made so far<br>will take effect immediately.<br><br>Reload privilege tables now? [Y/n] y<br> ... Success!<br><br>Cleaning up...<br><br>All done!  If you&#x27;ve completed all of the above steps, your MariaDB<br>installation should now be secure.<br><br>Thanks for using MariaDB!<br></code></pre></div></td></tr></table></figure><h3 id="安装rabbitmq并创建用户-controller"><a href="#安装rabbitmq并创建用户-controller" class="headerlink" title="安装rabbitmq并创建用户(controller)"></a>安装rabbitmq并创建用户(controller)</h3><p>1、功能:协调操作和状态信息服务</p><p>2、常用的消息代理软件</p><p>​RabbitMQ</p><p>​Qpid</p><p>​ZeroMQ</p><p>3.在controller节点安装RabbitMQ</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.安装RabbitMQ软件包<br>yum -y install rabbitmq-server<br>b.启动服务并设置开机自启动<br>systemctl enable rabbitmq-server<br>systemctl start rabbitmq-server<br>查看运行状态<br>systemctl status rabbitmq-server<br>c.创建用户<br>rabbitmqctl add_user openstack RABBIT_PASS<br>rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;<br></code></pre></div></td></tr></table></figure><h3 id="安装memcached缓存-controller"><a href="#安装memcached缓存-controller" class="headerlink" title="安装memcached缓存(controller)"></a>安装memcached缓存(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.安装memcached软件包<br>yum -y install memcached python-memcached<br>b.修改配置文件的地址否则其他网络无法访问<br>sed -i &#x27;s#127.0.0.1#172.16.100.28#g&#x27; /etc/sysconfig/memcached  ##注意IP更换成自己的<br>c.启动服务并设置开机自启动<br>systemctl start memcached.service<br>systemctl enable memcached.service<br></code></pre></div></td></tr></table></figure><h2 id="Keystone认证服务"><a href="#Keystone认证服务" class="headerlink" title="Keystone认证服务"></a>Keystone认证服务</h2><p>keystone认证方式:UUID,PKI,Fernet   随机生成字符串的方法</p><p>功能:认证管理,授权管理,服务目录</p><h3 id="在控制节点创建认证服务数据库-controller"><a href="#在控制节点创建认证服务数据库-controller" class="headerlink" title="在控制节点创建认证服务数据库(controller)"></a>在控制节点创建认证服务数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建keystone数据库<br>CREATE DATABASE keystone;<br>c.创建keystone数据库用户，使其可以对keystone数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h3 id="安装keystone相关软件包-和openstack-utils-noarch软件包"><a href="#安装keystone相关软件包-和openstack-utils-noarch软件包" class="headerlink" title="安装keystone相关软件包 和openstack-utils.noarch软件包"></a>安装keystone相关软件包 和openstack-utils.noarch软件包</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-keystone httpd mod_wsgi openstack-utils.noarch<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/keystone/keystone.conf /etc/keystone/keystone.conf.bak<br>grep -Ev &#x27;^$|#&#x27; /etc/keystone/keystone.conf.bak &gt; /etc/keystone/keystone.conf<br><br>openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN<br>openstack-config --set /etc/keystone/keystone.conf  database connection mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone<br>openstack-config --set /etc/keystone/keystone.conf  token provider fernet<br></code></pre></div></td></tr></table></figure><h3 id="同步keystone数据库"><a href="#同步keystone数据库" class="headerlink" title="同步keystone数据库"></a>同步keystone数据库</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看keystone库是否有数据--><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">如果同步失败,将/var/log/keystone/keystone.log修改属组,重启httpd<br><br>chown -R keystone.keystone /var/log/keystone/keystone.log<br>systemctl restart httpd<br></code></pre></div></td></tr></table></figure><h3 id="初始化fernet"><a href="#初始化fernet" class="headerlink" title="初始化fernet"></a>初始化fernet</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone<br></code></pre></div></td></tr></table></figure><h3 id="配置Apache-HTTP服务器"><a href="#配置Apache-HTTP服务器" class="headerlink" title="配置Apache HTTP服务器"></a>配置Apache HTTP服务器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/<br>echo &quot;ServerName controller&quot; &gt;&gt;/etc/httpd/conf/httpd.conf<br></code></pre></div></td></tr></table></figure><p>配置以下文件</p><p>###将原有是删除</p><p>vim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;wsgi-keystone.conf </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Listen 5000<br>Listen 35357<br><br>&lt;VirtualHost *:5000&gt;<br>    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;<br>    WSGIProcessGroup keystone-public<br>    WSGIScriptAlias / /usr/bin/keystone-wsgi-public<br>    WSGIApplicationGroup %&#123;GLOBAL&#125;<br>    WSGIPassAuthorization On<br>    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;<br>    ErrorLog /var/log/httpd/keystone-error.log<br>    CustomLog /var/log/httpd/keystone-access.log combined<br><br>    &lt;Directory /usr/bin&gt;<br>        Require all granted<br>    &lt;/Directory&gt;<br>&lt;/VirtualHost&gt;<br><br>&lt;VirtualHost *:35357&gt;<br>    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;<br>    WSGIProcessGroup keystone-admin<br>    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin<br>    WSGIApplicationGroup %&#123;GLOBAL&#125;<br>    WSGIPassAuthorization On<br>    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;<br>    ErrorLog /var/log/httpd/keystone-error.log<br>    CustomLog /var/log/httpd/keystone-access.log combined<br><br>    &lt;Directory /usr/bin&gt;<br>        Require all granted<br>    &lt;/Directory&gt;<br>&lt;/VirtualHost&gt;<br></code></pre></div></td></tr></table></figure><h4 id="启动HTTP服务"><a href="#启动HTTP服务" class="headerlink" title="启动HTTP服务"></a>启动HTTP服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable httpd.service<br>systemctl start httpd.service<br></code></pre></div></td></tr></table></figure><h3 id="创建服务和注册api"><a href="#创建服务和注册api" class="headerlink" title="创建服务和注册api:"></a>创建服务和注册api:</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">export OS_TOKEN=ADMIN_TOKEN<br>export OS_URL=http://controller:35357/v3<br>export OS_IDENTITY_API_VERSION=3<br><br>openstack service create \<br>  --name keystone --description &quot;OpenStack Identity&quot; identity<br><br>openstack endpoint create --region RegionOne \<br>  identity public http://controller:5000/v3<br>  <br>openstack endpoint create --region RegionOne \<br>  identity internal http://controller:5000/v3　　<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">前两个为5000端口，专门处理内部和外部的访问</span><br>  　　　　　　　　　　　　　　　　　　　　　　　　　　　　<br>openstack endpoint create --region RegionOne \<br>  identity admin http://controller:35357/v3<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">35357端口，专门处理admin</span><br></code></pre></div></td></tr></table></figure><h3 id="创建域-项目-用户-角色"><a href="#创建域-项目-用户-角色" class="headerlink" title="创建域,项目,用户,角色"></a>创建域,项目,用户,角色</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack domain create --description &quot;Default Domain&quot; default<br><br>openstack project create --domain default \<br>   --description &quot;Admin Project&quot; admin <br><br>openstack user create --domain default \<br>   --password ADMIN_PASS admin　　　　<br><br>openstack role create admin  <br><br>openstack role add --project admin --user admin admin<br><br>openstack project create --domain default \<br>--description &quot;Service Project&quot; service<br></code></pre></div></td></tr></table></figure><h3 id="创建环境变量脚本"><a href="#创建环境变量脚本" class="headerlink" title="创建环境变量脚本"></a>创建环境变量脚本</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cat admin-openrc <br>export OS_PROJECT_DOMAIN_NAME=default<br>export OS_USER_DOMAIN_NAME=default<br>export OS_PROJECT_NAME=admin<br>export OS_USERNAME=admin<br>export OS_PASSWORD=ADMIN_PASS<br>export OS_AUTH_URL=http://controller:35357/v3<br>export OS_IDENTITY_API_VERSION=3<br>export OS_IMAGE_API_VERSION=2<br></code></pre></div></td></tr></table></figure><h3 id="取消前面设置的环境变量"><a href="#取消前面设置的环境变量" class="headerlink" title="取消前面设置的环境变量"></a>取消前面设置的环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">unset OS_TOKEN<br></code></pre></div></td></tr></table></figure><h3 id="使环境变量生效"><a href="#使环境变量生效" class="headerlink" title="使环境变量生效"></a>使环境变量生效</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">source admin-openrc<br></code></pre></div></td></tr></table></figure><h3 id="验证环境变量是否成功"><a href="#验证环境变量是否成功" class="headerlink" title="验证环境变量是否成功"></a>验证环境变量是否成功</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack token issue<br></code></pre></div></td></tr></table></figure><p>### 注意环境变量问题:先取消前面设置的环境变量,否则会报错###</p><h2 id="Glance镜像服务"><a href="#Glance镜像服务" class="headerlink" title="Glance镜像服务"></a>Glance镜像服务</h2><p><strong>glance-api</strong></p><p>接收镜像API的调用，诸如镜像发现、恢复、存储。</p><p><strong>glance-registry</strong></p><p>存储、处理和恢复镜像的元数据，元数据包括项诸如大小和类型。</p><h3 id="在控制节点创建镜像服务数据库-controller"><a href="#在控制节点创建镜像服务数据库-controller" class="headerlink" title="在控制节点创建镜像服务数据库(controller)"></a>在控制节点创建镜像服务数据库(controller)</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建glance数据库<br>CREATE DATABASE glance;<br>c.创建glance数据库用户，使其可以对glance数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h3 id="在keystone创建glance用户关联角色"><a href="#在keystone创建glance用户关联角色" class="headerlink" title="在keystone创建glance用户关联角色"></a>在keystone创建glance用户关联角色</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password GLANCE_PASS glance<br>openstack role add --project service --user glance admin<br><br>验证是否成功<br>openstack role assignment list<br></code></pre></div></td></tr></table></figure><h3 id="在keystone创建服务和注册api"><a href="#在keystone创建服务和注册api" class="headerlink" title="在keystone创建服务和注册api"></a>在keystone创建服务和注册api</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name glance \<br>--description &quot;OpenStack Image&quot; image<br>openstack endpoint create --region RegionOne \<br>  image public http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image internal http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image admin http://controller:9292<br></code></pre></div></td></tr></table></figure><h3 id="安装glance软件包"><a href="#安装glance软件包" class="headerlink" title="安装glance软件包"></a>安装glance软件包</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-glance<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p><strong>&#x2F;etc&#x2F;glance&#x2F;glance-api.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/glance/glance-api.conf&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/glance/glance-api.conf.bak &gt;/etc/glance/glance-api.conf<br><br>openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance<br>openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS<br>openstack-config --set /etc/glance/glance-api.conf  paste_deploy flavor keystone<br>openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http<br>openstack-config --set /etc/glance/glance-api.conf glance_store default_store file<br>openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/<br></code></pre></div></td></tr></table></figure><p><strong>&#x2F;etc&#x2F;glance&#x2F;glance-registry.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp  /etc/glance/glance-registry.conf&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/glance/glance-registry.conf.bak &gt;/etc/glance/glance-registry.conf<br><br>openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance<br>openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS<br>openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone<br></code></pre></div></td></tr></table></figure><h3 id="同步glance数据库"><a href="#同步glance数据库" class="headerlink" title="同步glance数据库"></a>同步glance数据库</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看glance库是否有数据--><!--忽略警告--><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable openstack-glance-api.service openstack-glance-registry.service<br>systemctl start openstack-glance-api.service openstack-glance-registry.service<br></code></pre></div></td></tr></table></figure><h3 id="下载测试镜像cirros"><a href="#下载测试镜像cirros" class="headerlink" title="下载测试镜像cirros"></a>下载测试镜像cirros</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img<br></code></pre></div></td></tr></table></figure><p>###下载不了多试几次###</p><h3 id="上传镜像测试"><a href="#上传镜像测试" class="headerlink" title="上传镜像测试"></a>上传镜像测试</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack image create &quot;cirros&quot;  --file cirros-0.3.4-x86_64-disk.img  --disk-format qcow2 --container-format bare  --public<br></code></pre></div></td></tr></table></figure><h2 id="Nova计算服务"><a href="#Nova计算服务" class="headerlink" title="Nova计算服务"></a>Nova计算服务</h2><p>nova-api:接受响应所有的计算服务请求，管理虚拟机(云主机)生命周期</p><p>nova-compute (多个):真正管理虚拟机(nova-compute调用libvirt)</p><p>nova-scheduler:nova调度器（挑选出最合适的nova-compute来创建虚机)</p><p>nova-conductor:帮助nova-compute代理修改数据库中虚拟机的状态</p><p>nova-network早期openstack版本管理虚拟机的网络(已弃用,neutron)</p><p>nova-consoleauth和nova-novncproxy: web版的vnc来直接操作云主机</p><p>novncproxy:web版vnc客户端</p><p>nova-api-metadata:接受来自虚拟机发送的元数据请求(配合neutron-metadata-agent,来虚拟机定制化)</p><h3 id="controller-3"><a href="#controller-3" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建nova服务数据库-controller"><a href="#在控制节点创建nova服务数据库-controller" class="headerlink" title="在控制节点创建nova服务数据库(controller)"></a>在控制节点创建nova服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建nova_api,nova数据库<br>CREATE DATABASE nova_api;<br>CREATE DATABASE nova;<br>c.创建nova_api，nova数据库用户，使其可以对nova_api,nova数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户（glance，nova，neutron）关联角色"><a href="#在keystone创建系统用户（glance，nova，neutron）关联角色" class="headerlink" title="在keystone创建系统用户（glance，nova，neutron）关联角色"></a>在keystone创建系统用户（glance，nova，neutron）关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password NOVA_PASS nova<br>openstack role add --project service --user nova admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api"><a href="#在keystone上创建服务和注册api" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack service create --name nova \<br>  --description &quot;OpenStack Compute&quot; compute<br>openstack endpoint create --region RegionOne \<br>  compute public http://controller:8774/v2.1/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  compute internal http://controller:8774/v2.1/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  compute admin http://controller:8774/v2.1/%\(tenant_id\)s<br></code></pre></div></td></tr></table></figure><h4 id="安装相关服务软件包"><a href="#安装相关服务软件包" class="headerlink" title="安装相关服务软件包"></a>安装相关服务软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-nova-api openstack-nova-conductor \<br>  openstack-nova-console openstack-nova-novncproxy \<br>  openstack-nova-scheduler<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-2"><a href="#修改配置文件-2" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/nova/nova.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/nova/nova.conf.bak &gt;/etc/nova/nova.conf<br><br>openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute , metadata<br>openstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api<br>openstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova<br>openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 172.16.100.28###替换自己的IP!!!<br>openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True<br>openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_listen &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292<br>openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp<br></code></pre></div></td></tr></table></figure><h4 id="同步数据库"><a href="#同步数据库" class="headerlink" title="同步数据库"></a>同步数据库</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova<br>su -s /bin/sh -c &quot;nova-manage db sync&quot; nova<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看nova库是否有数据--><!--忽略警告--><h4 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable openstack-nova-api.service \<br>  openstack-nova-consoleauth.service openstack-nova-scheduler.service \<br>  openstack-nova-conductor.service openstack-nova-novncproxy.service<br>systemctl start openstack-nova-api.service \<br>  openstack-nova-consoleauth.service openstack-nova-scheduler.service \<br>  openstack-nova-conductor.service openstack-nova-novncproxy.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-3"><a href="#compute-3" class="headerlink" title="compute"></a>compute</h3><h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-nova-compute openstack-utils.noarch<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-3"><a href="#修改配置文件-3" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/nova/nova.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/nova/nova.conf.bak &gt;/etc/nova/nova.conf<br><br>openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack<br>openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova<br>openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS<br>openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 172.16.100.29   ###替换自己IP<br>openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True<br>openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver<br>openstack-config --set /etc/nova/nova.conf vnc enabled True<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0<br>openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address &#x27;$my_ip&#x27;<br>openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://172.16.100.28:6080/vnc_auto.html<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##服务器组件监听所有的 IP 地址，而代理组件仅仅监听计算节点管理网络接口的 IP 地址。基本的 URL 指示您可以使用 web 浏览器访问位于该计算节点上实例的远程控制台的位置。</span></span><br>openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292<br>openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp<br>openstack-config --set /etc/nova/nova.conf libvirt cpu_mode none<br>openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-2"><a href="#启动服务-2" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable libvirtd.service openstack-nova-compute.service<br>systemctl start libvirtd.service openstack-nova-compute.service<br></code></pre></div></td></tr></table></figure><h3 id="查看nova是否正常"><a href="#查看nova是否正常" class="headerlink" title="查看nova是否正常"></a>查看nova是否正常</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# nova service-list<br>+----+------------------+------------+----------+---------+-------+----------------------------+-----------+<br>| Id | Binary           | Host       | Zone     | Status  | State | Updated_at                 | Disabled Reason |<br>+----+------------------+------------+----------+---------+-------+----------------------------+-----------+<br>| 1  | nova-consoleauth | controller | internal | enabled | up    | 2021-11-23T12:50:21.000000 | -               |<br>| 2  | nova-conductor   | controller | internal | enabled | up    | 2021-11-23T12:50:22.000000 | -               |<br>| 3  | nova-scheduler   | controller | internal | enabled | up    | 2021-11-23T12:50:21.000000 | -               |<br>| 9  | nova-compute     | compute    | nova     | enabled | up    | 2021-11-23T12:50:25.000000 | -               |<br>+----+------------------+------------+----------+---------+-------+----------------------------+-----------+<br><br></code></pre></div></td></tr></table></figure><h2 id="Neutron网络服务"><a href="#Neutron网络服务" class="headerlink" title="Neutron网络服务"></a>Neutron网络服务</h2><p>neutron-serverT端(9696)api:接受和响应外部的网络管理请求</p><p>neutron-linuxbridge-agent :负责创建桥接网卡</p><p>neutron-dhcp-agent:负责分配IP</p><p>neutron-metadata-agent:配合nova-metadata-api实现虚拟机的定制化操作</p><p>L3-agent：实现三层网络vxlan(网络层)</p><h3 id="controller-4"><a href="#controller-4" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建neutron服务数据库-controller"><a href="#在控制节点创建neutron服务数据库-controller" class="headerlink" title="在控制节点创建neutron服务数据库(controller)"></a>在控制节点创建neutron服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建neutron数据库<br>CREATE DATABASE neutron;<br>c.创建neutron数据库用户，使其可以对neutron数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NEUTRON_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NEUTRON_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户-glance-nova-neutron-关联角色"><a href="#在keystone创建系统用户-glance-nova-neutron-关联角色" class="headerlink" title="在keystone创建系统用户(glance, nova, neutron)关联角色"></a>在keystone创建系统用户(glance, nova, neutron)关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password NEUTRON_PASS neutron<br>openstack role add --project service --user neutron admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api-1"><a href="#在keystone上创建服务和注册api-1" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"> openstack service create --name neutron \<br>  --description &quot;OpenStack Networking&quot; network<br>openstack endpoint create --region RegionOne \<br>  network public http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network internal http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network admin http://controller:9696<br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包"><a href="#安装服务相应软件包" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum  -y install openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-4"><a href="#修改配置文件-4" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>配置服务组件</strong></p><p><strong>a：&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/neutron.conf&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/neutron/neutron.conf.bak &gt;/etc/neutron/neutron.conf<br><br>openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins  <br>openstack-config --set /etc/neutron/neutron.conf DEFAULT  rpc_backend rabbit<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True<br>openstack-config --set /etc/neutron/neutron.conf  nova auth_url http://controller:35357<br>openstack-config --set /etc/neutron/neutron.conf  nova auth_type password<br>openstack-config --set /etc/neutron/neutron.conf  nova project_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf  nova user_domain_name default<br>openstack-config --set /etc/neutron/neutron.conf  nova region_name RegionOne<br>openstack-config --set /etc/neutron/neutron.conf  nova project_name service<br>openstack-config --set /etc/neutron/neutron.conf  nova username nova<br>openstack-config --set /etc/neutron/neutron.conf  nova password NOVA_PASS<br>openstack-config --set /etc/neutron/neutron.conf  oslo_concurrency lock_path /var/lib/neutron/tmp<br></code></pre></div></td></tr></table></figure><p><strong>配置 Modular Layer 2 (ML2) 插件</strong></p><p><strong>b: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/ml2_conf.ini&#123;,.bak&#125;<br>grep &#x27;^[a-z\[]&#x27; /etc/neutron/plugins/ml2/ml2_conf.ini.bak &gt;/etc/neutron/plugins/ml2/ml2_conf.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types <br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider<br>openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True<br></code></pre></div></td></tr></table></figure><p><strong>配置Linuxbridge代理</strong></p><p><strong>c: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak &gt;/etc/neutron/plugins/ml2/linuxbridqe_agent.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 ###替换自己的网卡名称<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<br></code></pre></div></td></tr></table></figure><p><strong>配置DHCP代理</strong></p><p><strong>d: &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/dhcp_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27;  /etc/neutron/dhcp_agent.ini.bak &gt;/etc/neutron/dhcp_agent.ini<br><br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver   neutron.agent.linux.interface.BridgeInterfaceDriver<br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver   neutron.agent.linux.dhcp.Dnsmasq<br>openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata   True<br></code></pre></div></td></tr></table></figure><p><strong>配置元数据代理</strong></p><p><strong>e：&#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/metadata_agent.ini&#123;,.bak&#125;<br>grep -EV &#x27;^$|#&#x27; /etc/neutron/metadata_agent.ini.bak &gt; /etc/neutron/metadata_agent.ini<br><br>openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller<br>openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET<br></code></pre></div></td></tr></table></figure><p><strong>添加控制节点网络服务</strong></p><p><strong>f：&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack-config --set  /etc/nova/nova.conf neutron url    http://controller:9696<br>openstack-config --set  /etc/nova/nova.conf neutron auth_url   http://controller:35357<br>openstack-config --set  /etc/nova/nova.conf neutron auth_type  password<br>openstack-config --set  /etc/nova/nova.conf neutron project_domain_name    default<br>openstack-config --set  /etc/nova/nova.conf neutron user_domain_name    default<br>openstack-config --set  /etc/nova/nova.conf neutron region_name    RegionOne<br>openstack-config --set  /etc/nova/nova.conf neutron project_name    service<br>openstack-config --set  /etc/nova/nova.conf neutron username    neutron<br>openstack-config --set  /etc/nova/nova.conf neutron password    NEUTRON_PASS<br>openstack-config --set  /etc/nova/nova.conf neutron service_metadata_proxy    True<br>openstack-config --set  /etc/nova/nova.conf neutron metadata_proxy_shared_secret    METADATA_SECRET<br></code></pre></div></td></tr></table></figure><h4 id="同步neutron数据库"><a href="#同步neutron数据库" class="headerlink" title="同步neutron数据库"></a><strong>同步neutron数据库</strong></h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini<br>su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf \<br>  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron<br></code></pre></div></td></tr></table></figure><!--可以ok即成功--><!--同步后进入数据库查看neutron库是否有数据--><!--忽略警告--><h4 id="启动服务-3"><a href="#启动服务-3" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart openstack-nova-api.service<br>systemctl enable neutron-server.service \<br>  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \<br>  neutron-metadata-agent.service<br>systemctl start neutron-server.service \<br>  neutron-linuxbridge-agent.service neutron-dhcp-agent.service \<br>  neutron-metadata-agent.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-4"><a href="#compute-4" class="headerlink" title="compute"></a>compute</h3><h4 id="在计算节点安装组件-compute"><a href="#在计算节点安装组件-compute" class="headerlink" title="在计算节点安装组件(compute)"></a>在计算节点安装组件(compute)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-neutron-linuxbridge ebtables ipset<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-5"><a href="#修改配置文件-5" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>a.&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/neutron.conf&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/neutron.conf.bak &gt;/etc/neutron/neutron.conf<br><br>openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend    rabbit<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host    controller<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid    openstack<br>openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS<br>openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy    keystone<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type    password<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name  default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name    default<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name    service<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username    neutron<br>openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password    NEUTRON_PASS<br>openstack-config --set /etc/neutron/neutron.conf oslo_concurreny lock_path    /var/lib/neutron/tmp<br></code></pre></div></td></tr></table></figure><p><strong>配置Linuxbridge代理</strong></p><p><strong>b: &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini&#123;,.bak&#125;<br>grep &#x27;^[a-Z\[]&#x27; /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak &gt;/etc/neutron/plugins/ml2/linuxbridqe_agent.ini<br><br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0  ###替换自己的网卡名称<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True<br>openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<br></code></pre></div></td></tr></table></figure><p><strong>添加计算节点网络服务</strong></p><p><strong>c：&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack-config --set  /etc/nova/nova.conf neutron url    http://controller:9696<br>openstack-config --set  /etc/nova/nova.conf neutron auth_url    http://controller:35357<br>openstack-config --set  /etc/nova/nova.conf neutron auth_type    password<br>openstack-config --set  /etc/nova/nova.conf neutron project_domain_name    default<br>openstack-config --set  /etc/nova/nova.conf neutron user_domain_name    default<br>openstack-config --set  /etc/nova/nova.conf neutron region_name    RegionOne<br>openstack-config --set  /etc/nova/nova.conf neutron project_name    service<br>openstack-config --set  /etc/nova/nova.conf neutron username    neutron<br>openstack-config --set  /etc/nova/nova.conf neutron password    NEUTRON_PASS<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-4"><a href="#启动服务-4" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">重新启动计算服务：<br>systemctl restart openstack-nova-compute.service<br>启动Linuxbridge代理并配置它开机自启动：<br>systemctl enable neutron-linuxbridge-agent.service<br>systemctl start neutron-linuxbridge-agent.service<br></code></pre></div></td></tr></table></figure><h2 id="Dashboard服务"><a href="#Dashboard服务" class="headerlink" title="Dashboard服务"></a>Dashboard服务</h2><p>(根据情况确定安装控制节点还是计算节点）</p><blockquote><p>此次安装在compute上</p></blockquote><h3 id="安装openstack-dashboard"><a href="#安装openstack-dashboard" class="headerlink" title="安装openstack-dashboard"></a>安装openstack-dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-dashboard<br></code></pre></div></td></tr></table></figure><h3 id="修改配置文件-6"><a href="#修改配置文件-6" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p><strong>&#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在 controller 节点上配置仪表盘以使用 OpenStack 服务</span><br>OPENSTACK_HOST = &quot;controller&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">允许所有主机访问仪表板</span><br>ALLOWED_HOSTS = [&#x27;*&#x27;, ]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置 memcached 会话存储服务</span><br>CACHES = &#123;<br>  &#x27;default&#x27;: &#123;<br>        &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,<br>         &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,<br>   &#125;<br>&#125;<br>SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cache&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用第3版认证API</span><br>OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用对域的支持</span><br>OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置API版本</span><br>OPENSTACK_API_VERSIONS = &#123;<br>   &quot;identity&quot;: 3,<br>    &quot;image&quot;: 2,<br>      &quot;volume&quot;: 2,<br>&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过仪表盘创建用户时的默认域配置为 default</span><br>OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;default&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过仪表盘创建的用户默认角色配置为 user</span><br>OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果您选择网络参数1，禁3层网络服务：</span><br>OPENSTACK_NEUTRON_NETWORK = &#123;<br>    ...<br>&#x27;enable_router&#x27;: False,<br>&#x27;enable_quotas&#x27;: False,<br>&#x27;enable_distributed_router&#x27;: False,<br>&#x27;enable_ha_router&#x27;: False,<br>&#x27;enable_lb&#x27;: False,<br>&#x27;enable_firewall&#x27;: False,<br>&#x27;enable_vpn&#x27;: False,<br>&#x27;enable_fip_topology_check&#x27;: False,<br>&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以选择性地配置时区：</span><br>TIME_ZONE = &quot;Asia/Shanghai&quot;<br></code></pre></div></td></tr></table></figure><h3 id="启动服务-5"><a href="#启动服务-5" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart httpd.service<br></code></pre></div></td></tr></table></figure><h3 id="控制节点"><a href="#控制节点" class="headerlink" title="控制节点"></a>控制节点</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart memcached.service<br></code></pre></div></td></tr></table></figure><p>###如服务无法启动,在&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-dashboard.conf文件下添加以下字段###</p><p>​WSGIApplicationGroup %{GLOBAL}</p><h2 id="Cinder块存储服务"><a href="#Cinder块存储服务" class="headerlink" title="Cinder块存储服务"></a>Cinder块存储服务</h2><p>cinder-volume LVM,nfs,gfs,ceph</p><p>cinder-api:接收外部的api请求</p><p>cinder-volume:提供存储空间</p><p>cinder-scheduler调度器,决定将要分配的空间由哪一个cinder-volume提供</p><p>cinder-backup备份存储</p><h3 id="controller-5"><a href="#controller-5" class="headerlink" title="controller"></a>controller</h3><h4 id="在控制节点创建Cinder服务数据库-controller"><a href="#在控制节点创建Cinder服务数据库-controller" class="headerlink" title="在控制节点创建Cinder服务数据库(controller)"></a>在控制节点创建Cinder服务数据库(controller)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.登录mysql数据库<br>mysql -u root -p000000<br>b.创建cinder数据库<br>CREATE DATABASE cinder;<br>c.创建cinder数据库用户，使其可以对cinder数据库有完全控制权限<br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;CINDER_DBPASS&#x27;;<br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;CINDER_DBPASS&#x27;;<br>d.退出数据库<br>exit<br></code></pre></div></td></tr></table></figure><h4 id="在keystone创建系统用户-glance-nova-neutron-cinder-关联角色"><a href="#在keystone创建系统用户-glance-nova-neutron-cinder-关联角色" class="headerlink" title="在keystone创建系统用户(glance, nova, neutron,cinder)关联角色"></a>在keystone创建系统用户(glance, nova, neutron,cinder)关联角色</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack user create --domain default --password CINDER_PASS cinder<br>openstack role add --project service --user cinder admin<br></code></pre></div></td></tr></table></figure><h4 id="在keystone上创建服务和注册api-2"><a href="#在keystone上创建服务和注册api-2" class="headerlink" title="在keystone上创建服务和注册api"></a>在keystone上创建服务和注册api</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"> openstack service create --name cinder \<br>  --description &quot;OpenStack Block Storage&quot; volume<br>openstack service create --name cinderv2 \<br>  --description &quot;OpenStack Block Storage&quot; volumev2<br>  <br>openstack endpoint create --region RegionOne \<br>  volume public http://controller:8776/v1/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  volume internal http://controller:8776/v1/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  volume admin http://controller:8776/v1/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 public http://controller:8776/v2/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 internal http://controller:8776/v2/%\(tenant_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 admin http://controller:8776/v2/%\(tenant_id\)s<br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包-1"><a href="#安装服务相应软件包-1" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-cinder<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-7"><a href="#修改配置文件-7" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;cinder&#x2F;cinder.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/cinder/cinder.conf&#123;,.bak&#125;<br>grep -Ev &#x27;^$|#&#x27; /etc/cinder/cinder.conf.bak &gt;/etc/cinder/cinder.conf<br><br>openstack-config --set /etc/cinder/cinder.conf database connection    mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT rpc_backend    rabbit<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_host    controller<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_userid    openstack<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_password    RABBIT_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy    keystone<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_uri    http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url    http://controller:35357<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers    controller:11211<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type    password<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name    default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name    default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name    service<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username    cinder<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password    CINDER_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip  172.16.100.28 ###替换自己IP<br>openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path    /var/lib/cinder/tmp<br></code></pre></div></td></tr></table></figure><h4 id="同步cinder数据库"><a href="#同步cinder数据库" class="headerlink" title="同步cinder数据库"></a>同步cinder数据库</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder<br></code></pre></div></td></tr></table></figure><!--同步后进入数据库查看cinder库是否有数据--><!--忽略警告--><p>修改nova配置文件</p><p><strong>&#x2F;etc&#x2F;nova&#x2F;nova.conf</strong></p><figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino">openstack-config --set /etc/cinder/cinder.conf cinder os_region_name  RegionOne<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-6"><a href="#启动服务-6" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl restart openstack-nova-api.service<br>systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service<br>systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service<br></code></pre></div></td></tr></table></figure><h3 id="compute-5"><a href="#compute-5" class="headerlink" title="compute"></a>compute</h3><h4 id="在计算节点安装存储节点-compute"><a href="#在计算节点安装存储节点-compute" class="headerlink" title="在计算节点安装存储节点(compute)"></a>在计算节点安装存储节点(compute)</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装支持的工具包</span><br>yum -y install lvm2<br>systemctl enable lvm2-lvmetad.service<br>systemctl start lvm2-lvmetad.service<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">在计算节点新建一块硬盘<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##如果在VM添加的硬盘没有扫描出来,用以下命令</span></span><br>echo &#x27;- - -&#x27; &gt;/sys/class/scsi_host/host&#123;0,1,2&#125;/scan<br><br>[root@compute ~]# lsblk<br>NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sr0              11:0    1 1024M  0 rom  <br>vda             252:0    0   80G  0 disk <br>├─vda1          252:1    0    1G  0 part /boot<br>└─vda2          252:2    0   79G  0 part <br>  ├─centos-root 253:0    0 49.9G  0 lvm  /<br>  ├─centos-swap 253:1    0  4.8G  0 lvm  [SWAP]<br>  └─centos-home 253:2    0 24.3G  0 lvm  /home<br>vdb             252:16   0   80G  0 disk  ###新添加的硬盘<br></code></pre></div></td></tr></table></figure><h4 id="创建LVM-物理卷"><a href="#创建LVM-物理卷" class="headerlink" title="创建LVM 物理卷"></a>创建LVM 物理卷</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]#  pvcreate /dev/vdb<br>  Physical volume &quot;/dev/vdb&quot; successfully created.<br></code></pre></div></td></tr></table></figure><h4 id="创建-LVM-卷组-cinder-volumes"><a href="#创建-LVM-卷组-cinder-volumes" class="headerlink" title="创建 LVM 卷组 cinder-volumes"></a>创建 LVM 卷组 cinder-volumes</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@compute ~]# vgcreate cinder-volumes /dev/vdb<br>  Volume group &quot;cinder-volumes&quot; successfully created<br></code></pre></div></td></tr></table></figure><h4 id="添加一个过滤器-只有实例可以访问块存储卷组"><a href="#添加一个过滤器-只有实例可以访问块存储卷组" class="headerlink" title="添加一个过滤器(只有实例可以访问块存储卷组)"></a>添加一个过滤器(只有实例可以访问块存储卷组)</h4><p><strong>&#x2F;etc&#x2F;lvm&#x2F;lvm.conf</strong> </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##大概文件130行左右</span></span><br>filter = [ &quot;a/vdb/&quot;, &quot;r/.*/&quot;]<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####多盘######filter = [ &quot;a/vdb/&quot;, &quot;a/vdc/&quot;, &quot;r/.*/&quot;]</span></span><br></code></pre></div></td></tr></table></figure><h4 id="安装服务相应软件包-2"><a href="#安装服务相应软件包-2" class="headerlink" title="安装服务相应软件包"></a>安装服务相应软件包</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install openstack-cinder targetcli python-keystone<br></code></pre></div></td></tr></table></figure><h4 id="修改配置文件-8"><a href="#修改配置文件-8" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><strong>&#x2F;etc&#x2F;cinder&#x2F;cinder.conf</strong></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cp /etc/cinder/cinder.conf&#123;,.bak&#125;<br>grep -Ev &#x27;^$|#&#x27; /etc/cinder/cinder.conf.bak &gt;/etc/cinder/cinder.conf<br><br>openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT rpc_backend rabbit<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_host controller<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_userid openstack<br>openstack-config --set /etc/cinder/cinder.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_uri http://controller:5000<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:35357<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_name default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_name default<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder<br>openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password CINDER_PASS<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip 172.16.10.29<br>openstack-config --set /etc/cinder/cinder.conf lvm volume_driver cinder.volume.drivers.lvm.LVMVolumeDriver<br>openstack-config --set /etc/cinder/cinder.conf lvm volume_group cinder-volumes<br>openstack-config --set /etc/cinder/cinder.conf lvm iscsi_protocol  iscsi<br>openstack-config --set /etc/cinder/cinder.conf lvm iscsi_helper lioadm<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT enabled_backends lvm<br>openstack-config --set /etc/cinder/cinder.conf DEFAULT glance_api_servers http://controller:9292<br>openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp<br></code></pre></div></td></tr></table></figure><h4 id="启动服务-7"><a href="#启动服务-7" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl enable openstack-cinder-volume.service target.service<br>systemctl start openstack-cinder-volume.service target.service<br></code></pre></div></td></tr></table></figure><h4 id="在controller检查是否成功"><a href="#在controller检查是否成功" class="headerlink" title="在controller检查是否成功"></a>在controller检查是否成功</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@controller ~]# cinder service-list<br>+------------------+-------------+------+---------+-------+----------------------------+-----------------+<br>|      Binary      |     Host    | Zone |  Status | State |         Updated_at         | Disabled Reason |<br>+------------------+-------------+------+---------+-------+----------------------------+-----------------+<br>| cinder-scheduler |  controller | nova | enabled |   up  | 2021-11-24T02:01:16.000000 |        -        |<br>|  cinder-volume   | compute@lvm | nova | enabled |   up  | 2021-11-24T02:01:23.000000 |        -        |<br>+------------------+-------------+------+---------+-------+----------------------------+-----------------+<br></code></pre></div></td></tr></table></figure><h2 id="启动一个实例"><a href="#启动一个实例" class="headerlink" title="启动一个实例"></a>启动一个实例</h2><h3 id="1-创建网络"><a href="#1-创建网络" class="headerlink" title="1.创建网络"></a>1.创建网络</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">neutron net-create --shared --provider:physical_network provider  --provider:network_type flat zzz<br>neutron subnet-create --name  zzz123\<br>  --allocation-pool start=172.16.100.101,end=172.16.100.250 \<br>  --dns-nameserver 114.114.114.114 --gateway 172.16.100.254 \<br>   zzz 172.16.100.0/24<br></code></pre></div></td></tr></table></figure><h3 id="2-创建云主机的硬件配置方案"><a href="#2-创建云主机的硬件配置方案" class="headerlink" title="2.创建云主机的硬件配置方案"></a>2.创建云主机的硬件配置方案</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano<br></code></pre></div></td></tr></table></figure><h3 id="3-创建密钥对"><a href="#3-创建密钥对" class="headerlink" title="3.创建密钥对"></a>3.创建密钥对</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ssh-keygen -q -N &quot;&quot; -f ~/.ssh/id_rsa<br>openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey<br>验证是否添加:  openstack keypair list<br></code></pre></div></td></tr></table></figure><h3 id="4-创建安全组规则"><a href="#4-创建安全组规则" class="headerlink" title="4.创建安全组规则"></a>4.创建安全组规则</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">允许 ICMP (ping)：<br>openstack security group rule create --proto icmp default<br>允许安全 shell (SSH) 的访问：<br>openstack security group rule create --proto tcp --dst-port 22 default<br></code></pre></div></td></tr></table></figure><h3 id="5-启动一个实例"><a href="#5-启动一个实例" class="headerlink" title="5.启动一个实例"></a>5.启动一个实例</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">查看网络id:  neutron net-list<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##网络id=PROVIDER_NET_ID</span></span><br>创建实例:<br>openstack server create --flavor m1.nano --image cirros \<br>  --nic net-id=PROVIDER_NET_ID --security-group default \<br>  --key-name mykey provider-instance<br>  <br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##查看已创建实例###</span></span><br>[root@controller ~]# openstack server list<br>+--------------------------------------+-------------------+--------+--------------------+<br>| ID                                   | Name              | Status | Networks           |<br>+--------------------------------------+-------------------+--------+--------------------+<br>| f6fa8d1a-13e7-46c9-b5e3-78cfdc3497d5 | provider-instance | ACTIVE | zzz=172.16.100.102 |<br>+--------------------------------------+-------------------+--------+--------------------+<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>openstack-M</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker</title>
    <link href="/2022/04/17/docker/"/>
    <url>/2022/04/17/docker/</url>
    
    <content type="html"><![CDATA[<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的Linux或Windows操作系统的机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。</p><h2 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install yum-utils device-mapper-persistent-data lvm2 gcc<br>yum-config-manager--add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum makecache fast<br>yum -y install docker-ce<br></code></pre></div></td></tr></table></figure><h3 id="配置加速"><a href="#配置加速" class="headerlink" title="配置加速"></a>配置加速</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">mkdir -p /etc/docker#创建文件夹<br>cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://hxqazmaw.mirror.aliyuncs.com&quot;]<br>&#125;<br>EOF<br></code></pre></div></td></tr></table></figure><h3 id="查看docker进程"><a href="#查看docker进程" class="headerlink" title="查看docker进程"></a>查看docker进程</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ps -ef|grep docker<br></code></pre></div></td></tr></table></figure><h3 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl start docker<br>systemctl enable docker<br>systemctl status docker<br></code></pre></div></td></tr></table></figure><h2 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker version<br>docker info<br>docker --help<br></code></pre></div></td></tr></table></figure><h2 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker images<br>-a：列出本地所有的镜像（含中间映像层）<br>-q：只显示镜像ID<br>--digests:显示镜像的摘要信息<br>--no-trunc:显示完整的镜像信息<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker search镜像名字（查看镜像）<br>--no-trunc:显示完整的镜像描述<br>-s:列出收藏数不小于指定值的镜像<br>--automated:只列出automated build类型的镜像<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker pull镜像名字（下载镜像）<br>docker pull镜像名字[:TAG](版本号，否则为最新版本)<br></code></pre></div></td></tr></table></figure><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">删除镜像<br>删除单个docker rmi -f 镜像ID<br>删除多个docker rmi -f 镜像名1：TAG 镜像名2：TAG<br>删除全部docker rmi -f $(docker images -qa)<br></code></pre></div></td></tr></table></figure><h3 id="镜像commit"><a href="#镜像commit" class="headerlink" title="镜像commit"></a>镜像commit</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Docker commit -a=”作者” -m=”提交的描述信息” 容器ID 要创建的目标镜像名:[标签名]<br></code></pre></div></td></tr></table></figure><h2 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h2><h3 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Docker run<br>--name=“容器新名字”：为容器指定一个名称<br>-d:后台运行容器，并返回容器ID，也即启动守护式容器<br>-i:以交互模式运行容器，通常与-t同时使用<br>-t:为容器重新分配一个伪输入终端，通常与-i同时使用<br>-P:随机端口映射<br>-p:指定端口映射，有以下四种格式<br>Ip：hostPort:containerPort<br>Ip::containerPOrt<br>HostPort:containerPort<br>containerPort<br></code></pre></div></td></tr></table></figure><h3 id="docker-ps"><a href="#docker-ps" class="headerlink" title="docker ps"></a>docker ps</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Docker ps<br>-a:列出当前所有正在运行的容器+历史上运行过的<br>-l:上一个运行的<br>-n:显示最近n个创建的容器<br>-q:静默模式，只显示容器编号<br>--no-trunc:不截断输出<br></code></pre></div></td></tr></table></figure><h3 id="操作容器"><a href="#操作容器" class="headerlink" title="操作容器"></a>操作容器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">启动容器：docker start 容器ID或容器名<br>重启容器：docker restart 容器ID或容器名<br>停止容器：docker stop 容器ID或容器名<br>强制停止容器：docker kill 容器ID或容器名<br>删除已停止容器：docker rm 容器ID（-f 强制）<br></code></pre></div></td></tr></table></figure><h3 id="一次性删除多个容器"><a href="#一次性删除多个容器" class="headerlink" title="一次性删除多个容器"></a>一次性删除多个容器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Docker rm -f$(docker ps -a  -q)<br>Docker ps -a -q |xargs docker rm<br></code></pre></div></td></tr></table></figure><h3 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a>退出容器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Exit<br>Ctrl+P+Q<br></code></pre></div></td></tr></table></figure><h3 id="启动守护式容器"><a href="#启动守护式容器" class="headerlink" title="启动守护式容器"></a>启动守护式容器</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker run -d  容器名<br></code></pre></div></td></tr></table></figure><h3 id="查看容器日志"><a href="#查看容器日志" class="headerlink" title="查看容器日志"></a>查看容器日志</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker logs -t -f --tail 容器ID<br><br>-t是加入时间戳<br>-f跟随最新的日志打印<br>--tail 数字 显示最后多少条<br></code></pre></div></td></tr></table></figure><h3 id="查看容器内部细节"><a href="#查看容器内部细节" class="headerlink" title="查看容器内部细节"></a>查看容器内部细节</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker inspect 容器ID<br></code></pre></div></td></tr></table></figure><h3 id="进入正在运行的容器以命令行交互"><a href="#进入正在运行的容器以命令行交互" class="headerlink" title="进入正在运行的容器以命令行交互"></a>进入正在运行的容器以命令行交互</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Docker exec -it 容器ID <br>docker attach 容器ID<br><br>Attach：直接进入容器启动命令终端，不会启动新的进程<br>Exec：是在容 器中打开新的终端，并且可以启动新的进程<br></code></pre></div></td></tr></table></figure><h3 id="从容器内拷贝文件到主机上"><a href="#从容器内拷贝文件到主机上" class="headerlink" title="从容器内拷贝文件到主机上"></a>从容器内拷贝文件到主机上</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker cp 容器ID：容器内路径 目的主机路径<br></code></pre></div></td></tr></table></figure><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>Dockerfile 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明</p><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><table><thead><tr><th>Build</th><th>Both</th><th>Run</th></tr></thead><tbody><tr><td>FROM</td><td>WORKDIR</td><td>CMD</td></tr><tr><td>MAINTAINER</td><td>USER</td><td>ENV</td></tr><tr><td>COPY</td><td></td><td>EXPOSE</td></tr><tr><td>ADD</td><td></td><td>VOLUME</td></tr><tr><td>RUN</td><td></td><td>ENTRYPOINT</td></tr><tr><td>ONBUILD</td><td></td><td></td></tr><tr><td>.dockerignore</td><td></td><td></td></tr></tbody></table><h2 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a>命令详解</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">FROM 基础镜像,当前新镜像是基于哪个镜像的<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">MAINTAINER 镜像维护者的姓名和邮箱地址<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">RUN 容器构建时需要运行的命令<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">EXPOSE当前容器对外暴露出的端口<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">WORKDIR指定在创建容器后,终端默认登入进来的工作目录,一个落脚点<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ENV用来在构建镜像过程中设置环境变量<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ADD将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar压缩包<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">COPY类似ADD,拷贝文件和目录到镜像中<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">VOLUME容器数据卷,用于数据保存和持久化工作<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">CMD指定一个容器启动时要运行的命令,可以有多个CMD,但只有最后一个生效<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ENTRYPOINT指定一个容器启动时要运行的命令,目的和CMD一样,但多个都会生效<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ONBUILD当构建一个被继承的Dockerfile时运行命令,父镜像在被子继承后父镜像的onbuild被触发<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker learn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>github-error</title>
    <link href="/2022/04/17/github-error/"/>
    <url>/2022/04/17/github-error/</url>
    
    <content type="html"><![CDATA[<h2 id="1-error"><a href="#1-error" class="headerlink" title="1.error"></a>1.error</h2><figure class="highlight avrasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs avrasm"><span class="hljs-symbol">fatal:</span> 不是 git 仓库（或者任何父目录）：.git<br></code></pre></div></td></tr></table></figure><p>解决:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vim _config.yml<br><br>highlight:<br>  enable: flash<br></code></pre></div></td></tr></table></figure><h2 id="2-error"><a href="#2-error" class="headerlink" title="2.error"></a>2.error</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ERROR Deployer not found: git<br></code></pre></div></td></tr></table></figure><p>解决:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install hexo-deployer-git --save<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>github+hexo error</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go</title>
    <link href="/2022/04/17/go/"/>
    <url>/2022/04/17/go/</url>
    
    <content type="html"><![CDATA[<h1 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h1><p>###编译型语言</p><p>*特点</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">1.语法简洁<br>2.开发效率高<br>3.执行性能好<br></code></pre></div></td></tr></table></figure><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><h3 id="go-build"><a href="#go-build" class="headerlink" title="go build"></a>go build</h3><p>1.在项目目录下执行go build</p><p>2.在其他路径下执行go build，需要在后面加上项目的路径（项目路径从GOPATH&#x2F;src后开始写起，编译之后的可执行文件就保存在当前目录下）</p><p>3.go build -o hello.exe</p><h3 id="go-run"><a href="#go-run" class="headerlink" title="go run"></a>go run</h3><p>像执行脚本文件一样执行Go代码</p><h3 id="go-install"><a href="#go-install" class="headerlink" title="go install"></a>go install</h3><p>go install 分为两步:<br>1.先编译得到一个可执行文件<br>2.将执行文件拷贝到<code>GOPATH/bin</code></p><h3 id="跨平台编译"><a href="#跨平台编译" class="headerlink" title="跨平台编译"></a>跨平台编译</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">SET CGO_ENABLED=0  // 禁用CGO<br>SET GOOS=windows  // 目标平台是windows<br>SET GOARCH=amd64  // 目标处理器架构是amd64<br><br><span class="hljs-comment">#Windows编译Mac可执行文件</span><br>SET CGO_ENABLED=0<br>SET GOOS=darwin<br>SET GOARCH=amd64<br>go build<br><br><span class="hljs-comment">#PowerShell</span><br><span class="hljs-comment">##使用环境变量的语法</span><br><span class="hljs-variable">$ENV</span>:CGO_ENABLED=0<br><span class="hljs-variable">$ENV</span>:GOOS=<span class="hljs-string">&quot;darwin&quot;</span><br><span class="hljs-variable">$ENV</span>:GOARCH=<span class="hljs-string">&quot;amd64&quot;</span><br>go build<br><br><span class="hljs-comment">#Linux编译Windows可执行文件</span><br>CGO_ENABLED=0 <br>GOOS=windows <br>GOARCH=amd64 <br>go build<br><br><span class="hljs-comment">#Linux编译Mac可执行文件</span><br>CGO_ENABLED=0 <br>GOOS=darwin <br>GOARCH=amd64 <br>go build<br><br><span class="hljs-comment">#Mac编译Linux可执行文件</span><br><span class="hljs-built_in">export</span> CGO_ENABLED=0 <br><span class="hljs-built_in">export</span> GOOS=linux <br><span class="hljs-built_in">export</span> GOARCH=amd64 <br>go build<br><br><span class="hljs-comment">#Mac编译Windows可执行文件</span><br><span class="hljs-built_in">export</span> CGO_ENABLED=0 <br><span class="hljs-built_in">export</span> GOOS=windows <br><span class="hljs-built_in">export</span> GOARCH=amd64 <br>go build<br></code></pre></div></td></tr></table></figure><h3 id="go语言中有25个关键字"><a href="#go语言中有25个关键字" class="headerlink" title="go语言中有25个关键字"></a>go语言中有25个关键字</h3><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">break</span>        <span class="hljs-keyword">default</span>      <span class="hljs-function"><span class="hljs-keyword">func</span>         <span class="hljs-title">interface</span>    <span class="hljs-title">select</span></span><br><span class="hljs-keyword">case</span>         <span class="hljs-keyword">defer</span>        <span class="hljs-keyword">go</span>           <span class="hljs-keyword">map</span>          <span class="hljs-keyword">struct</span><br><span class="hljs-keyword">chan</span>         <span class="hljs-keyword">else</span>         <span class="hljs-keyword">goto</span>         <span class="hljs-keyword">package</span>      <span class="hljs-keyword">switch</span><br><span class="hljs-keyword">const</span>        <span class="hljs-keyword">fallthrough</span>  <span class="hljs-keyword">if</span>           <span class="hljs-keyword">range</span>        <span class="hljs-keyword">type</span><br><span class="hljs-keyword">continue</span>     <span class="hljs-keyword">for</span>          <span class="hljs-keyword">import</span>       <span class="hljs-keyword">return</span>       <span class="hljs-keyword">var</span><br></code></pre></div></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">注意事项：<br><br>1. 函数外的每个语句都必须以关键字开始（var、const、func等）<br>2. `:=`不能使用在函数外。<br>3. `_`多用于占位，表示忽略值。<br></code></pre></div></td></tr></table></figure><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">var 变量声明<br><br>匿名变量  在使用多重赋值时，如果想要忽略某个值，可以使用匿名变量（anonymous variable）。 匿名变量用一个下划线_表示,匿名变量不占用命名空间，不会分配内存，所以匿名变量之间不存在重复声明。<br><br>const相对于变量，常量是恒定不变的值，多用于定义程序运行期间不会改变的那些值。 常量的声明和变量声明非常类似，只是把var换成了const，常量在定义的时候必须赋值。<br><br>iost 是go语言的常量计数器，只能在常量的表达式中使用。<br></code></pre></div></td></tr></table></figure><table><thead><tr><th align="center">转义符</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center"><code>\r</code></td><td align="center">回车符（返回行首）</td></tr><tr><td align="center"><code>\n</code></td><td align="center">换行符（直接跳到下一行的同列位置）</td></tr><tr><td align="center"><code>\t</code></td><td align="center">制表符</td></tr><tr><td align="center"><code>\&#39;</code></td><td align="center">单引号</td></tr><tr><td align="center"><code>\&quot;</code></td><td align="center">双引号</td></tr><tr><td align="center"><code>\\</code></td><td align="center">反斜杠</td></tr></tbody></table><table><thead><tr><th>格式化指令</th><th>含义</th></tr></thead><tbody><tr><td>%%</td><td>%字面量</td></tr><tr><td>%b</td><td>一个二进制整数，将一个整数格式转化为二进制的表达方式</td></tr><tr><td>%c</td><td>一个Unicode的字符</td></tr><tr><td>%d</td><td>十进制整数</td></tr><tr><td>%o</td><td>八进制整数</td></tr><tr><td>%x</td><td>小写的十六进制数值</td></tr><tr><td>%X</td><td>大写的十六进制数值</td></tr><tr><td>%U</td><td>一个Unicode表示法表示的整型码值</td></tr><tr><td>%s</td><td>输出以原生的UTF8字节表示的字符，如果console不支持utf8编码，则会乱码</td></tr><tr><td>%t</td><td>以true或者false的方式输出布尔值</td></tr><tr><td>%v</td><td>使用默认格式输出值，或者如果方法存在，则使用类性值的String()方法输出自定义值</td></tr><tr><td>%T</td><td>输出值的类型</td></tr></tbody></table><p><strong>var</strong>（声明变量）</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">//声明变量</span><br><span class="hljs-comment">// var name string</span><br><span class="hljs-comment">// var age int</span><br><span class="hljs-comment">// yes  bool</span><br><br><span class="hljs-comment">// 批量声明</span><br><span class="hljs-keyword">var</span> (<br>name <span class="hljs-type">string</span> <span class="hljs-comment">// “”</span><br>age  <span class="hljs-type">int</span>    <span class="hljs-comment">// 0</span><br>yes  <span class="hljs-type">bool</span>   <span class="hljs-comment">// false</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>name = <span class="hljs-string">&quot;zzz&quot;</span><br>age = <span class="hljs-number">18</span><br>yes = <span class="hljs-literal">true</span><br><span class="hljs-comment">// var zyl int</span><br><span class="hljs-comment">// Go语言中非全局变量声明后必须使用,不使用就编译不过去</span><br>fmt.Print(yes)                <span class="hljs-comment">//在终端输出要打印的内容</span><br>fmt.Printf(<span class="hljs-string">&quot;name:%s\n&quot;</span>, name) <span class="hljs-comment">// %s是占位符 使用name变量值去替换%s</span><br>fmt.Println(age)              <span class="hljs-comment">// 打印完指定的内容之后会在后面加一个换行符</span><br><br><span class="hljs-comment">// 声明变量同时赋值</span><br><span class="hljs-keyword">var</span> zyl <span class="hljs-type">string</span> = <span class="hljs-string">&quot;test&quot;</span><br>fmt.Println(zyl)<br><br><span class="hljs-comment">// 类型推倒（根据值判断该变量是什么类型）</span><br><span class="hljs-keyword">var</span> age1 = <span class="hljs-string">&quot;20&quot;</span><br>fmt.Println(age1)<br><br><span class="hljs-comment">// 简短变量声明,只能在函数中声明</span><br>s1 := <span class="hljs-string">&quot;哈哈哈&quot;</span><br>fmt.Println(s1)<br><span class="hljs-comment">// 同一个作用域(&#123;&#125;)中不能重复声明同名变量</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="if-和-for"><a href="#if-和-for" class="headerlink" title="if 和 for"></a>if 和 for</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>score := <span class="hljs-number">65</span><br><span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;A&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt; <span class="hljs-number">75</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;B&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;C&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">demo1</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> score := <span class="hljs-number">65</span>; score &gt;= <span class="hljs-number">90</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;A&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt; <span class="hljs-number">75</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;B&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;C&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">demo2</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>fmt.Println(i)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">demo3</span><span class="hljs-params">()</span></span> &#123;<br>i := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>fmt.Println(i)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 无限循环</span><br><span class="hljs-comment">// for &#123;</span><br><span class="hljs-comment">//     循环体语句</span><br><span class="hljs-comment">// &#125;</span><br></code></pre></div></td></tr></table></figure><p>for range：</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>fmt.Println(i)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s := <span class="hljs-string">&quot;hello 世界！&quot;</span><br><span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> s &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%d %c\n&quot;</span>, i, v)<br>&#125;<br>&#125;<br><span class="hljs-comment">//九九乘法表</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt;= i; j++ &#123;<br>q := i * j<br>fmt.Printf(<span class="hljs-string">&quot;%d*%d=%d &quot;</span>, j, i, q)<br>&#125;<br>fmt.Println()<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="const-into"><a href="#const-into" class="headerlink" title="const into"></a>const into</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// 常量定义</span><br><span class="hljs-keyword">const</span> pi = <span class="hljs-number">3.1415926</span><br><br><span class="hljs-comment">// 多常量定义</span><br><span class="hljs-keyword">const</span> (<br>n1 = <span class="hljs-number">100</span><br>n2<br>n3<br>)<br><br><span class="hljs-comment">// iota是go语言的常量计数器，只能在常量的表达式中使用。</span><br><span class="hljs-comment">// iota在const关键字出现时将被重置为0。const中每新增一行常量声明将使iota计数一次(iota可理解为const语句块中的行索引)。 使用iota能简化定义，在定义枚举时很有用。</span><br><span class="hljs-comment">// 定义数量级</span><br><span class="hljs-keyword">const</span> (<br>_  = <span class="hljs-literal">iota</span><br>KB = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">10</span> * <span class="hljs-literal">iota</span>)<br>MB = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">10</span> * <span class="hljs-literal">iota</span>)<br>GB = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">10</span> * <span class="hljs-literal">iota</span>)<br>TB = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">10</span> * <span class="hljs-literal">iota</span>)<br>PB = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">10</span> * <span class="hljs-literal">iota</span>)<br>)<br><br><span class="hljs-comment">// iota</span><br><span class="hljs-keyword">const</span> (<br>a1 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//0</span><br>a2        <span class="hljs-comment">//1</span><br>a3        <span class="hljs-comment">//2</span><br>a4        <span class="hljs-comment">//3</span><br>)<br><br><span class="hljs-comment">// _跳过某些值</span><br><span class="hljs-keyword">const</span> (<br>b1 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//0</span><br>b2        <span class="hljs-comment">//1</span><br>_<br>b3 <span class="hljs-comment">//3</span><br>)<br><br><span class="hljs-comment">// iota声明中间隔常量</span><br><span class="hljs-keyword">const</span> (<br>c1 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//0</span><br>c2 = <span class="hljs-number">100</span>  <span class="hljs-comment">//100</span><br>c3 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//2</span><br>c4        <span class="hljs-comment">//3</span><br>)<br><span class="hljs-keyword">const</span> n5 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//0</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// fmt.Println(n1)</span><br><span class="hljs-comment">// fmt.Println(n2)</span><br><span class="hljs-comment">// fmt.Println(n3)</span><br><br>fmt.Println(<span class="hljs-string">&quot;a1:&quot;</span>, a1)<br>fmt.Println(<span class="hljs-string">&quot;a2:&quot;</span>, a2)<br>fmt.Println(<span class="hljs-string">&quot;a3:&quot;</span>, a3)<br>fmt.Println(<span class="hljs-string">&quot;a4:&quot;</span>, a4)<br><br>fmt.Println(<span class="hljs-string">&quot;b1:&quot;</span>, b1)<br>fmt.Println(<span class="hljs-string">&quot;b2:&quot;</span>, b2)<br>fmt.Println(<span class="hljs-string">&quot;b3:&quot;</span>, b3)<br><br>fmt.Println(<span class="hljs-string">&quot;c1:&quot;</span>, c1)<br>fmt.Println(<span class="hljs-string">&quot;c2:&quot;</span>, c2)<br>fmt.Println(<span class="hljs-string">&quot;c3:&quot;</span>, c3)<br>fmt.Println(<span class="hljs-string">&quot;c4:&quot;</span>, c4)<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="switch和goto"><a href="#switch和goto" class="headerlink" title="switch和goto"></a>switch和goto</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">//switch</span><br><span class="hljs-comment">//简化大量的判断 （一个变量和具体的做比较）</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> n = <span class="hljs-number">5</span><br><span class="hljs-comment">// if n == 1 &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;大拇指&quot;)</span><br><span class="hljs-comment">// &#125; else if n == 2 &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;食指&quot;)</span><br><span class="hljs-comment">// &#125; else if n == 3 &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;中指&quot;)</span><br><span class="hljs-comment">// &#125; else if n == 4 &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;无名指&quot;)</span><br><span class="hljs-comment">// &#125; else if n == 5 &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;小母指&quot;)</span><br><span class="hljs-comment">// &#125; else &#123;</span><br><span class="hljs-comment">// fmt.Println(&quot;判断错误！&quot;)</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-comment">// switch 简化</span><br><span class="hljs-keyword">switch</span> n &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>fmt.Println(<span class="hljs-string">&quot;大拇指&quot;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>fmt.Println(<span class="hljs-string">&quot;食指&quot;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>fmt.Println(<span class="hljs-string">&quot;中指&quot;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>fmt.Println(<span class="hljs-string">&quot;无名指&quot;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>fmt.Println(<span class="hljs-string">&quot;小母指&quot;</span>)<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;判断错误！&quot;</span>)<br>&#125;<br><span class="hljs-comment">// goto+label实现跳出多层for循环</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br><span class="hljs-keyword">for</span> j := <span class="hljs-string">&#x27;A&#x27;</span>; j &lt; <span class="hljs-string">&#x27;Z&#x27;</span>; j++ &#123;<br><span class="hljs-keyword">if</span> j == <span class="hljs-string">&#x27;D&#x27;</span> &#123;<br><span class="hljs-keyword">goto</span> xx <span class="hljs-comment">//跳出循环到指定的标签</span><br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%d %c\n&quot;</span>, i, j)<br>&#125;<br>&#125;<br>xx: <span class="hljs-comment">//label标签</span><br>fmt.Println(<span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="Array-数组"><a href="#Array-数组" class="headerlink" title="Array(数组)"></a>Array(数组)</h2><p>数组是同一种数据类型元素的集合。 在Go语言中，数组从声明时就确定，使用时可以修改数组成员，但是数组大小不可变化。 基本语法：</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// 定义一个长度为3元素类型为int的数组a</span><br><span class="hljs-keyword">var</span> a [<span class="hljs-number">3</span>]<span class="hljs-type">int</span><br></code></pre></div></td></tr></table></figure><p>数组定义：</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">var</span> 数组变量名 [元素数量]T<br></code></pre></div></td></tr></table></figure><p><strong>eg：</strong></p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">//数组</span><br><span class="hljs-comment">//存放元素的容器</span><br><span class="hljs-comment">//必须指定存放的元素的类型和容量（长度）</span><br><span class="hljs-comment">//数组的长度是数组类型的一部分</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> a1 [<span class="hljs-number">3</span>]<span class="hljs-type">bool</span><br><span class="hljs-keyword">var</span> a2 [<span class="hljs-number">4</span>]<span class="hljs-type">bool</span><br>fmt.Printf(<span class="hljs-string">&quot;类型：a1:%T a2:%T\n&quot;</span>, a1, a2)<br><br><span class="hljs-comment">//数组初始化</span><br><span class="hljs-comment">//数组不初始化默认元素为零（布偶值:false,整型和浮点型都是0,字符串:&quot;&quot;）</span><br>fmt.Println(<span class="hljs-string">&quot;默认值：&quot;</span>, a1, a2)<br><br><span class="hljs-comment">//初始化</span><br><br><span class="hljs-comment">//方式一</span><br>a1 = [<span class="hljs-number">3</span>]<span class="hljs-type">bool</span>&#123;<span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>&#125;<br>fmt.Println(<span class="hljs-string">&quot;方式一:&quot;</span>, a1)<br><br><span class="hljs-comment">//方式二</span><br><span class="hljs-comment">// 根据初始值自动判断数组的长度是多少</span><br>a10 := [...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>&#125;<br>fmt.Println(<span class="hljs-string">&quot;方式二:&quot;</span>, a10)<br><br><span class="hljs-comment">//方式三</span><br><span class="hljs-comment">//根据索引来初始化</span><br>a3 := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br>fmt.Println(<span class="hljs-string">&quot;方式三:&quot;</span>, a3)<br>a4 := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>: <span class="hljs-number">1</span>, <span class="hljs-number">4</span>: <span class="hljs-number">2</span>&#125;<br>fmt.Println(<span class="hljs-string">&quot;方式三:&quot;</span>, a4)<br><br><span class="hljs-comment">// //数组的遍历</span><br><span class="hljs-comment">// citys := [...]string&#123;&quot;北京&quot;, &quot;上海&quot;, &quot;深圳&quot;&#125;</span><br><span class="hljs-comment">// //1.根据索引遍历</span><br><span class="hljs-comment">// for i := 0; i &lt; len(citys); i++ &#123;</span><br><span class="hljs-comment">// fmt.Println(citys[i])</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-comment">// for i, v := range citys &#123;</span><br><span class="hljs-comment">// fmt.Println(i, v)</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">//多维数组</span><br><span class="hljs-keyword">var</span> a5 [<span class="hljs-number">3</span>][<span class="hljs-number">2</span>]<span class="hljs-type">int</span><br>a5 = [<span class="hljs-number">3</span>][<span class="hljs-number">2</span>]<span class="hljs-type">int</span>&#123;<br>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;,<br>&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;,<br>&#123;<span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;,<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;多维数组：&quot;</span>,a5)<br><br><span class="hljs-comment">//多维数组遍历</span><br>fmt.Println(<span class="hljs-string">&quot;多维数组遍历:&quot;</span>)<br><span class="hljs-keyword">for</span> _,v1 := <span class="hljs-keyword">range</span> a5 &#123;<br>fmt.Println(v1)<br><span class="hljs-keyword">for</span> _,v2 := <span class="hljs-keyword">range</span> v1&#123;<br>fmt.Println(v2)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="slice-切片"><a href="#slice-切片" class="headerlink" title="slice(切片)"></a>slice(切片)</h2><p>切片的本质</p><p>切片就是一个框，框住了一块连续的内存</p><p>切片属于引用类型，真正的数据都是保存在底层数组里的</p><p>判断一个切片是否为空,要使用len(s) &#x3D;&#x3D; 0 来判断</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// 切片slice</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// 切片定义</span><br><span class="hljs-keyword">var</span> a1 []<span class="hljs-type">int</span>    <span class="hljs-comment">//定义一个存放int类型元素的切片</span><br><span class="hljs-keyword">var</span> a2 []<span class="hljs-type">string</span> <span class="hljs-comment">//定义一个存放string类型元素的切片</span><br>fmt.Println(a1, a2)<br>fmt.Println(a1 == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// nil==null</span><br>fmt.Println(a2 == <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">//初始化</span><br>a1 = []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>a2 = []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;哈哈&quot;</span>, <span class="hljs-string">&quot;嘿嘿&quot;</span>, <span class="hljs-string">&quot;哦噢&quot;</span>&#125;<br>fmt.Println(a1, a2)<br>fmt.Println(a1 == <span class="hljs-literal">nil</span>)<br>fmt.Println(a2 == <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">//长度和容量(len cap)</span><br>fmt.Printf(<span class="hljs-string">&quot;len(a1):%d cap(a1):%d\n&quot;</span>, <span class="hljs-built_in">len</span>(a1), <span class="hljs-built_in">cap</span>(a1))<br>fmt.Printf(<span class="hljs-string">&quot;len(a2):%d cap(a2):%d\n&quot;</span>, <span class="hljs-built_in">len</span>(a2), <span class="hljs-built_in">cap</span>(a2))<br><span class="hljs-comment">//切片的容量是指从底层数组切片的第一个元素到最后一个元素</span><br>    <br>   <span class="hljs-comment">//make() 函数创造切片</span><br>a3 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>)<br>fmt.Printf(<span class="hljs-string">&quot;a3=%v len:%d cap:%d\n&quot;</span>, a3, <span class="hljs-built_in">len</span>(a3), <span class="hljs-built_in">cap</span>(a3))<br><br>a4 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>)<br>fmt.Printf(<span class="hljs-string">&quot;a4=%v len:%d cap:%d\n&quot;</span>, a4, <span class="hljs-built_in">len</span>(a4), <span class="hljs-built_in">cap</span>(a4))<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="append"><a href="#append" class="headerlink" title="append()"></a>append()</h3><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// append()为切片追加元素</span><br><br>a5 := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;<br><span class="hljs-comment">// a5[5] = 6 //错误写法 索引越界</span><br><span class="hljs-comment">// append追加元素，原来底层数组放不下的时候，GO底层就会把底层数组换一个</span><br>a5 = <span class="hljs-built_in">append</span>(a5, <span class="hljs-number">6</span>) <span class="hljs-comment">// 调用append函数必须用原来的切片变量接收返回值</span><br>fmt.Printf(<span class="hljs-string">&quot;a5=%v len(a5)=%d cap(a5)=%d\n&quot;</span>, a5, <span class="hljs-built_in">len</span>(a5), <span class="hljs-built_in">cap</span>(a5))<br><br>aa := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span> , <span class="hljs-number">10</span>&#125;<br>a5 = <span class="hljs-built_in">append</span>(a5, aa...) <span class="hljs-comment">// ...表示拆开</span><br>fmt.Printf(<span class="hljs-string">&quot;a5=%v len(a5)=%d cap(a5)=%d\n&quot;</span>, a5, <span class="hljs-built_in">len</span>(a5), <span class="hljs-built_in">cap</span>(a5))<br></code></pre></div></td></tr></table></figure><p>切片扩容策略</p><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">首先判断，如果新申请容量（cap）大于2倍的旧容量（old.cap），最终容量（newcap）就是新申请的容量（cap）。<br>否则判断，如果旧切片的长度小于1024，则最终容量(newcap)就是旧容量(old.cap)的两倍，即（newcap=doublecap），<br>否则判断，如果旧切片长度大于等于1024，则最终容量（newcap）从旧容量（old.cap）开始循环增加原来的1/4，即（newcap=old.cap,for &#123;newcap += newcap/4&#125;）直到最终容量（newcap）大于等于新申请的容量(cap)，即（newcap &gt;= cap）<br>如果最终容量（cap）计算值溢出，则最终容量（cap）就是新申请容量（cap）。<br>注意：切片扩容还会根据切片中元素的类型不同而做不同的处理，比如int和string类型的处理方式就不一样。<br></code></pre></div></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go">newcap := old.<span class="hljs-built_in">cap</span><br>doublecap := newcap + newcap<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &gt; doublecap &#123;<br>newcap = <span class="hljs-built_in">cap</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> old.<span class="hljs-built_in">len</span> &lt; <span class="hljs-number">1024</span> &#123;<br>newcap = doublecap<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Check 0 &lt; newcap to detect overflow</span><br><span class="hljs-comment">// and prevent an infinite loop.</span><br><span class="hljs-keyword">for</span> <span class="hljs-number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="hljs-built_in">cap</span> &#123;<br>newcap += newcap / <span class="hljs-number">4</span><br>&#125;<br><span class="hljs-comment">// Set newcap to the requested cap when</span><br><span class="hljs-comment">// the newcap calculation overflowed.</span><br><span class="hljs-keyword">if</span> newcap &lt;= <span class="hljs-number">0</span> &#123;<br>newcap = <span class="hljs-built_in">cap</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="copy"><a href="#copy" class="headerlink" title="copy()"></a>copy()</h3><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus"><span class="hljs-comment">// copy()复制切片</span><br>a6 := a5<br><span class="hljs-selector-tag">var</span> a7 = <span class="hljs-built_in">make</span>(<span class="hljs-selector-attr">[]</span>int,<span class="hljs-number">10</span>,<span class="hljs-number">10</span>) <span class="hljs-comment">//需要计算好长度和容量</span><br><span class="hljs-function"><span class="hljs-title">copy</span><span class="hljs-params">(a7, a5)</span></span><br>fmt<span class="hljs-selector-class">.Println</span>(a6,a7)<br></code></pre></div></td></tr></table></figure><h2 id="数组和切片的区别"><a href="#数组和切片的区别" class="headerlink" title="数组和切片的区别"></a>数组和切片的区别</h2><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">1.声明方式不同，数组声明需要指定长度（无论是显式指定还是编译器根据元素个数推断都是指定），切片则不用；<br><br>2.数组长度固定，无法改变，切片长度不固定，可以自动扩容；<br><br>3.数组是值类型，切片是引用类型。数组在作为参数传递时，是直接在内存中拷贝了一份数据进行传递，切片则传递的是引用地址，所以在方法中对数组进行修改不会影响原数组，而切片则会受影响；<br><br>4.切片可以用cap函数计算容量、len函数计算长度，数组只有len函数计算长度，换句话说，切片比数组多一个cap属性；<br><br>5.切片的底层是数组。<br><br>数组作为参数传递不会影响原数组的前提是：数组里面的元素不是指针，因为如果传递的数组里面的元素是指针，那么通过修改元素指针指向的值，也会影响到原数组中的数据。还有一种情况就是，将数组的指针作为参数传递，这样也会影响到原数组，但是这个实际上已经不是数组作为参数传递了，而是指针作为参数传递。<br></code></pre></div></td></tr></table></figure><h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><figure class="highlight text"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">&amp;：取地址<br>*：根据地址取值<br></code></pre></div></td></tr></table></figure><h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><p>map是一种无序的基于<code>key-value</code>的数据结构，Go语言中的map是引用类型，必须初始化才能使用。</p><p>map类型的变量默认初始值为nil，需要使用make()函数来分配内存。语法为：</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[KeyType]ValueType, [<span class="hljs-built_in">cap</span>])<br></code></pre></div></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, <span class="hljs-number">5</span>)<br>a[<span class="hljs-string">&quot;哈哈&quot;</span>] = <span class="hljs-number">100</span><br>a[<span class="hljs-string">&quot;哦噢&quot;</span>] = <span class="hljs-number">101</span><br>a[<span class="hljs-string">&quot;阿阿&quot;</span>] = <span class="hljs-number">102</span><br>fmt.Println(a[<span class="hljs-string">&quot;哈哈&quot;</span>])<br>fmt.Printf(<span class="hljs-string">&quot;type(a):%T\n&quot;</span>, a)<br><br><span class="hljs-comment">// map支持在声明的时候填充元素</span><br>a1 := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br><span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span>,<br><span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>,<br>&#125;<br>fmt.Println(a1)<br><br><span class="hljs-comment">//判断key是否存在</span><br>a2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)<br>a2[<span class="hljs-string">&quot;username&quot;</span>] = <span class="hljs-string">&quot;admin&quot;</span><br>a2[<span class="hljs-string">&quot;password&quot;</span>] = <span class="hljs-string">&quot;123456&quot;</span><br>v, ok := a2[<span class="hljs-string">&quot;password&quot;</span>]<br><span class="hljs-keyword">if</span> ok &#123;<br>fmt.Println(v)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;error&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// map 遍历</span><br><span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> a2 &#123;<br>fmt.Println(k, v)<br>&#125;<br><span class="hljs-comment">//遍历key</span><br><span class="hljs-keyword">for</span> k := <span class="hljs-keyword">range</span> a2 &#123;<br>fmt.Println(k)<br>&#125;<br><span class="hljs-comment">//遍历values</span><br><span class="hljs-keyword">for</span> _, v = <span class="hljs-keyword">range</span> a2 &#123;<br>fmt.Println(v)<br>&#125;<br><br><span class="hljs-comment">//delete 删除</span><br><span class="hljs-built_in">delete</span>(a2, <span class="hljs-string">&quot;password&quot;</span>)<br>fmt.Println(a2)<br><br><span class="hljs-comment">//元素类型为map的切片</span><br><span class="hljs-keyword">var</span> a8 = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>)<br><span class="hljs-comment">//没有对内部的map做初始化</span><br>a8[<span class="hljs-number">0</span>] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, <span class="hljs-number">1</span>)<br>a8[<span class="hljs-number">0</span>][<span class="hljs-string">&quot;username&quot;</span>] = <span class="hljs-string">&quot;admin&quot;</span><br>fmt.Println(a8)<br><br><span class="hljs-comment">// 值为切片类型的map</span><br><span class="hljs-keyword">var</span> a9 = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]<span class="hljs-type">int</span>,<span class="hljs-number">10</span>)<br>a9[<span class="hljs-string">&quot;username&quot;</span>] = []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;<br>fmt.Println(a9)<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="func-函数"><a href="#func-函数" class="headerlink" title="func(函数)"></a>func(函数)</h2><p>函数是组织好的、可重复使用的、用于执行指定任务的代码块。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// 函数</span><br><br><span class="hljs-comment">// 函数是一段代码的封装</span><br><br><span class="hljs-comment">// 函数定义</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sum</span><span class="hljs-params">(x <span class="hljs-type">int</span>, y <span class="hljs-type">int</span>)</span></span> (ret <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">return</span> x + y<br>&#125;<br><br><span class="hljs-comment">// 没有返回值</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f1</span><span class="hljs-params">(x <span class="hljs-type">int</span>, y <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(x + y)<br>&#125;<br><br><span class="hljs-comment">// 没有参数没有返回值</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;f2&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// 没有参数但有返回值</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f3</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">3</span><br>&#125;<br><br><span class="hljs-comment">// 返回值可以命名也可以不命名</span><br><span class="hljs-comment">// 命名的返回值相当于在函数中声明一个变量</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f4</span><span class="hljs-params">(x <span class="hljs-type">int</span>, y <span class="hljs-type">int</span>)</span></span> (ret <span class="hljs-type">int</span>) &#123;<br>ret = x + y<br><span class="hljs-keyword">return</span> <span class="hljs-comment">//命名返回值可以return后省略</span><br>&#125;<br><br><span class="hljs-comment">// 多值返回</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f5</span><span class="hljs-params">()</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-string">&quot;哈哈&quot;</span><br>&#125;<br><br><span class="hljs-comment">// 参数的类型简写：当参数中连续的两个参数的类型一致时，我们可以将前面参数的类型简写</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f6</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> x + y<br>&#125;<br><br><span class="hljs-comment">// 可变长参数</span><br><span class="hljs-comment">// 可变长参数必须放在函数参数的最后</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f7</span><span class="hljs-params">(x <span class="hljs-type">string</span>, y ...<span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(x)<br>fmt.Println(y)<br>&#125;<br><br><span class="hljs-comment">// 匿名函数</span><br><span class="hljs-keyword">var</span> f8 = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(x + y)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// a := sum(1, 2)</span><br><span class="hljs-comment">// fmt.Println(a)</span><br><br><span class="hljs-comment">// _, a1 := f5()</span><br><span class="hljs-comment">// fmt.Println(a1)</span><br><br>f8(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)<br><span class="hljs-comment">// 函数内部无法定义一个带名字的函数</span><br><span class="hljs-comment">// func f9()  &#123;</span><br><span class="hljs-comment">// &#125;</span><br>f9 := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(x + y)<br>&#125;<br>f9(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>)<br><br><span class="hljs-comment">// 如果只调用一次的函数，还可以简写成立即执行函数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(x + y)<br>&#125;(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="defer语句"><a href="#defer语句" class="headerlink" title="defer语句"></a>defer语句</h2><p>Go语言中的defer语句会将其后面跟随的语句进行延迟处理。在defer归属的函数即将返回时，将延迟处理的语句按defer定义的逆序进行执行，也就是说，先被defer的语句最后被执行，最后被defer的语句，最先被执行。</p><p>函数中return语句在底层并不是原子操作，它分为给返回值赋值和RET指令两步。而defer语句执行的时机就在返回值赋值操作后，RET指令执行前。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// defer</span><br><br><span class="hljs-comment">// defer多用于函数结束之前释放资源(文件句柄，数据库连接)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deferDemo</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;start&quot;</span>)<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;哈哈---1&quot;</span>) <span class="hljs-comment">// defer把它后面的语句延迟到函数即将返回时候在执行</span><br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;哈哈--2&quot;</span>)  <span class="hljs-comment">// 一个函数中可以有多个defer语句</span><br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;哈哈-3&quot;</span>)   <span class="hljs-comment">//多个defer语句按照先进后出的顺序延迟执行</span><br>fmt.Println(<span class="hljs-string">&quot;end&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>x := <span class="hljs-number">5</span><br>fmt.Println(&amp;x)<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>x++ <span class="hljs-comment">// 修改的不是x的返回值</span><br>fmt.Println(x)<br>fmt.Println(&amp;x)<br>&#125;()<br>fmt.Printf(<span class="hljs-string">&quot;------%d\n&quot;</span>, x)<br><span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-comment">// 函数中return语句在底层并不是原子操作，它分为给返回值 赋值和RET指令两步。而defer语句执行的时机就在返回值赋值操作后，RET指令执行前</span><br><br><span class="hljs-comment">// 返回值开辟了一块新的内存空间0xc0000140d0，未命名。赋值为5</span><br><span class="hljs-comment">// 运行defer x++ x=6 ,x跟返回值已经没有关系了</span><br><span class="hljs-comment">// ruturn 是指向0xc0000140d0 这片区域的值</span><br><br><span class="hljs-comment">// 返回值开辟了一块新的内存空间0x----，赋值为x=5</span><br><span class="hljs-comment">// 运行defer x=6 。同时修改了指向0x----的值</span><br><span class="hljs-comment">// return 指向0x-----区域的值</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span></span> (x <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>x++<br>&#125;()<br><span class="hljs-keyword">return</span> <span class="hljs-number">5</span> <span class="hljs-comment">// 返回值=x</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f3</span><span class="hljs-params">()</span></span> (y <span class="hljs-type">int</span>) &#123;<br>x := <span class="hljs-number">5</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>x++<br>&#125;()<br><span class="hljs-keyword">return</span> x <span class="hljs-comment">// 返回值 = y = x =5</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f4</span><span class="hljs-params">()</span></span> (x <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> &#123;<br>x++ <span class="hljs-comment">//改变的是函数中的副本</span><br>&#125;(x) <span class="hljs-comment">//x当参数传递</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">5</span> <span class="hljs-comment">// 返回值 = x = 5</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// deferDemo()</span><br>fmt.Println(f1())<br>fmt.Println(f2())<br><span class="hljs-comment">// fmt.Println(f3())</span><br><span class="hljs-comment">// fmt.Println(f4())</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// 递归：函数自己调用自己</span><br><br><span class="hljs-comment">// 递归适合处理那种问题相同，规模越来越小的场景</span><br><span class="hljs-comment">// 递归一定要有一个明确的退出条件</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">demo</span><span class="hljs-params">(n <span class="hljs-type">uint64</span>)</span></span> <span class="hljs-type">uint64</span> &#123;<br><span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-keyword">return</span> n * demo(n<span class="hljs-number">-1</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := demo(<span class="hljs-number">5</span>)<br>fmt.Println(a)<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>GO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go learn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
